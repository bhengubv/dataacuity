const API_BASE="/api",state={map:null,userLocation:null,userMarker:null,selectedDestination:null,savedPlaces:JSON.parse(localStorage.getItem("savedPlaces")||"{}"),recentSearches:JSON.parse(localStorage.getItem("recentSearches")||"[]"),searchResults:[],filteredRecents:[],markers:[],routeLayer:null,settings:{useMetric:"false"!==localStorage.getItem("useMetric"),use24Hour:"false"!==localStorage.getItem("use24Hour"),avoidTolls:"true"===localStorage.getItem("avoidTolls"),avoidHighways:"true"===localStorage.getItem("avoidHighways"),avoidFerries:"true"===localStorage.getItem("avoidFerries"),avoidUnpaved:"true"===localStorage.getItem("avoidUnpaved"),darkMode:"true"===localStorage.getItem("darkMode"),show3DBuildings:"true"===localStorage.getItem("show3DBuildings"),showTraffic:"true"===localStorage.getItem("showTraffic"),showSpeedLimit:"false"!==localStorage.getItem("showSpeedLimit"),voiceGuidance:"false"!==localStorage.getItem("voiceGuidance"),alertSounds:"false"!==localStorage.getItem("alertSounds"),batterySaver:"true"===localStorage.getItem("batterySaver")},useMetric:"false"!==localStorage.getItem("useMetric")};let navigationWatchId=null,isNavigating=!1,lastAnnouncedStep=-1,currentRouteSteps=[],currentStepIndex=0,currentRouteGeometry=null,isRerouting=!1,offRouteCount=0,currentRouteDurationSec=0,currentRouteDistanceM=0,currentSpeedLimit=60,lastSpeedWarningTime=0;const OFF_ROUTE_THRESHOLD=.05,OFF_ROUTE_CONFIRM_COUNT=3,SPEED_WARNING_INTERVAL=3e4;let incidents=JSON.parse(localStorage.getItem("incidents")||"[]"),incidentMarkers=[],selectedIncidentType=null,alertedIncidentIds=new Set;const INCIDENT_EXPIRY_HOURS=4,INCIDENT_ALERT_DISTANCE=.5,CAMERA_ALERT_DISTANCE=.8,CAMERA_TYPES=["speed_camera","red_light"];function calculateDistance(e,t,n,o){const a=(n-e)*Math.PI/180,i=(o-t)*Math.PI/180,s=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function formatDistance(e){if(state.useMetric)return e<1?Math.round(1e3*e)+" m":e.toFixed(1)+" km";{const t=.621371*e;return t<.1?Math.round(5280*t)+" ft":t.toFixed(1)+" mi"}}const MAP_CONFIG={defaultCenter:[28.0473,-26.2041],defaultZoom:12,minZoom:3,maxZoom:18,style:"https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json"},MAP_STYLES={light:"https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",dark:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json"},DARK_MODE_AUTO_START=18,DARK_MODE_AUTO_END=6;function initApp(){if("undefined"!=typeof maplibregl){if(!isWebGLSupported())return showError("Your browser does not support WebGL maps"),void hideLoading();initMap(),initSearch(),initEventListeners(),loadSavedPlaces(),initURLState(),state.map.on("load",()=>{const e=parseURLState();navigator.geolocation&&navigator.geolocation.getCurrentPosition(t=>{const{latitude:n,longitude:o}=t.coords;state.userLocation=[o,n],console.log("[Init] Got user location for distances:",state.userLocation),updateUserMarker(),e||(state.map.flyTo({center:state.userLocation,zoom:15,duration:1500}),showToast("Location found"))},t=>{console.log("[Init] Location not available:",t.message),e||showToast("Tap GPS button to find your location")},{enableHighAccuracy:!1,timeout:1e4,maximumAge:3e5})})}else setTimeout(initApp,100)}function isWebGLSupported(){try{const e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}function initMap(){try{state.map=new maplibregl.Map({container:"map",style:MAP_CONFIG.style,center:MAP_CONFIG.defaultCenter,zoom:MAP_CONFIG.defaultZoom,minZoom:MAP_CONFIG.minZoom,maxZoom:MAP_CONFIG.maxZoom,attributionControl:!1}),state.map.addControl(new maplibregl.NavigationControl({showCompass:!1}),"top-right"),state.map.on("load",()=>{hideLoading(),loadIncidentsOnMap(),initTrafficUI(),state.settings.showTraffic&&(loadTrafficLayer(),startTrafficRefresh()),initDarkMode(),startDarkModeAutoSwitch()}),state.map.on("error",e=>{console.error("[Map Error]",e)}),state.map.on("click",e=>{state.selectedDestination||closeNavPanel()})}catch(e){console.error("[initMap]",e),showError("Failed to load map"),hideLoading()}}function hideLoading(){const e=document.getElementById("loading-overlay");e&&(e.classList.add("fade-out"),setTimeout(()=>e.remove(),500))}function locateMe(e=!1){if(!navigator.geolocation)return void(e||showToast("Geolocation not supported"));const t=document.getElementById("fab-locate");t&&t.classList.add("locating"),e||showToast("Finding your location..."),navigator.geolocation.getCurrentPosition(e=>{const{latitude:n,longitude:o,accuracy:a}=e.coords;console.log("[Location] Got position:",n,o,"accuracy:",a),state.userLocation=[o,n],state.map.flyTo({center:state.userLocation,zoom:15,duration:1500}),updateUserMarker(),t&&t.classList.remove("locating"),showToast("Location found")},n=>{if(console.error("[Location Error]",n.code,n.message),t&&t.classList.remove("locating"),!e)switch(n.code){case 1:showToast("Please allow location access in browser settings");break;case 2:showToast("Location unavailable - check GPS/WiFi");break;case 3:return showToast("Location timeout - trying again..."),void retryLocationLowAccuracy(e);default:showToast("Could not get location")}},{enableHighAccuracy:!0,timeout:15e3,maximumAge:3e4})}function retryLocationLowAccuracy(e){navigator.geolocation.getCurrentPosition(e=>{const{latitude:t,longitude:n}=e.coords;state.userLocation=[n,t],state.map.flyTo({center:state.userLocation,zoom:15,duration:1500}),updateUserMarker(),document.getElementById("fab-locate")?.classList.remove("locating"),showToast("Location found")},t=>{console.error("[Location Retry Error]",t.code,t.message),document.getElementById("fab-locate")?.classList.remove("locating"),e||showToast("Could not get location - check permissions")},{enableHighAccuracy:!1,timeout:2e4,maximumAge:6e4})}function updateUserMarker(){if(!state.userLocation)return;state.userMarker&&state.userMarker.remove();const e=document.createElement("div");e.style.cssText="\n        position: relative;\n        width: 20px;\n        height: 20px;\n    ";const t=document.createElement("div");t.style.cssText="\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        width: 60px;\n        height: 60px;\n        margin: -30px 0 0 -30px;\n        background: rgba(33, 150, 243, 0.25);\n        border-radius: 50%;\n        animation: userPulse 2s ease-out infinite;\n    ";const n=document.createElement("div");if(n.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 20px;\n        height: 20px;\n        background: #2196F3;\n        border: 3px solid white;\n        border-radius: 50%;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n    ",e.appendChild(t),e.appendChild(n),!document.getElementById("user-marker-style")){const e=document.createElement("style");e.id="user-marker-style",e.textContent="\n            @keyframes userPulse {\n                0% { transform: scale(0.5); opacity: 1; }\n                100% { transform: scale(1.5); opacity: 0; }\n            }\n        ",document.head.appendChild(e)}state.userMarker=new maplibregl.Marker({element:e,anchor:"center"}).setLngLat(state.userLocation).addTo(state.map)}function initSearch(){const e=document.getElementById("search-input");if(!e)return void console.error("[initSearch] search-input not found");const t=document.getElementById("search-clear"),n=document.querySelector(".search-body");let o;e.oninput=function(){const e=this.value.trim();if(console.log("[Search] Input:",e,"Recents:",state.recentSearches.length),t&&t.classList.toggle("visible",e.length>0),0===e.length)return originalSearchBodyContent&&n&&(n.innerHTML=originalSearchBodyContent),void showRecentSearches();clearTimeout(o),o=setTimeout(()=>{e.length>=2&&performSearch(e,!1)},500)},e.onkeydown=function(e){if("Enter"===e.key){e.preventDefault();const t=this.value.trim();t.length>=2&&performSearch(t,!0)}},e.onfocus=function(){0===this.value.trim().length&&showRecentSearches()},console.log("[initSearch] Initialized, recents:",state.recentSearches.length)}function showRecentSearches(){const e=document.getElementById("recent-section"),t=document.getElementById("recent-searches");0!==state.recentSearches.length?(e.style.display="block",t.innerHTML=state.recentSearches.slice(0,5).map((e,t)=>`\n        <div class="search-result" onclick="selectRecentSearch(${t})">\n            <div class="result-icon">üïê</div>\n            <div class="result-info">\n                <div class="result-name">${escapeHtml(e.name.split(",")[0])}</div>\n                <div class="result-address">${escapeHtml(e.name.split(",").slice(1,2).join(""))}</div>\n            </div>\n        </div>\n    `).join("")):e.style.display="none"}function selectRecentSearch(e){const t=state.recentSearches[e];t&&selectPlace(t.lng,t.lat,t.name)}function showFilteredRecents(e){}function selectFilteredRecent(e){const t=state.filteredRecents[e];t&&selectPlace(t.lng,t.lat,t.name)}async function performSearch(e,t=!1){const n=document.querySelector(".search-body");console.log("[performSearch] Starting search for:",e),n.innerHTML=`\n        <div style="padding:40px 20px;text-align:center;">\n            <div style="display:inline-block;width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#2196F3;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px;"></div>\n            <div style="color:#666;font-size:16px;">Searching for "${escapeHtml(e)}"...</div>\n        </div>\n    `;try{const o=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(e)}&format=json&limit=10&addressdetails=1&countrycodes=za`),a=await o.json();if(console.log("[performSearch] Got results:",a.length),t&&a.length>0){const e=a[0];return void selectPlace(parseFloat(e.lon),parseFloat(e.lat),e.display_name)}state.searchResults=a;let i="";a.length>0?(console.log("[performSearch] userLocation:",state.userLocation),i=`<div style="padding:12px 0 8px;color:#666;font-size:13px;text-transform:uppercase;font-weight:600;">Results for "${escapeHtml(e)}"</div>`,i+=a.map((e,t)=>{const n=parseFloat(e.lat),o=parseFloat(e.lon);let a="";if(state.userLocation){const t=calculateDistance(state.userLocation[1],state.userLocation[0],n,o);a=formatDistance(t),console.log("[Distance]",e.display_name.split(",")[0],":",t.toFixed(2),"km ->",a)}return`\n                <div class="search-result" onclick="selectSearchResult(${t})" style="display:flex;align-items:center;padding:16px 8px;border-bottom:1px solid #f0f0f0;cursor:pointer;">\n                    <div style="width:44px;height:44px;border-radius:50%;background:#e3f2fd;display:flex;align-items:center;justify-content:center;font-size:20px;margin-right:14px;">üìç</div>\n                    <div style="flex:1;min-width:0;">\n                        <div style="font-size:16px;font-weight:500;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(e.display_name.split(",")[0])}</div>\n                        <div style="font-size:14px;color:#666;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(e.display_name.split(",").slice(1,3).join(","))}</div>\n                    </div>\n                    <div style="margin-left:12px;text-align:right;flex-shrink:0;min-width:60px;">\n                        <div style="font-size:15px;font-weight:600;color:#1976D2;">${a||"‚Äî"}</div>\n                    </div>\n                </div>\n            `}).join("")):i=`<div style="padding:40px 20px;text-align:center;color:#999;">\n                <div style="font-size:48px;margin-bottom:16px;">üîç</div>\n                <div style="font-size:16px;">No results found for "${escapeHtml(e)}"</div>\n            </div>`,n.innerHTML=i,console.log("[performSearch] Results rendered, innerHTML length:",i.length)}catch(e){console.error("[Search Error]",e),n.innerHTML='<div style="padding:40px 20px;text-align:center;color:#999;">\n            <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>\n            <div style="font-size:16px;">Search failed. Please try again.</div>\n        </div>'}}function selectSearchResult(e){const t=state.searchResults[e];t&&selectPlace(parseFloat(t.lon),parseFloat(t.lat),t.display_name)}function selectPlace(e,t,n){closeSearch(),addToRecent({lng:e,lat:t,name:n}),state.selectedDestination={lng:e,lat:t,name:n},state.map.flyTo({center:[e,t],zoom:16,duration:1e3}),clearMarkers();const o=new maplibregl.Marker({color:"#2196F3"}).setLngLat([e,t]).addTo(state.map);state.markers.push(o),showNavPanel(n,`${t.toFixed(4)}, ${e.toFixed(4)}`)}function addToRecent(e){const t=state.recentSearches.filter(t=>!(t.lng===e.lng&&t.lat===e.lat));t.unshift(e),state.recentSearches=t.slice(0,10),localStorage.setItem("recentSearches",JSON.stringify(state.recentSearches))}function clearMarkers(){state.markers.forEach(e=>e.remove()),state.markers=[]}window.locateMe=locateMe,window.selectRecentSearch=selectRecentSearch,window.selectFilteredRecent=selectFilteredRecent,window.selectSearchResult=selectSearchResult,window.selectPlace=selectPlace;let originalSearchBodyContent=null;function openSearch(){const e=document.getElementById("search-backdrop"),t=document.getElementById("search-overlay"),n=document.getElementById("search-input"),o=document.querySelector(".search-body");!originalSearchBodyContent&&o&&(originalSearchBodyContent=o.innerHTML),e.classList.add("active"),t.classList.add("active"),toggleMenu(!1),originalSearchBodyContent&&o&&(o.innerHTML=originalSearchBodyContent),showRecentSearches(),!state.userLocation&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const{longitude:t,latitude:n}=e.coords;state.userLocation=[t,n],console.log("[openSearch] Got user location:",state.userLocation)},e=>{console.log("[openSearch] Location not available:",e.message)},{enableHighAccuracy:!1,timeout:5e3,maximumAge:3e5}),setTimeout(()=>n.focus(),300)}function closeSearch(){const e=document.getElementById("search-backdrop"),t=document.getElementById("search-overlay"),n=document.getElementById("search-input"),o=document.querySelector(".search-body"),a=document.getElementById("search-clear");e.classList.remove("active"),t.classList.remove("active"),n.value="",n.blur(),a.classList.remove("visible"),originalSearchBodyContent&&o&&(o.innerHTML=originalSearchBodyContent)}function clearSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-results"),n=document.getElementById("search-default"),o=document.getElementById("search-clear");e.value="",e.focus(),t.classList.remove("active"),n.style.display="block",o.classList.remove("visible")}function showNavPanel(e,t){const n=document.getElementById("nav-panel"),o=document.getElementById("bottom-bar");document.getElementById("nav-name").textContent=e,document.getElementById("nav-address").textContent=t,n.classList.add("active"),o.style.display="none"}function closeNavPanel(){isNavigating&&stopLiveNavigation();const e=document.getElementById("nav-panel"),t=document.getElementById("bottom-bar"),n=document.getElementById("directions-list"),o=document.getElementById("nav-actions-initial"),a=document.getElementById("nav-actions-route");e.classList.remove("active"),t.style.display="block",n&&n.classList.remove("active"),o&&(o.style.display="flex"),a&&(a.style.display="none");const i=document.querySelector("#nav-actions-route .nav-action-btn.primary");i&&(i.innerHTML="üöó Start",i.onclick=startLiveNavigation),currentRouteGeometry=null,offRouteCount=0,state.selectedDestination=null,clearMarkers(),clearRoute()}function startNavigation(){if(state.selectedDestination)return state.userLocation?void getDirections(state.userLocation,[state.selectedDestination.lng,state.selectedDestination.lat]):(showToast("Getting your location..."),void locateMe())}function speak(e){if(!state.settings.voiceGuidance)return;if(!("speechSynthesis"in window))return void console.log("[Voice] Speech synthesis not supported");window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.rate=.9,t.pitch=1,t.volume=1;const n=window.speechSynthesis.getVoices(),o=n.find(e=>e.lang.startsWith("en")&&e.name.includes("Google"))||n.find(e=>e.lang.startsWith("en"));o&&(t.voice=o),window.speechSynthesis.speak(t),console.log("[Voice] Speaking:",e)}function formatManeuver(e){const t=e.maneuver||"",n=e.name||"the road";return{depart:`Head towards ${n}`,turn:`Turn onto ${n}`,"turn-left":`Turn left onto ${n}`,"turn-right":`Turn right onto ${n}`,"sharp-left":`Sharp left onto ${n}`,"sharp-right":`Sharp right onto ${n}`,"slight-left":`Slight left onto ${n}`,"slight-right":`Slight right onto ${n}`,straight:`Continue straight on ${n}`,ramp:`Take the ramp onto ${n}`,merge:`Merge onto ${n}`,fork:`Take the fork onto ${n}`,roundabout:`Enter the roundabout and exit onto ${n}`,rotary:`Enter the roundabout and exit onto ${n}`,arrive:"You have arrived at your destination","new name":`Continue on ${n}`}[t]||`Continue on ${n}`}function announceRoute(e,t,n){currentRouteSteps=n||[],currentStepIndex=0;speak(`Route found. ${e}, ${t}`),currentRouteSteps.length>0&&setTimeout(()=>{speak(formatManeuver(currentRouteSteps[0]))},3e3)}function announceNextStep(){if(currentStepIndex<currentRouteSteps.length){speak(formatManeuver(currentRouteSteps[currentStepIndex])),currentStepIndex++}}function displayDirectionsList(e,t,n){const o=document.getElementById("directions-list"),a=document.getElementById("directions-steps"),i=document.getElementById("directions-time"),s=document.getElementById("directions-distance"),r=document.getElementById("nav-actions-initial"),c=document.getElementById("nav-actions-route");if(!o||!a)return;i&&(i.textContent=t),s&&(s.textContent=e);let l="";n&&n.length>0&&n.forEach((e,t)=>{const n=e.maneuver||"continue",o=e.name||"",a=formatManeuver(e),i=e.distance_text||(e.distance?(e.distance/1e3).toFixed(1)+" km":""),s=getManeuverIcon(n);l+=`\n                <div class="directions-step">\n                    <div class="directions-step-icon ${"depart"===n?"depart":"arrive"===n?"arrive":"turn"}">${s}</div>\n                    <div class="directions-step-content">\n                        <div class="directions-step-instruction">${escapeHtml(a)}</div>\n                        ${o?`<div class="directions-step-detail">${escapeHtml(o)}</div>`:""}\n                    </div>\n                    ${i?`<div class="directions-step-distance">${i}</div>`:""}\n                </div>\n            `}),a.innerHTML=l,o.classList.add("active"),r&&(r.style.display="none"),c&&(c.style.display="flex")}function getManeuverIcon(e){return{depart:"üöÄ",arrive:"üèÅ",turn:"‚Ü™Ô∏è","turn-left":"‚¨ÖÔ∏è","turn-right":"‚û°Ô∏è","sharp-left":"‚Ü©Ô∏è","sharp-right":"‚Ü™Ô∏è","slight-left":"‚ÜñÔ∏è","slight-right":"‚ÜóÔ∏è",straight:"‚¨ÜÔ∏è",ramp:"üõ£Ô∏è",merge:"üîÄ",fork:"üî±",roundabout:"üîÑ",rotary:"üîÑ","new name":"‚û°Ô∏è"}[e]||"‚û°Ô∏è"}function startLiveNavigation(){if(!navigator.geolocation)return void showToast("GPS not available");if(!currentRouteSteps||0===currentRouteSteps.length)return void showToast("No route loaded");isNavigating=!0,lastAnnouncedStep=-1,currentStepIndex=0,alertedIncidentIds.clear(),updateShareFAB(!0);const e=document.querySelector("#nav-actions-route .nav-action-btn.primary");if(e&&(e.innerHTML="‚èπÔ∏è Stop",e.onclick=stopLiveNavigation),showToast("Navigation started"),speak("Starting navigation"),highlightCurrentStep(0),currentRouteDurationSec>0&&updateETADisplay(currentRouteDurationSec,currentRouteDistanceM),navigationWatchId=navigator.geolocation.watchPosition(e=>{const{latitude:t,longitude:n,heading:o,speed:a}=e.coords;if(state.userLocation=[n,t],updateUserMarker(),isNavigating&&state.map.easeTo({center:state.userLocation,zoom:17,bearing:o||0,pitch:60,duration:500}),checkNavigationProgress(t,n),checkOffRoute(t,n),checkIncidentProximity(t,n),updateLaneGuidance(t,n),null!==a&&a>0){updateSpeedDisplay(Math.round(3.6*a))}},e=>{console.error("[Navigation GPS Error]",e),showToast("GPS error: "+e.message)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3}),currentRouteSteps.length>0){const e=formatManeuver(currentRouteSteps[0]);setTimeout(()=>speak(e),1500),lastAnnouncedStep=0}}function stopLiveNavigation(){isNavigating=!1,null!==navigationWatchId&&(navigator.geolocation.clearWatch(navigationWatchId),navigationWatchId=null);const e=document.querySelector("#nav-actions-route .nav-action-btn.primary");e&&(e.innerHTML="üöó Start",e.onclick=startLiveNavigation),state.map.easeTo({pitch:0,bearing:0,duration:500}),removeSpeedDisplay(),removeETADisplay(),hideLaneGuidance(),updateShareFAB(!1),stopTripSharing(),document.querySelectorAll(".directions-step").forEach(e=>{e.classList.remove("current-step")}),showToast("Navigation stopped"),speak("Navigation ended")}function checkOffRoute(e,t){if(!isNavigating||isRerouting||!currentRouteGeometry)return;const n=distanceToRoute(e,t,currentRouteGeometry.coordinates);console.log("[Navigation] Distance to route:",(1e3*n).toFixed(0),"m"),n>.05?(offRouteCount++,console.log("[Navigation] Off route count:",offRouteCount),offRouteCount>=3&&triggerReroute(e,t)):offRouteCount=0}function distanceToRoute(e,t,n){if(!n||n.length<2)return 1/0;let o=1/0;for(let a=0;a<n.length-1;a++){const i=n[a],s=n[a+1],r=distanceToSegment(e,t,i[1],i[0],s[1],s[0]);if(r<o&&(o=r),o<.01)break}return o}function distanceToSegment(e,t,n,o,a,i){const s=a-n,r=i-o,c=s*s+r*r;let l,d,u=-1;return 0!==c&&(u=((e-n)*s+(t-o)*r)/c),u<0?(l=n,d=o):u>1?(l=a,d=i):(l=n+u*s,d=o+u*r),calculateDistance(e,t,l,d)}async function triggerReroute(e,t){if(!isRerouting&&state.selectedDestination){isRerouting=!0,offRouteCount=0,console.log("[Navigation] Rerouting from:",e,t),showToast("Rerouting..."),speak("Rerouting");try{const n=await fetch(`/api/route/simple?origin=${t},${e}&destination=${state.selectedDestination.lng},${state.selectedDestination.lat}`);if(!n.ok)throw new Error("Reroute request failed");const o=await n.json();if(!o.geometry)throw new Error("No route found");displayRoute(o.geometry),currentRouteGeometry=o.geometry,currentRouteDurationSec=o.duration_s||0,currentRouteDistanceM=o.distance_m||0;const a=o.distance_text||(o.distance_m/1e3).toFixed(1)+" km",i=o.duration_text||Math.round(o.duration_s/60)+" min";displayDirectionsList(a,i,o.steps),currentRouteSteps=o.steps||[],currentStepIndex=0,lastAnnouncedStep=-1,highlightCurrentStep(0),updateETADisplay(currentRouteDurationSec,currentRouteDistanceM),speak("Route updated. "+i+" remaining"),currentRouteSteps.length>0&&setTimeout(()=>{speak(formatManeuver(currentRouteSteps[0])),lastAnnouncedStep=0},2e3),showToast("Route updated")}catch(e){console.error("[Reroute Error]",e),showToast("Could not reroute"),speak("Unable to find new route")}finally{isRerouting=!1}}}function checkNavigationProgress(e,t){if(!currentRouteSteps||0===currentRouteSteps.length)return;let n=currentStepIndex,o=1/0;for(let a=currentStepIndex;a<currentRouteSteps.length;a++){const i=currentRouteSteps[a];if(i.location){const s=calculateDistance(e,t,i.location[1],i.location[0]);s<o&&(o=s,n=a)}}if(o<.05&&n>currentStepIndex&&(currentStepIndex=n,highlightCurrentStep(currentStepIndex),currentStepIndex<currentRouteSteps.length)){const e=currentRouteSteps[currentStepIndex];updateSpeedLimitFromStep(e),currentStepIndex!==lastAnnouncedStep&&(speak(formatManeuver(e)),lastAnnouncedStep=currentStepIndex)}const a=currentStepIndex+1;if(a<currentRouteSteps.length&&a!==lastAnnouncedStep){const n=currentRouteSteps[a];if(n.location){const o=calculateDistance(e,t,n.location[1],n.location[0]);o<.2&&o>.05&&(speak("In "+Math.round(1e3*o)+" meters, "+formatManeuver(n)),lastAnnouncedStep=a)}}if(currentStepIndex>=currentRouteSteps.length-1){const n=currentRouteSteps[currentRouteSteps.length-1];if("arrive"===n.maneuver||n.location){const o=n.location?n.location[1]:state.selectedDestination?.lat,a=n.location?n.location[0]:state.selectedDestination?.lng;if(o&&a){calculateDistance(e,t,o,a)<.03&&(speak("You have arrived at your destination"),stopLiveNavigation())}}}}function highlightCurrentStep(e){document.querySelectorAll(".directions-step").forEach((t,n)=>{n===e?(t.classList.add("current-step"),t.scrollIntoView({behavior:"smooth",block:"center"})):t.classList.remove("current-step")})}window.openSearch=openSearch,window.closeSearch=closeSearch,window.clearSearch=clearSearch,window.closeNavPanel=closeNavPanel,window.startNavigation=startNavigation,window.announceNextStep=announceNextStep,window.startLiveNavigation=startLiveNavigation,window.stopLiveNavigation=stopLiveNavigation;const LANE_SHOW_DISTANCE=.5,LANE_HIDE_DISTANCE=.03;let currentLaneStep=-1;const LANE_ARROW_SVGS={straight:'<path d="M12 4L12 20M12 4L6 10M12 4L18 10"/>',left:'<path d="M8 12L4 12L4 8M4 12C4 12 4 16 12 20"/>',right:'<path d="M16 12L20 12L20 8M20 12C20 12 20 16 12 20"/>',slight_left:'<path d="M7 8L12 20M7 8L4 12M7 8L11 6"/>',slight_right:'<path d="M17 8L12 20M17 8L20 12M17 8L13 6"/>',sharp_left:'<path d="M4 8L12 20M4 8L4 14M4 8L10 8"/>',sharp_right:'<path d="M20 8L12 20M20 8L20 14M20 8L14 8"/>',uturn:'<path d="M6 16L6 8C6 5 10 4 12 4C14 4 18 5 18 8L18 16M6 16L10 12M6 16L2 12"/>',merge_left:'<path d="M8 4L12 12L12 20M8 4L4 8M8 4L12 8"/>',merge_right:'<path d="M16 4L12 12L12 20M16 4L20 8M16 4L12 8"/>',none:'<circle cx="12" cy="12" r="3"/>'};function showLaneGuidance(e){if(!e.lanes||0===e.lanes.length)return;const t=document.getElementById("lane-guidance"),n=document.getElementById("lane-guidance-arrows"),o=document.getElementById("lane-guidance-hint");if(!t||!n)return;let a="",i=0;e.lanes.length;e.lanes.forEach((e,t)=>{const n=e.valid;n&&i++;const o=mapIndicationToSvg((e.indications||["straight"])[0]||"straight");a+=`\n            <div class="lane-arrow ${n?"valid":""}">\n                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">\n                    ${LANE_ARROW_SVGS[o]||LANE_ARROW_SVGS.straight}\n                </svg>\n                <div class="lane-arrow-divider"></div>\n            </div>\n        `}),n.innerHTML=a,o.textContent=1===i?"Use highlighted lane":i>1?`Use ${i} highlighted lanes`:"Any lane",t.classList.add("show")}function hideLaneGuidance(){const e=document.getElementById("lane-guidance");e&&e.classList.remove("show"),currentLaneStep=-1}function mapIndicationToSvg(e){return{straight:"straight",left:"left",right:"right","slight left":"slight_left","slight right":"slight_right","sharp left":"sharp_left","sharp right":"sharp_right",uturn:"uturn","merge to left":"merge_left","merge to right":"merge_right",none:"none"}[e]||"straight"}function updateLaneGuidance(e,t){if(isNavigating&&currentRouteSteps){for(let n=currentStepIndex;n<Math.min(currentStepIndex+3,currentRouteSteps.length);n++){const o=currentRouteSteps[n];if(!o.lanes||0===o.lanes.length)continue;if(!o.location)continue;const a=calculateDistance(e,t,o.location[1],o.location[0]);if(a<LANE_SHOW_DISTANCE&&a>LANE_HIDE_DISTANCE){if(currentLaneStep!==n&&(currentLaneStep=n,showLaneGuidance(o),state.settings.voiceGuidance)){const e=getLaneVoiceText(o);e&&speak(e)}return}}-1!==currentLaneStep&&hideLaneGuidance()}}function getLaneVoiceText(e){if(!e.lanes||0===e.lanes.length)return null;const t=e.lanes.filter(e=>e.valid),n=e.lanes.length;if(0===t.length)return null;const o=e.lanes.map((e,t)=>e.valid?t:-1).filter(e=>-1!==e),a=o.reduce((e,t)=>e+t,0)/o.length,i=(n-1)/2;let s="";return s=1===o.length?0===o[0]?"leftmost":o[0]===n-1?"rightmost":o[0]<i?"left":o[0]>i?"right":"center":a<i-.5?"left":a>i+.5?"right":"center",1===t.length?`Use the ${s} lane`:t.length===n?"Any lane":`Use the ${s} ${t.length} lanes`}function updateSpeedDisplay(e){let t=document.getElementById("nav-speed-display");t||(t=document.createElement("div"),t.id="nav-speed-display",t.style.cssText="\n            position: fixed;\n            bottom: 200px;\n            left: 16px;\n            background: white;\n            padding: 12px 16px;\n            border-radius: 16px;\n            box-shadow: 0 2px 12px rgba(0,0,0,0.2);\n            z-index: 150;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n        ",document.body.appendChild(t));const n=state.settings.useMetric?e:Math.round(.621371*e),o=state.settings.useMetric?currentSpeedLimit:Math.round(.621371*currentSpeedLimit),a=state.settings.useMetric?"km/h":"mph",i=e>currentSpeedLimit+5,s=i?"#F44336":"#333",r=i?"#FFEBEE":"white";t.style.background=r,t.innerHTML=`\n        <div style="text-align:center;">\n            <div style="font-size:28px;font-weight:700;color:${s};">${n}</div>\n            <div style="font-size:11px;color:#666;">${a}</div>\n        </div>\n        <div style="width:1px;height:40px;background:#ddd;"></div>\n        <div style="text-align:center;">\n            <div style="width:44px;height:44px;border:3px solid #F44336;border-radius:50%;display:flex;align-items:center;justify-content:center;">\n                <span style="font-size:16px;font-weight:700;color:#333;">${o}</span>\n            </div>\n        </div>\n    `,i&&triggerSpeedWarning(e)}function triggerSpeedWarning(e){const t=Date.now();if(t-lastSpeedWarningTime<3e4)return;lastSpeedWarningTime=t;const n=document.getElementById("nav-speed-display");if(n&&(n.style.animation="speedFlash 0.5s ease 3",setTimeout(()=>{n.style.animation=""},1500)),!document.getElementById("speed-warning-style")){const e=document.createElement("style");e.id="speed-warning-style",e.textContent="\n            @keyframes speedFlash {\n                0%, 100% { transform: scale(1); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }\n                50% { transform: scale(1.05); box-shadow: 0 4px 20px rgba(244,67,54,0.4); }\n            }\n        ",document.head.appendChild(e)}state.settings.alertSounds&&speakWarning("Slow down. Speed limit "+currentSpeedLimit+" kilometers per hour.")}function speakWarning(e){if(!("speechSynthesis"in window))return;window.speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.rate=1.1,t.pitch=1.2,t.volume=1,window.speechSynthesis.speak(t)}function estimateSpeedLimit(e){if(!e)return 60;const t=e.toLowerCase();return t.includes("highway")||t.includes("freeway")||t.includes("motorway")||t.includes("n1")||t.includes("n2")||t.includes("n3")||t.includes("n4")||t.includes("n12")||t.includes("n14")||t.includes("m1")||t.includes("r21")||t.includes("r24")?120:t.includes("avenue")||t.includes("drive")||t.includes("road")||t.includes("boulevard")||t.includes("main")||t.includes("r")?80:(t.includes("street")||t.includes("lane")||t.includes("close")||t.includes("crescent"),60)}function updateSpeedLimitFromStep(e){e&&e.name&&(currentSpeedLimit=estimateSpeedLimit(e.name),console.log("[Navigation] Speed limit for",e.name,":",currentSpeedLimit,"km/h"))}function removeSpeedDisplay(){const e=document.getElementById("nav-speed-display");e&&e.remove()}function updateETADisplay(e,t){currentRouteDurationSec=e,currentRouteDistanceM=t;let n=document.getElementById("nav-eta-display");n||(n=document.createElement("div"),n.id="nav-eta-display",n.style.cssText="\n            position: fixed;\n            top: 110px;\n            left: 16px;\n            right: 16px;\n            background: white;\n            padding: 16px 20px;\n            border-radius: 16px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n            z-index: 150;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n        ",document.body.appendChild(n));const o=new Date,a=formatTime(new Date(o.getTime()+1e3*e)),i=Math.round(e/60);let s,r;if(i>=60){s=`${Math.floor(i/60)}h ${i%60}m`}else s=`${i} min`;if(state.settings.useMetric){const e=t/1e3;r=e>=1?`${e.toFixed(1)} km`:`${Math.round(t)} m`}else{const e=t/1609.34;r=e>=.1?`${e.toFixed(1)} mi`:`${Math.round(3.281*t)} ft`}n.innerHTML=`\n        <div style="flex:1;">\n            <div style="font-size:32px;font-weight:700;color:#1976D2;">${a}</div>\n            <div style="font-size:14px;color:#666;margin-top:4px;">Arrival time</div>\n        </div>\n        <div style="text-align:right;">\n            <div style="font-size:18px;font-weight:600;color:#333;">${s}</div>\n            <div style="font-size:14px;color:#666;margin-top:4px;">${r}</div>\n        </div>\n    `}function formatTime(e){const t=e.getHours(),n=e.getMinutes();if(state.settings.use24Hour)return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`;{const e=t>=12?"PM":"AM";return`${t%12||12}:${n.toString().padStart(2,"0")} ${e}`}}function removeETADisplay(){const e=document.getElementById("nav-eta-display");e&&e.remove()}async function getDirections(e,t){showToast("Getting directions...");try{const n=await fetch(`/api/route/alternatives?origin=${e[0]},${e[1]}&destination=${t[0]},${t[1]}&with_traffic=true`);if(!n.ok){const e=await n.text();throw console.error("[Route API Error]",n.status,e),new Error("Route request failed")}const o=await n.json();if(console.log("[Route] Response:",o),!o.routes||0===o.routes.length)return void showToast("No route found");alternateRoutes=o.routes,selectedRouteIndex=0,displayAllRoutes(o.routes,0),o.routes.length>1&&showRouteOptions(o.routes);const a=o.routes[0];currentRouteGeometry=a.geometry,offRouteCount=0,currentRouteDurationSec=a.duration_in_traffic_s||a.duration_s||0,currentRouteDistanceM=a.distance_m||0;const i=a.distance_text,s=a.duration_in_traffic_text||a.duration_text;showToast(`${i} ‚Ä¢ ${s}`),document.getElementById("nav-address").textContent=`${i} ‚Ä¢ ${s}`,displayDirectionsList(i,s,a.steps),currentRouteSteps=a.steps||[],announceRoute(i,s,a.steps)}catch(e){console.error("[Directions Error]",e),showToast("Could not get directions")}}let routeStartMarker=null,routeEndMarker=null,alternateRoutes=[],selectedRouteIndex=0;const ROUTE_COLORS=["#2196F3","#9E9E9E","#757575"];function displayRoute(e){if(clearRoute(),state.map.getSource("route")?state.map.getSource("route").setData({type:"Feature",geometry:e}):(state.map.addSource("route",{type:"geojson",data:{type:"Feature",geometry:e}}),state.map.addLayer({id:"route-line",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#2196F3","line-width":6,"line-opacity":.8}})),e.coordinates&&e.coordinates.length>0){const t=e.coordinates[0],n=e.coordinates[e.coordinates.length-1],o=document.createElement("div");o.innerHTML='\n            <div style="width:32px;height:32px;background:#4CAF50;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);color:white;font-weight:bold;font-size:14px;">A</div>\n        ',routeStartMarker=new maplibregl.Marker({element:o,anchor:"center"}).setLngLat(t).addTo(state.map);const a=document.createElement("div");a.innerHTML='\n            <div style="width:32px;height:32px;background:#F44336;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);color:white;font-weight:bold;font-size:14px;">B</div>\n        ',routeEndMarker=new maplibregl.Marker({element:a,anchor:"center"}).setLngLat(n).addTo(state.map);const i=e.coordinates.reduce((e,t)=>e.extend(t),new maplibregl.LngLatBounds(e.coordinates[0],e.coordinates[0]));state.map.fitBounds(i,{padding:80})}}function clearRoute(){for(let e=0;e<3;e++)state.map.getLayer(`route-line-${e}`)&&state.map.removeLayer(`route-line-${e}`),state.map.getSource(`route-${e}`)&&state.map.removeSource(`route-${e}`);state.map.getLayer("route-line")&&state.map.removeLayer("route-line"),state.map.getSource("route")&&state.map.removeSource("route"),routeStartMarker&&(routeStartMarker.remove(),routeStartMarker=null),routeEndMarker&&(routeEndMarker.remove(),routeEndMarker=null),alternateRoutes=[],selectedRouteIndex=0}function displayAllRoutes(e,t){if(clearRoute(),!e||0===e.length)return;e.map((e,t)=>t).sort((e,n)=>e===t?1:n===t?-1:n-e).forEach(n=>{const o=e[n],a=n===t,i=a?ROUTE_COLORS[0]:ROUTE_COLORS[Math.min(n,2)],s=a?.9:.5,r=a?6:4;state.map.addSource(`route-${n}`,{type:"geojson",data:{type:"Feature",geometry:o.geometry}}),state.map.addLayer({id:`route-line-${n}`,type:"line",source:`route-${n}`,layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":i,"line-width":r,"line-opacity":s}}),a||(state.map.on("click",`route-line-${n}`,()=>{selectRoute(n)}),state.map.on("mouseenter",`route-line-${n}`,()=>{state.map.getCanvas().style.cursor="pointer"}),state.map.on("mouseleave",`route-line-${n}`,()=>{state.map.getCanvas().style.cursor=""}))});const n=e[t];if(n.geometry.coordinates&&n.geometry.coordinates.length>0){const t=n.geometry.coordinates[0],o=n.geometry.coordinates[n.geometry.coordinates.length-1],a=document.createElement("div");a.innerHTML='\n            <div style="width:32px;height:32px;background:#4CAF50;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);color:white;font-weight:bold;font-size:14px;">A</div>\n        ',routeStartMarker=new maplibregl.Marker({element:a,anchor:"center"}).setLngLat(t).addTo(state.map);const i=document.createElement("div");i.innerHTML='\n            <div style="width:32px;height:32px;background:#F44336;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.3);color:white;font-weight:bold;font-size:14px;">B</div>\n        ',routeEndMarker=new maplibregl.Marker({element:i,anchor:"center"}).setLngLat(o).addTo(state.map);const s=e.flatMap(e=>e.geometry.coordinates),r=s.reduce((e,t)=>e.extend(t),new maplibregl.LngLatBounds(s[0],s[0]));state.map.fitBounds(r,{padding:100})}}function showRouteOptions(e){const t=document.getElementById("route-options"),n=document.getElementById("route-options-list");t&&n&&(n.innerHTML=e.map((e,t)=>{const n=0===t?"primary":1===t?"alt1":"alt2",o=e.traffic?.level||"unknown",a="free"===o?"Clear":"moderate"===o?"Moderate":"heavy"===o?"Heavy":"severe"===o?"Severe":"Unknown",i="heavy"===o?"delayed":"severe"===o?"heavy":"";return`\n            <div class="route-option ${t===selectedRouteIndex?"selected":""}" onclick="selectRoute(${t})">\n                <div class="route-option-color ${n}"></div>\n                <div class="route-option-info">\n                    <div class="route-option-label">\n                        ${e.label}\n                        <span class="route-option-traffic ${o}">${a}</span>\n                    </div>\n                    <div class="route-option-time ${i}">${e.duration_in_traffic_text||e.duration_text}</div>\n                    <div class="route-option-details">${e.distance_text} ‚Ä¢ via ${e.summary||"main roads"}</div>\n                </div>\n                <button class="route-option-go" onclick="event.stopPropagation(); selectRouteAndGo(${t})">\n                    ‚ñ∂\n                </button>\n            </div>\n        `}).join(""),t.classList.add("show"))}function closeRouteOptions(){const e=document.getElementById("route-options");e&&e.classList.remove("show")}function selectRoute(e){if(e<0||e>=alternateRoutes.length)return;selectedRouteIndex=e;const t=alternateRoutes[e];displayAllRoutes(alternateRoutes,e);document.querySelectorAll(".route-option").forEach((t,n)=>{t.classList.toggle("selected",n===e)}),currentRouteGeometry=t.geometry,currentRouteDurationSec=t.duration_in_traffic_s||t.duration_s||0,currentRouteDistanceM=t.distance_m||0,currentRouteSteps=t.steps||[],offRouteCount=0;const n=t.distance_text,o=t.duration_in_traffic_text||t.duration_text;document.getElementById("nav-address").textContent=`${n} ‚Ä¢ ${o}`,displayDirectionsList(n,o,t.steps),showToast(`${t.label} selected: ${o}`)}function selectRouteAndGo(e){selectRoute(e),closeRouteOptions(),startLiveNavigation()}async function searchNearby(e){if(closeSearch(),toggleMenu(!1),!state.userLocation)return showToast("Getting your location..."),locateMe(),void setTimeout(()=>searchNearby(e),2e3);showToast(`Finding ${e.replace("_"," ")}...`);try{const[t,n]=state.userLocation,o=await fetch(`/api/nearby?lat=${n}&lng=${t}&category=${e}&radius=5000`);if(!o.ok)throw new Error("Nearby search failed");const a=await o.json();if(!a.results||0===a.results.length)return void showToast("Nothing found nearby");clearMarkers(),a.results.slice(0,20).forEach(e=>{const t=new maplibregl.Marker({color:"#FF5722"}).setLngLat([e.lng,e.lat]).setPopup((new maplibregl.Popup).setHTML(`\n                    <strong>${escapeHtml(e.name)}</strong><br>\n                    <small>${escapeHtml(e.address||"")}</small>\n                `)).addTo(state.map);t.getElement().addEventListener("click",()=>{state.selectedDestination={lng:e.lng,lat:e.lat,name:e.name},showNavPanel(e.name,e.address||"")}),state.markers.push(t)}),showToast(`Found ${a.results.length} places`)}catch(e){console.error("[Nearby Error]",e),showToast("Search failed")}}function loadSavedPlaces(){const e=document.getElementById("home-address"),t=document.getElementById("work-address");state.savedPlaces.home&&(e.textContent=state.savedPlaces.home.name.split(",")[0]),state.savedPlaces.work&&(t.textContent=state.savedPlaces.work.name.split(",")[0])}function goToSaved(e){const t=state.savedPlaces[e];if(!t)return showToast(("home"===e?"Home":"Work")+" not set"),void setSavedPlace(e);closeSearch(),toggleMenu(!1),selectPlace(t.lng,t.lat,t.name)}function setSavedPlace(e){if(toggleMenu(!1),!state.userLocation)return showToast("Getting your location first..."),locateMe(),void setTimeout(()=>setSavedPlace(e),2e3);const[t,n]=state.userLocation;fetch(`/api/reverse-geocode?lat=${n}&lng=${t}`).then(e=>e.json()).then(o=>{const a=o.address||`${n.toFixed(4)}, ${t.toFixed(4)}`;state.savedPlaces[e]={lng:t,lat:n,name:a},localStorage.setItem("savedPlaces",JSON.stringify(state.savedPlaces)),loadSavedPlaces(),showToast(("home"===e?"Home":"Work")+" saved")}).catch(()=>{const o=`${n.toFixed(4)}, ${t.toFixed(4)}`;state.savedPlaces[e]={lng:t,lat:n,name:o},localStorage.setItem("savedPlaces",JSON.stringify(state.savedPlaces)),loadSavedPlaces(),showToast(("home"===e?"Home":"Work")+" saved")})}function toggleMenu(e){const t=document.getElementById("menu-panel"),n=document.getElementById("menu-overlay");void 0===e&&(e=!t.classList.contains("active")),e?(t.classList.add("active"),n.classList.add("active")):(t.classList.remove("active"),n.classList.remove("active"))}function openTimeline(){toggleMenu(!1),showToast("Historical timeline coming soon")}function openTransit(){toggleMenu(!1),showToast("Public transit coming soon")}function openLayers(){toggleMenu(!1),showToast("Map styles coming soon")}function openSettings(){toggleMenu(!1);const e=document.getElementById("settings-backdrop"),t=document.getElementById("settings-panel");e&&t&&(e.classList.add("active"),t.classList.add("active"),loadSettingsUI())}function closeSettings(){const e=document.getElementById("settings-backdrop"),t=document.getElementById("settings-panel");e&&t&&(e.classList.remove("active"),t.classList.remove("active"))}function loadSettingsUI(){const e=document.getElementById("distance-unit-value");e&&(e.textContent=state.settings.useMetric?"Kilometers":"Miles");const t=document.getElementById("time-format-value");t&&(t.textContent=state.settings.use24Hour?"24-hour":"12-hour");const n=document.getElementById("dark-mode-value");n&&(n.textContent=state.settings.darkMode?"On":"Off"),setCheckbox("avoid-tolls",state.settings.avoidTolls),setCheckbox("avoid-highways",state.settings.avoidHighways),setCheckbox("avoid-ferries",state.settings.avoidFerries),setCheckbox("avoid-unpaved",state.settings.avoidUnpaved),setCheckbox("dark-mode",state.settings.darkMode),setCheckbox("show-3d-buildings",state.settings.show3DBuildings),setCheckbox("show-traffic",state.settings.showTraffic),setCheckbox("show-speed-limit",state.settings.showSpeedLimit),setCheckbox("voice-guidance",state.settings.voiceGuidance),setCheckbox("alert-sounds",state.settings.alertSounds),setCheckbox("battery-saver",state.settings.batterySaver)}function setCheckbox(e,t){const n=document.getElementById(e);n&&(n.checked=t)}function saveSetting(e,t){if(state.settings[e]=t,localStorage.setItem(e,t.toString()),"useMetric"===e&&(state.useMetric=t),"darkMode"===e){applyDarkMode(t);const e=document.getElementById("dark-mode-value");e&&(e.textContent=t?"On":"Off")}showToast("Setting saved")}function toggleDistanceUnit(){const e=!state.settings.useMetric;state.settings.useMetric=e,state.useMetric=e,localStorage.setItem("useMetric",e.toString());const t=document.getElementById("distance-unit-value");t&&(t.textContent=e?"Kilometers":"Miles"),showToast(e?"Using kilometers":"Using miles")}function toggleTimeFormat(){const e=!state.settings.use24Hour;state.settings.use24Hour=e,localStorage.setItem("use24Hour",e.toString());const t=document.getElementById("time-format-value");t&&(t.textContent=e?"24-hour":"12-hour"),showToast(e?"Using 24-hour format":"Using 12-hour format")}function toggleDarkMode(e){state.settings.darkMode=e,localStorage.setItem("darkMode",e.toString()),applyDarkMode(e);const t=document.getElementById("dark-mode-value");t&&(t.textContent=e?"On":"Off")}function applyDarkMode(e){if(e?(document.body.classList.add("dark-mode"),document.documentElement.setAttribute("data-theme","dark")):(document.body.classList.remove("dark-mode"),document.documentElement.removeAttribute("data-theme")),state.map){const t=state.map.getCenter(),n=state.map.getZoom(),o=state.map.getBearing(),a=state.map.getPitch(),i=e?MAP_STYLES.dark:MAP_STYLES.light;e!==(state.map.getStyle()?.sprite||"").includes("dark-matter")&&(state.map.setStyle(i),state.map.once("style.load",()=>{state.map.jumpTo({center:t,zoom:n,bearing:o,pitch:a}),currentRouteGeometry&&setTimeout(()=>{displayAllRoutes([{id:"current",geometry:currentRouteGeometry,distance:currentRouteDistanceM,duration:currentRouteDurationSec}],0)},100),loadIncidentsOnMap()}))}}function shouldUseDarkMode(){const e=(new Date).getHours();return e>=18||e<6}function initDarkMode(){const e=localStorage.getItem("darkMode");if(null!==e){const t="true"===e;state.settings.darkMode=t,applyDarkMode(t)}else{const e=shouldUseDarkMode();state.settings.darkMode=e,applyDarkMode(e)}const t=document.getElementById("dark-mode-value"),n=document.getElementById("dark-mode");t&&(t.textContent=state.settings.darkMode?"On":"Off"),n&&(n.checked=state.settings.darkMode)}function startDarkModeAutoSwitch(){setInterval(()=>{if(null===localStorage.getItem("darkMode")){const e=shouldUseDarkMode();if(e!==state.settings.darkMode){state.settings.darkMode=e,applyDarkMode(e);const t=document.getElementById("dark-mode-value"),n=document.getElementById("dark-mode");t&&(t.textContent=e?"On":"Off"),n&&(n.checked=e),showToast(e?"Night mode activated":"Day mode activated")}}},3e5)}function resetDarkModeToAuto(){localStorage.removeItem("darkMode");const e=shouldUseDarkMode();state.settings.darkMode=e,applyDarkMode(e);const t=document.getElementById("dark-mode-value"),n=document.getElementById("dark-mode");t&&(t.textContent="Auto"),n&&(n.checked=e),showToast("Dark mode set to auto")}function clearRecentSearches(){confirm("Clear all recent searches?")&&(state.recentSearches=[],localStorage.setItem("recentSearches","[]"),showToast("Recent searches cleared"),closeSettings())}function clearAllData(){if(confirm("This will reset all settings and saved places. Continue?")){["savedPlaces","recentSearches","useMetric","use24Hour","avoidTolls","avoidHighways","avoidFerries","avoidUnpaved","darkMode","show3DBuildings","showTraffic","showSpeedLimit","voiceGuidance","alertSounds","batterySaver","incidents"].forEach(e=>localStorage.removeItem(e)),showToast("All data cleared. Reloading..."),setTimeout(()=>location.reload(),1e3)}}function startOver(){toggleMenu(!1),showToast("Starting fresh..."),"caches"in window&&caches.keys().then(e=>{e.forEach(e=>caches.delete(e))}),"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>e.unregister())}),localStorage.clear(),sessionStorage.clear(),clearMarkers(),clearRoute(),state.userLocation=null,state.selectedDestination=null,state.userMarker&&(state.userMarker.remove(),state.userMarker=null),setTimeout(()=>{showToast("Requesting location..."),locateMe(!1)},500)}function openAbout(){toggleMenu(!1),showToast("Data Acuity Maps v2.0")}window.showRouteOptions=showRouteOptions,window.closeRouteOptions=closeRouteOptions,window.selectRoute=selectRoute,window.selectRouteAndGo=selectRouteAndGo,window.searchNearby=searchNearby,window.goToSaved=goToSaved,window.setSavedPlace=setSavedPlace,window.toggleMenu=toggleMenu,window.openTimeline=openTimeline,window.openTransit=openTransit,window.openLayers=openLayers,window.openSettings=openSettings,window.closeSettings=closeSettings,window.saveSetting=saveSetting,window.toggleDistanceUnit=toggleDistanceUnit,window.toggleTimeFormat=toggleTimeFormat,window.toggleDarkMode=toggleDarkMode,window.resetDarkModeToAuto=resetDarkModeToAuto,window.clearRecentSearches=clearRecentSearches,window.clearAllData=clearAllData,window.startOver=startOver,window.openAbout=openAbout;const INCIDENT_TYPES={police:{icon:"üöî",label:"Police",color:"#2196F3"},accident:{icon:"üí•",label:"Accident",color:"#f44336"},hazard:{icon:"‚ö†Ô∏è",label:"Hazard",color:"#FF9800"},traffic:{icon:"üöó",label:"Traffic Jam",color:"#9C27B0"},closure:{icon:"üöß",label:"Road Closed",color:"#E91E63"},construction:{icon:"üèóÔ∏è",label:"Construction",color:"#795548"},speed_camera:{icon:"üì∑",label:"Speed Camera",color:"#000000",speedLimit:60},red_light:{icon:"üö¶",label:"Red Light Camera",color:"#D32F2F"}};function openReportPanel(){if(!state.userLocation)return showToast("Enable location to report incidents"),void locateMe();const e=document.getElementById("report-backdrop"),t=document.getElementById("report-panel");e&&t&&(e.classList.add("active"),t.classList.add("active"),selectedIncidentType=null,document.querySelectorAll(".report-type").forEach(e=>{e.classList.remove("selected")}),document.getElementById("report-submit").disabled=!0)}function closeReportPanel(){const e=document.getElementById("report-backdrop"),t=document.getElementById("report-panel");e&&t&&(e.classList.remove("active"),t.classList.remove("active")),selectedIncidentType=null}function selectIncidentType(e){document.querySelectorAll(".report-type").forEach(e=>{e.classList.remove("selected")}),e.classList.add("selected"),selectedIncidentType=e.dataset.type,document.getElementById("report-submit").disabled=!1}function submitIncident(){if(!selectedIncidentType||!state.userLocation)return void showToast("Please select an incident type");const e={id:Date.now().toString(),type:selectedIncidentType,lat:state.userLocation.lat,lng:state.userLocation.lng,timestamp:Date.now(),confirmations:1,dismissals:0};incidents.push(e),cleanupExpiredIncidents(),localStorage.setItem("incidents",JSON.stringify(incidents)),addIncidentMarker(e),closeReportPanel();const t=INCIDENT_TYPES[selectedIncidentType];showToast(`${t.icon} ${t.label} reported!`),state.settings.voiceGuidance&&speak(`${t.label} reported at your location`)}function cleanupExpiredIncidents(){const e=Date.now();incidents=incidents.filter(t=>e-t.timestamp<144e5),localStorage.setItem("incidents",JSON.stringify(incidents))}function addIncidentMarker(e){if(!state.map)return;const t=INCIDENT_TYPES[e.type]||INCIDENT_TYPES.hazard,n=document.createElement("div");n.className=`incident-marker ${e.type}`,n.innerHTML=t.icon,n.dataset.incidentId=e.id;const o=getTimeAgo(e.timestamp),a=`\n        <div class="incident-popup">\n            <div class="incident-popup-title">${t.icon} ${t.label}</div>\n            <div class="incident-popup-time">Reported ${o}</div>\n            <div class="incident-popup-actions">\n                <button class="incident-confirm-btn" onclick="confirmIncident('${e.id}')">\n                    üëç Still there\n                </button>\n                <button class="incident-dismiss-btn" onclick="dismissIncident('${e.id}')">\n                    üëé Gone\n                </button>\n            </div>\n        </div>\n    `,i=new maplibregl.Marker({element:n}).setLngLat([e.lng,e.lat]).setPopup(new maplibregl.Popup({offset:25}).setHTML(a)).addTo(state.map);incidentMarkers.push({id:e.id,marker:i})}function getTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)} min ago`:t<86400?`${Math.floor(t/3600)} hr ago`:`${Math.floor(t/86400)} days ago`}function confirmIncident(e){const t=incidents.find(t=>t.id===e);t&&(t.confirmations++,t.timestamp=Date.now(),localStorage.setItem("incidents",JSON.stringify(incidents)),showToast("Thanks for confirming!"))}function dismissIncident(e){const t=incidents.find(t=>t.id===e);t&&(t.dismissals++,t.dismissals>t.confirmations?(removeIncident(e),showToast("Incident removed")):(localStorage.setItem("incidents",JSON.stringify(incidents)),showToast("Thanks for the feedback!")))}function removeIncident(e){incidents=incidents.filter(t=>t.id!==e),localStorage.setItem("incidents",JSON.stringify(incidents));const t=incidentMarkers.find(t=>t.id===e);t&&(t.marker.remove(),incidentMarkers=incidentMarkers.filter(t=>t.id!==e))}function loadIncidentsOnMap(){state.map&&(cleanupExpiredIncidents(),incidentMarkers.forEach(e=>e.marker.remove()),incidentMarkers=[],incidents.forEach(e=>{addIncidentMarker(e)}))}function checkIncidentProximity(e,t){isNavigating&&incidents.forEach(n=>{if(alertedIncidentIds.has(n.id))return;const o=calculateDistance(e,t,n.lat,n.lng),a=CAMERA_TYPES.includes(n.type);o<(a?.8:.5)&&(alertedIncidentIds.add(n.id),a?showCameraAlert(n,o):showIncidentAlert(n,o))})}function showIncidentAlert(e,t){const n=INCIDENT_TYPES[e.type]||INCIDENT_TYPES.hazard,o=document.getElementById("incident-alert"),a=document.getElementById("incident-alert-icon"),i=document.getElementById("incident-alert-title"),s=document.getElementById("incident-alert-distance");if(o&&a&&i&&s&&(a.textContent=n.icon,i.textContent=`${n.label} reported ahead`,s.textContent=formatDistance(t),o.classList.add("show"),setTimeout(()=>{o.classList.remove("show")},5e3)),state.settings.voiceGuidance){const e=formatDistance(t);speak(`${n.label} reported ${e} ahead`)}state.settings.alertSounds&&playAlertSound()}function closeIncidentAlert(){const e=document.getElementById("incident-alert");e&&e.classList.remove("show")}function showCameraAlert(e,t){const n=INCIDENT_TYPES[e.type]||INCIDENT_TYPES.speed_camera,o="speed_camera"===e.type,a=document.getElementById("camera-alert"),i=document.getElementById("camera-alert-icon"),s=document.getElementById("camera-alert-title"),r=document.getElementById("camera-alert-speed"),c=document.getElementById("camera-alert-distance");if(a&&i&&s&&r&&c&&(i.textContent=n.icon,s.textContent=o?"Speed Camera Ahead":"Red Light Camera Ahead",r.textContent=o?`${n.speedLimit||60} km/h`:"",r.style.display=o?"block":"none",c.textContent=formatDistance(t),a.classList.add("show"),setTimeout(()=>{a.classList.remove("show")},8e3)),state.settings.voiceGuidance){const e=formatDistance(t);speak(o?`Warning! Speed camera ahead in ${e}. Speed limit ${n.speedLimit||60} kilometers per hour.`:`Warning! Red light camera ahead in ${e}.`)}state.settings.alertSounds&&playCameraAlertSound()}function closeCameraAlert(){const e=document.getElementById("camera-alert");e&&e.classList.remove("show")}function playCameraAlertSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=1200,t.type="sine",n.gain.setValueAtTime(.4,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.15),t.start(e.currentTime),t.stop(e.currentTime+.15);const o=e.createOscillator(),a=e.createGain();o.connect(a),a.connect(e.destination),o.frequency.value=1400,o.type="sine",a.gain.setValueAtTime(.4,e.currentTime+.2),a.gain.exponentialRampToValueAtTime(.01,e.currentTime+.35),o.start(e.currentTime+.2),o.stop(e.currentTime+.35)}catch(e){}}function playAlertSound(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=800,t.type="sine",n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}catch(e){}}window.openReportPanel=openReportPanel,window.closeReportPanel=closeReportPanel,window.selectIncidentType=selectIncidentType,window.submitIncident=submitIncident,window.confirmIncident=confirmIncident,window.dismissIncident=dismissIncident,window.closeIncidentAlert=closeIncidentAlert,window.closeCameraAlert=closeCameraAlert;let trafficLayerVisible=!1,trafficRefreshInterval=null;const TRAFFIC_REFRESH_MS=18e4,TRAFFIC_COLORS={free:"#00C853",moderate:"#FFD600",heavy:"#FF6D00",severe:"#D50000",unknown:"#9E9E9E"};async function loadTrafficLayer(){if(!state.map||!state.settings.showTraffic)return;state.map.getCenter();if(state.map.getZoom()<10)showToast("Zoom in to see traffic");else try{const e=state.map.getBounds(),t=`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`,n=await fetch(`/api/traffic/here?bbox=${t}`),o=await n.json();"FeatureCollection"===o.type&&o.features?(displayTrafficLayer(o),trafficLayerVisible=!0):o.error&&(console.warn("[Traffic]",o.message||"Traffic data unavailable"),loadCrowdsourcedTraffic(t))}catch(e){console.error("[Traffic Error]",e);const t=state.map.getBounds();loadCrowdsourcedTraffic(`${t.getWest()},${t.getSouth()},${t.getEast()},${t.getNorth()}`)}}async function loadCrowdsourcedTraffic(e){try{const t=await fetch(`/api/traffic?bbox=${e}`),n=await t.json();"FeatureCollection"===n.type&&n.features&&(displayTrafficLayer(n),trafficLayerVisible=!0)}catch(e){console.error("[Crowdsourced Traffic Error]",e)}}function displayTrafficLayer(e){state.map&&(removeTrafficLayer(),state.map.addSource("traffic-flow",{type:"geojson",data:e}),state.map.addLayer({id:"traffic-flow-layer",type:"line",source:"traffic-flow",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["match",["get","traffic_level"],"free",TRAFFIC_COLORS.free,"moderate",TRAFFIC_COLORS.moderate,"heavy",TRAFFIC_COLORS.heavy,"severe",TRAFFIC_COLORS.severe,"standstill",TRAFFIC_COLORS.severe,TRAFFIC_COLORS.unknown],"line-width":["interpolate",["linear"],["zoom"],10,2,14,4,18,8],"line-opacity":.8}},"road-label"),state.map.addLayer({id:"traffic-flow-arrows",type:"symbol",source:"traffic-flow",layout:{"symbol-placement":"line","symbol-spacing":100,"text-field":"‚ñ∂","text-size":12,"text-rotation-alignment":"map","text-allow-overlap":!0},paint:{"text-color":["match",["get","traffic_level"],"free",TRAFFIC_COLORS.free,"moderate",TRAFFIC_COLORS.moderate,"heavy",TRAFFIC_COLORS.heavy,"severe",TRAFFIC_COLORS.severe,"standstill",TRAFFIC_COLORS.severe,TRAFFIC_COLORS.unknown],"text-opacity":.6}}))}function removeTrafficLayer(){state.map&&(state.map.getLayer("traffic-flow-arrows")&&state.map.removeLayer("traffic-flow-arrows"),state.map.getLayer("traffic-flow-layer")&&state.map.removeLayer("traffic-flow-layer"),state.map.getSource("traffic-flow")&&state.map.removeSource("traffic-flow"),trafficLayerVisible=!1)}function toggleTrafficLayer(e){state.settings.showTraffic=e,localStorage.setItem("showTraffic",e.toString()),e?(loadTrafficLayer(),startTrafficRefresh(),updateTrafficUI(!0),showToast("Traffic layer enabled")):(removeTrafficLayer(),stopTrafficRefresh(),updateTrafficUI(!1),showToast("Traffic layer disabled"))}function startTrafficRefresh(){stopTrafficRefresh(),trafficRefreshInterval=setInterval(()=>{state.settings.showTraffic&&state.map&&loadTrafficLayer()},TRAFFIC_REFRESH_MS),state.map.on("moveend",onMapMoveForTraffic)}function stopTrafficRefresh(){trafficRefreshInterval&&(clearInterval(trafficRefreshInterval),trafficRefreshInterval=null),state.map&&state.map.off("moveend",onMapMoveForTraffic)}window.toggleTrafficLayer=toggleTrafficLayer;let trafficMoveTimeout=null;function onMapMoveForTraffic(){state.settings.showTraffic&&(clearTimeout(trafficMoveTimeout),trafficMoveTimeout=setTimeout(()=>{loadTrafficLayer()},500))}function refreshTraffic(){state.settings.showTraffic&&(showToast("Refreshing traffic..."),loadTrafficLayer())}function quickToggleTraffic(){const e=!state.settings.showTraffic;toggleTrafficLayer(e),updateTrafficUI(e);const t=document.getElementById("show-traffic");t&&(t.checked=e)}function updateTrafficUI(e){const t=document.getElementById("fab-traffic"),n=document.getElementById("traffic-legend");t&&(e?t.classList.add("active"):t.classList.remove("active")),n&&(e?n.classList.add("show"):n.classList.remove("show"))}function initTrafficUI(){state.settings.showTraffic&&updateTrafficUI(!0)}window.refreshTraffic=refreshTraffic,window.quickToggleTraffic=quickToggleTraffic,window.initTrafficUI=initTrafficUI;const OFFLINE_DB_NAME="dataacuity-maps-offline",OFFLINE_DB_VERSION=1,TILE_ZOOM_LEVELS=[12,13,14,15,16],ROUTE_CORRIDOR_KM=2;let offlineDB=null,downloadAbortController=null;async function initOfflineDB(){return new Promise((e,t)=>{const n=indexedDB.open(OFFLINE_DB_NAME,1);n.onerror=()=>t(n.error),n.onsuccess=()=>{offlineDB=n.result,e(offlineDB)},n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("routes")){t.createObjectStore("routes",{keyPath:"id"}).createIndex("savedAt","savedAt",{unique:!1})}if(!t.objectStoreNames.contains("tiles")){t.createObjectStore("tiles",{keyPath:"key"}).createIndex("routeId","routeId",{unique:!1})}}})}function getTilesForRoute(e,t=2){const n=new Set,o=e.coordinates||[];if(0===o.length)return Array.from(n);for(let e=0;e<o.length;e++){const[a,i]=o[e];for(const e of TILE_ZOOM_LEVELS){const o=latLngToTile(i,a,e),s=Math.ceil(t/tileSizeKm(i,e));for(let t=-s;t<=s;t++)for(let a=-s;a<=s;a++)n.add(`${e}/${o.x+t}/${o.y+a}`)}}return Array.from(n)}function latLngToTile(e,t,n){const o=Math.pow(2,n),a=Math.floor((t+180)/360*o),i=e*Math.PI/180;return{x:a,y:Math.floor((1-Math.asinh(Math.tan(i))/Math.PI)/2*o)}}function tileSizeKm(e,t){const n=Math.pow(2,t);return 40075*Math.cos(e*Math.PI/180)/n}async function saveRouteOffline(){if(!currentRouteGeometry||!currentRouteSteps)return void showToast("No route to save");offlineDB||await initOfflineDB();const e=`To ${document.getElementById("nav-destination-name")?.textContent||"Route"}`,t=`route_${Date.now()}`,n=getTilesForRoute(currentRouteGeometry);showDownloadModal(n.length),downloadAbortController=new AbortController;try{const o=getTileBaseUrl();let a=0,i=0;for(const e of n){if(downloadAbortController.signal.aborted)throw new Error("Download cancelled");const s=`${o}/${e}.png`;try{const n=await fetch(s,{signal:downloadAbortController.signal});if(n.ok){const o=await n.blob();i+=o.size,await storeTile(t,e,o)}}catch(e){if("AbortError"===e.name)throw e}a++,updateDownloadProgress(a,n.length,i)}const s={id:t,name:e,geometry:currentRouteGeometry,steps:currentRouteSteps,distance:currentRouteDistanceM,duration:currentRouteDurationSec,origin:state.selectedOrigin,destination:state.selectedDestination,tileCount:n.length,totalSize:i,savedAt:Date.now()};await storeRoute(s),hideDownloadModal(),showToast(`Route saved! (${formatBytes(i)})`)}catch(e){hideDownloadModal(),"Download cancelled"!==e.message&&(showToast("Failed to save route"),console.error("[Offline] Save error:",e))}downloadAbortController=null}function getTileBaseUrl(){return"https://tile.openstreetmap.org"}async function storeTile(e,t,n){return new Promise((o,a)=>{const i=offlineDB.transaction("tiles","readwrite");i.objectStore("tiles").put({key:t,routeId:e,data:n,cachedAt:Date.now()}),i.oncomplete=()=>o(),i.onerror=()=>a(i.error)})}async function storeRoute(e){return new Promise((t,n)=>{const o=offlineDB.transaction("routes","readwrite");o.objectStore("routes").put(e),o.oncomplete=()=>t(),o.onerror=()=>n(o.error)})}async function getSavedRoutes(){return offlineDB||await initOfflineDB(),new Promise((e,t)=>{const n=offlineDB.transaction("routes","readonly").objectStore("routes").getAll();n.onsuccess=()=>{const t=n.result.sort((e,t)=>t.savedAt-e.savedAt);e(t)},n.onerror=()=>t(n.error)})}async function deleteSavedRoute(e){if(offlineDB)return new Promise((t,n)=>{const o=offlineDB.transaction(["routes","tiles"],"readwrite");o.objectStore("routes").delete(e);o.objectStore("tiles").index("routeId").openCursor(IDBKeyRange.only(e)).onsuccess=e=>{const t=e.target.result;t&&(t.delete(),t.continue())},o.oncomplete=()=>t(),o.onerror=()=>n(o.error)})}async function loadSavedRoute(e){return offlineDB||await initOfflineDB(),new Promise((t,n)=>{const o=offlineDB.transaction("routes","readonly").objectStore("routes").get(e);o.onsuccess=()=>t(o.result),o.onerror=()=>n(o.error)})}async function getCachedTile(e){return offlineDB?new Promise(t=>{const n=offlineDB.transaction("tiles","readonly").objectStore("tiles").get(e);n.onsuccess=()=>{n.result?t(n.result.data):t(null)},n.onerror=()=>t(null)}):null}function showDownloadModal(e){const t=document.getElementById("download-modal"),n=document.getElementById("download-title"),o=document.getElementById("download-status"),a=document.getElementById("download-progress-fill");n.textContent="Saving Route",o.textContent=`Downloading ${e} tiles...`,a.style.width="0%",t.classList.add("show")}function updateDownloadProgress(e,t,n){const o=document.getElementById("download-status"),a=document.getElementById("download-progress-fill"),i=Math.round(e/t*100);a.style.width=`${i}%`,o.textContent=`${e}/${t} tiles (${formatBytes(n)})`}function hideDownloadModal(){document.getElementById("download-modal").classList.remove("show")}function cancelDownload(){downloadAbortController&&downloadAbortController.abort(),hideDownloadModal(),showToast("Download cancelled")}async function openSavedRoutes(){toggleMenu(!1);const e=document.getElementById("saved-routes-backdrop"),t=document.getElementById("saved-routes-panel"),n=document.getElementById("saved-routes-list"),o=document.getElementById("saved-routes-empty"),a=await getSavedRoutes();0===a.length?(n.innerHTML="",o.classList.add("show")):(o.classList.remove("show"),n.innerHTML=a.map(e=>`\n            <div class="saved-route-item" onclick="useSavedRoute('${e.id}')">\n                <div class="saved-route-icon">üó∫Ô∏è</div>\n                <div class="saved-route-info">\n                    <div class="saved-route-name">${escapeHtml(e.name)}</div>\n                    <div class="saved-route-details">${formatDistance(e.distance/1e3)} ‚Ä¢ ${formatDuration(e.duration)}</div>\n                    <div class="saved-route-size">${formatBytes(e.totalSize)} ‚Ä¢ Saved ${formatTimeAgo(e.savedAt)}</div>\n                </div>\n                <div class="saved-route-actions">\n                    <button class="saved-route-btn delete" onclick="event.stopPropagation(); confirmDeleteRoute('${e.id}')">üóëÔ∏è</button>\n                </div>\n            </div>\n        `).join("")),e.classList.add("active"),t.classList.add("active")}function closeSavedRoutes(){const e=document.getElementById("saved-routes-backdrop"),t=document.getElementById("saved-routes-panel");e.classList.remove("active"),t.classList.remove("active")}async function useSavedRoute(e){const t=await loadSavedRoute(e);t?(closeSavedRoutes(),state.selectedOrigin=t.origin,state.selectedDestination=t.destination,currentRouteGeometry=t.geometry,currentRouteSteps=t.steps,currentRouteDurationSec=t.duration,currentRouteDistanceM=t.distance,displayAllRoutes([{id:"saved",geometry:t.geometry,distance:t.distance,duration:t.duration}],0),openNavPanelWithRoute(t),showToast("Route loaded (offline available)")):showToast("Route not found")}function openNavPanelWithRoute(e){const t=document.getElementById("nav-panel"),n=document.getElementById("nav-actions-initial"),o=document.getElementById("nav-actions-route"),a=document.getElementById("nav-destination-name"),i=document.getElementById("nav-destination-address");a&&(a.textContent=e.name.replace("To ","")),i&&(i.textContent="Saved route");const s=document.getElementById("directions-duration"),r=document.getElementById("directions-distance");s&&(s.textContent=formatDuration(e.duration)),r&&(r.textContent=formatDistance(e.distance/1e3));const c=document.getElementById("directions-steps");c&&e.steps&&(c.innerHTML=e.steps.map((e,t)=>`\n            <div class="directions-step" data-step="${t}">\n                <div class="directions-step-icon">${getManeuverIcon(e.maneuver?.type||"straight")}</div>\n                <div class="directions-step-content">\n                    <div class="directions-step-instruction">${escapeHtml(e.instruction||e.name||"Continue")}</div>\n                    <div class="directions-step-distance">${formatDistance(e.distance/1e3)}</div>\n                </div>\n            </div>\n        `).join("")),n&&(n.style.display="none"),o&&(o.style.display="flex"),t.classList.add("active")}function confirmDeleteRoute(e){confirm("Delete this saved route and its offline maps?")&&deleteSavedRoute(e).then(()=>{showToast("Route deleted"),openSavedRoutes()})}function formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]}function formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?"just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:t<604800?`${Math.floor(t/86400)}d ago`:new Date(e).toLocaleDateString()}function setupOfflineTileSource(){if(state.map){const e=state.map._requestManager?._transformRequestFn;state.map.setTransformRequest((t,n)=>{if("Tile"===n&&!navigator.onLine){const e=t.match(/\/(\d+)\/(\d+)\/(\d+)\.(png|pbf|jpg)/);if(e){return{url:`/offline-tile/${`${e[1]}/${e[2]}/${e[3]}`}`,credentials:"same-origin"}}}return e?e(t,n):{url:t}})}}window.saveRouteOffline=saveRouteOffline,window.cancelDownload=cancelDownload,window.openSavedRoutes=openSavedRoutes,window.closeSavedRoutes=closeSavedRoutes,window.useSavedRoute=useSavedRoute,window.confirmDeleteRoute=confirmDeleteRoute,initOfflineDB().catch(e=>console.warn("[Offline] DB init failed:",e));let currentTripId=null,tripShareInterval=null;function generateTripId(){return"trip_"+Date.now().toString(36)+"_"+Math.random().toString(36).substr(2,9)}function getCurrentTripData(){if(!state.selectedDestination)return null;const e=state.selectedDestination.name||"Destination",t=document.getElementById("nav-eta-time")?.textContent||"",n=document.getElementById("nav-eta-distance")?.textContent||"";return{tripId:currentTripId,destination:e,eta:t,remaining:n,destLat:state.selectedDestination.lat,destLng:state.selectedDestination.lng,currentLat:state.userLocation?.lat,currentLng:state.userLocation?.lng,durationSec:currentRouteDurationSec,distanceM:currentRouteDistanceM,timestamp:Date.now()}}function openShareETA(){if(!isNavigating||!state.selectedDestination)return void showToast("Start navigation first");currentTripId||(currentTripId=generateTripId());const e=getCurrentTripData();if(!e)return;const t=document.getElementById("share-eta-destination"),n=document.getElementById("share-eta-time"),o=document.getElementById("share-eta-distance"),a=document.getElementById("share-eta-link");t&&(t.textContent=e.destination),n&&(n.textContent=e.eta||"Calculating..."),o&&(o.textContent=e.remaining||"");const i=generateShareLink(e);a&&(a.value=i);document.getElementById("share-eta-modal").classList.add("show"),startTripSharing()}function closeShareETA(){document.getElementById("share-eta-modal").classList.remove("show")}function closeShareETAOnBackdrop(e){e.target.classList.contains("share-eta-modal")&&closeShareETA()}function generateShareLink(e){return`${window.location.origin}/track?${new URLSearchParams({trip:e.tripId,dest:encodeURIComponent(e.destination),lat:e.destLat?.toFixed(6)||"",lng:e.destLng?.toFixed(6)||""}).toString()}`}function shareETAvia(e){const t=getCurrentTripData();if(!t)return;const n=generateShareLink(t),o=`I'm on my way to ${t.destination}. ETA: ${t.eta}. Track my live location:`,a=`${o}\n${n}`;switch(e){case"sms":window.open(`sms:?body=${encodeURIComponent(a)}`,"_blank"),showToast("Opening SMS...");break;case"whatsapp":window.open(`https://wa.me/?text=${encodeURIComponent(a)}`,"_blank"),showToast("Opening WhatsApp...");break;case"email":const e=`My ETA to ${t.destination}`;window.open(`mailto:?subject=${encodeURIComponent(e)}&body=${encodeURIComponent(a)}`,"_blank"),showToast("Opening email...");break;case"copy":copyShareLink();break;default:navigator.share?navigator.share({title:"My ETA",text:o,url:n}).catch(()=>{copyShareLink()}):copyShareLink()}closeShareETA()}function copyShareLink(){const e=document.getElementById("share-eta-link");if(!e)return;const t=e.value;navigator.clipboard?navigator.clipboard.writeText(t).then(()=>{showToast("Link copied to clipboard")}).catch(()=>{fallbackCopyLink(t)}):fallbackCopyLink(t)}function fallbackCopyLink(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy"),showToast("Link copied to clipboard")}catch(e){showToast("Failed to copy link")}document.body.removeChild(t)}function startTripSharing(){if(tripShareInterval)return;tripShareInterval=setInterval(async()=>{if(!isNavigating||!currentTripId)return void stopTripSharing();const e=getCurrentTripData();if(e)try{await fetch("/api/share/trip",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.warn("[Share] Failed to update trip:",e)}},3e4);const e=getCurrentTripData();e&&fetch("/api/share/trip",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).catch(()=>{})}function stopTripSharing(){tripShareInterval&&(clearInterval(tripShareInterval),tripShareInterval=null),currentTripId=null}function updateShareFAB(e){const t=document.getElementById("fab-share-eta");t&&(t.style.display=e?"flex":"none")}function initEventListeners(){window.addEventListener("popstate",()=>{document.getElementById("search-overlay").classList.contains("active")?closeSearch():document.getElementById("menu-panel").classList.contains("active")?toggleMenu(!1):document.getElementById("nav-panel").classList.contains("active")?closeNavPanel():document.getElementById("report-panel").classList.contains("active")?closeReportPanel():document.getElementById("route-options").classList.contains("show")?closeRouteOptions():document.getElementById("saved-routes-panel").classList.contains("active")?closeSavedRoutes():document.getElementById("share-eta-modal").classList.contains("show")&&closeShareETA()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(closeSearch(),toggleMenu(!1),closeNavPanel(),closeReportPanel(),closeRouteOptions(),closeSavedRoutes(),closeShareETA())})}function initURLState(){let e;state.map.on("moveend",()=>{clearTimeout(e),e=setTimeout(updateURLState,300)})}function updateURLState(){if(!state.map)return;const e=state.map.getCenter(),t=state.map.getZoom(),n=`#${e.lat.toFixed(5)},${e.lng.toFixed(5)},${Math.round(t)}z`;window.location.hash!==n&&history.replaceState(null,"",n)}function parseURLState(){const e=window.location.hash.slice(1);if(!e)return!1;const t=e.match(/^(-?\d+\.?\d*),(-?\d+\.?\d*),(\d+)z$/);if(!t)return!1;const n=parseFloat(t[1]),o=parseFloat(t[2]),a=parseInt(t[3]);return!(isNaN(n)||isNaN(o)||isNaN(a))&&(!(n<-90||n>90||o<-180||o>180)&&(!(a<1||a>20)&&(state.map.jumpTo({center:[o,n],zoom:a}),!0)))}function showToast(e){const t=document.getElementById("toast");t.textContent=e,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},3e3)}function showError(e){document.getElementById("map").innerHTML=`\n        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:white;text-align:center;padding:20px;">\n            <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>\n            <div style="font-size:18px;">${escapeHtml(e)}</div>\n        </div>\n    `}function escapeHtml(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}window.openShareETA=openShareETA,window.closeShareETA=closeShareETA,window.closeShareETAOnBackdrop=closeShareETAOnBackdrop,window.shareETAvia=shareETAvia,window.copyShareLink=copyShareLink,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initApp):initApp();