const API_BASE="/api";async function fetchJSON(e,t={}){try{const n=await fetch(e,t);if(!n.ok)return{ok:!1,status:n.status,data:null};const a=n.headers.get("content-type");if(!a||!a.includes("application/json"))return console.warn(`[fetchJSON] Non-JSON response from ${e}:`,a),{ok:!1,status:n.status,data:null};const o=await n.json();return{ok:!0,status:n.status,data:o}}catch(t){return console.warn(`[fetchJSON] Failed to fetch ${e}:`,t.message),{ok:!1,status:0,data:null,error:t}}}const MAP_CONFIG={center:[25,0],zoom:3,minZoom:2,maxZoom:16,style:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json"},ORIENTATIONS={"north-up":{bearing:0,label:"North Up",description:"Modern standard"},"south-up":{bearing:180,label:"South Up",description:"Australian/African perspective"},"east-up":{bearing:90,label:"East Up",description:"Medieval European (toward Jerusalem)"},"west-up":{bearing:-90,label:"West Up",description:"Alternative view"}},MAP_STYLES={"local-sa":{name:"South Africa (Local)",url:"/tiles/styles/south-africa/style.json",description:"Self-hosted SA tiles (fastest)",local:!0},voyager:{name:"Carto Voyager",url:"https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",description:"Colorful, detailed streets"},positron:{name:"Carto Positron",url:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",description:"Light, minimal"},"dark-matter":{name:"Carto Dark",url:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",description:"Dark theme"},"osm-standard":{name:"OpenStreetMap",url:null,raster:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",description:"Classic OSM style"},topo:{name:"OpenTopoMap",url:null,raster:"https://tile.opentopomap.org/{z}/{x}/{y}.png",description:"Terrain & elevation"},satellite:{name:"ESRI Satellite",url:null,raster:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",description:"Aerial imagery (free)"},"satellite-labels":{name:"Satellite + Labels",url:null,raster:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",overlay:"https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png",description:"Aerial with place names"}},PLACE_CATEGORIES={settlements:{name:"Settlements",color:"#007AFF",icon:"üèòÔ∏è",types:["settlement","city","town","village","neighborhood","locality","suburb","hamlet"]},water:{name:"Water Features",color:"#5AC8FA",icon:"üíß",types:["river","lake","bay","reservoir","ocean","sea","stream","waterfall","spring","lagoon","wetland"]},terrain:{name:"Terrain",color:"#8B4513",icon:"‚õ∞Ô∏è",types:["mountain","peak","mountain-range","mountain-pass","hill","valley","plateau","desert","forest","cape","peninsula"]},islands:{name:"Islands",color:"#34C759",icon:"üèùÔ∏è",types:["island","archipelago","atoll","reef"]},historic:{name:"Historic Sites",color:"#FF9500",icon:"üèõÔ∏è",types:["ancient_city","ruins","archaeological","monument","temple","castle","fort","historic"]},transport:{name:"Transport",color:"#AF52DE",icon:"üöÇ",types:["train-station","bus-stop","airport","port","harbor","station"]},buildings:{name:"Buildings",color:"#FF3B30",icon:"üè¢",types:["hotel","church","school","hospital","university","mosque","synagogue","museum"]},admin:{name:"Administrative",color:"#8E8E93",icon:"üìç",types:["admin-district","country","state","province","region","county","p"]}};function getCategoryForType(e){if(!e)return null;const t=e.toLowerCase();for(const[e,n]of Object.entries(PLACE_CATEGORIES))if(n.types.some((e=>t.includes(e)||e.includes(t))))return e;return"admin"}const state={map:null,currentYear:2024,markers:[],selectedPlace:null,isPlaying:!1,playInterval:null,orientation:localStorage.getItem("mapOrientation")||"north-up",mapStyle:localStorage.getItem("mapStyle")||"voyager",categoryFilters:JSON.parse(localStorage.getItem("categoryFilters"))||{settlements:!0,water:!0,terrain:!0,islands:!0,historic:!0,transport:!1,buildings:!1,admin:!1},allPlaces:[],hoverPopup:null,routing:{active:!1,waypoints:[],routeLayer:null,markers:[]},nearby:{active:!1,center:null,radius:2e3,markers:[],activeCategories:[]},memories:{active:!1,items:[],markers:[],userHash:null},mode:localStorage.getItem("mapMode")||"explore"};function switchMode(e){if(["explore","timeline","navigate","transit"].includes(e)){switch(state.mode=e,localStorage.setItem("mapMode",e),document.body.setAttribute("data-mode",e),document.querySelectorAll(".mode-tab").forEach((t=>{const n=t.dataset.mode===e;t.classList.toggle("active",n),t.setAttribute("aria-selected",n)})),e){case"explore":initExploreMode();break;case"timeline":initTimelineMode();break;case"navigate":initNavigateMode();break;case"transit":initTransitMode()}closeModePanels(e)}}function initExploreMode(){const e=document.getElementById("reports-layer-toggle");e&&void 0!==reportsState&&reportsState.enabled&&(e.checked=!1,"function"==typeof toggleReportsLayer&&toggleReportsLayer(!1));const t=document.getElementById("transit-layer-toggle");t&&void 0!==transitState&&transitState.enabled&&(t.checked=!1,"function"==typeof toggleTransitLayer&&toggleTransitLayer(!1))}function initTimelineMode(){const e=document.getElementById("timeline-panel");e&&e.classList.remove("hidden");const t=document.getElementById("reports-layer-toggle");t&&void 0!==reportsState&&reportsState.enabled&&(t.checked=!1,"function"==typeof toggleReportsLayer&&toggleReportsLayer(!1));const n=document.getElementById("transit-layer-toggle");n&&void 0!==transitState&&transitState.enabled&&(n.checked=!1,"function"==typeof toggleTransitLayer&&toggleTransitLayer(!1))}function initNavigateMode(){const e=document.getElementById("reports-layer-toggle");e&&void 0!==reportsState&&!reportsState.enabled&&(e.checked=!0,"function"==typeof toggleReportsLayer&&toggleReportsLayer(!0));const t=document.getElementById("routing-panel");t&&t.classList.remove("hidden")}function initTransitMode(){const e=document.getElementById("transit-layer-toggle");e&&void 0!==transitState&&!transitState.enabled&&(e.checked=!0,"function"==typeof toggleTransitLayer&&toggleTransitLayer(!0))}function closeModePanels(e){const t=document.getElementById("routing-panel"),n=document.getElementById("nearby-panel"),a=document.getElementById("leaderboard-panel"),o=document.getElementById("timeline-panel");"navigate"!==e&&t&&t.classList.add("hidden"),"timeline"!==e&&o&&o.classList.add("hidden"),"timeline"!==e&&"transit"!==e||n&&n.classList.add("hidden"),"navigate"!==e&&a&&a.classList.add("hidden")}function initModeSystem(){const e=state.mode;document.body.setAttribute("data-mode",e),document.querySelectorAll(".mode-tab").forEach((t=>{const n=t.dataset.mode===e;t.classList.toggle("active",n),t.setAttribute("aria-selected",n)})),switchMode(e)}function startApp(){initMap(),initTimeline(),initSearch(),initModals();const e=window.requestIdleCallback||(e=>setTimeout(e,1));e((()=>{initDraggablePanel(),initOrientationControls(),initMapStyles(),initLegend(),initCategoryFilters(),initURLHandling(),loadStats(),initKeyboardShortcuts(),initYearInput(),initStatsHints(),initModeSystem()})),e((()=>{initRouting(),initNearby(),initMemories(),initOnboarding(),initTransitLayer(),initReportsLayer(),initLeaderboard()}),{timeout:2e3})}function initURLHandling(){if(parseURLState(),window.addEventListener("hashchange",(()=>{parseURLState()})),state.map){let e;state.map.on("moveend",(()=>{clearTimeout(e),e=setTimeout((()=>{updateURLState()}),500)}))}}function parseURLState(){const e=window.location.hash.slice(1);if(!e)return;const t=new URLSearchParams(e),n=t.get("year");if(n&&!isNaN(parseInt(n))){const e=parseInt(n);state.currentYear=e;const t=document.getElementById("timeline-slider");t&&(t.value=e,updateYear(e))}const a=t.get("place");if(a){const e=document.getElementById("search-input");e&&(e.value=decodeURIComponent(a),performSearch(a))}const o=t.get("lat"),s=t.get("lng"),r=t.get("zoom");if(o&&s&&state.map){const e=[parseFloat(s),parseFloat(o)],t=r?parseFloat(r):state.map.getZoom();state.map.flyTo({center:e,zoom:t,duration:1e3})}}function updateURLState(){if(!state.map)return;const e=state.map.getCenter(),t=state.map.getZoom(),n=state.currentYear,a=new URLSearchParams;2024!==n&&a.set("year",n),a.set("lat",e.lat.toFixed(4)),a.set("lng",e.lng.toFixed(4)),a.set("zoom",t.toFixed(1));const o=a.toString();o&&history.replaceState(null,"","#"+o),updateCanonicalURL()}function updateCanonicalURL(){const e=document.querySelector('link[rel="canonical"]');if(e){const t="https://maps.dataacuity.co.za/",n=window.location.hash;e.href=n?t+n:t}}function setURLPlace(e){const t=new URLSearchParams(window.location.hash.slice(1));t.set("place",encodeURIComponent(e)),history.pushState(null,"","#"+t.toString()),document.title=`${e} - DataAcuity Maps`;const n=document.querySelector('meta[name="description"]');n&&(n.content=`Explore ${e} through history on DataAcuity Maps. Discover historical names, events, and how this place changed over time from 3000 BCE to today.`)}function setURLYear(e){const t=new URLSearchParams(window.location.hash.slice(1));2024!==e?t.set("year",e):t.delete("year"),history.replaceState(null,"","#"+t.toString())}function toggleSection(e){const t=e.closest(".collapsible-section"),n=t.querySelector(".section-content"),a=e.querySelector(".section-toggle");n.classList.contains("collapsed")?(n.classList.remove("collapsed"),a.classList.remove("collapsed")):(n.classList.add("collapsed"),a.classList.add("collapsed"));const o=t.className.split(" ")[0],s=JSON.parse(localStorage.getItem("collapsedSections")||"{}");s[o]=n.classList.contains("collapsed"),localStorage.setItem("collapsedSections",JSON.stringify(s))}function restoreCollapsedStates(){const e=JSON.parse(localStorage.getItem("collapsedSections")||"{}");Object.entries(e).forEach((([e,t])=>{if(t){const t=document.querySelector(`.${e}`);if(t){const e=t.querySelector(".section-content"),n=t.querySelector(".section-toggle");e&&e.classList.add("collapsed"),n&&n.classList.add("collapsed")}}}))}function getToastContainer(){let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="toast-container",document.body.appendChild(e)),e}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showToast(e,t="info",n=4e3){const a=getToastContainer(),o=escapeHtml(e),s=document.createElement("div");s.className=`toast toast-${t}`,s.style.position="relative",s.innerHTML=`\n        <div class="toast-icon">${{success:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>',error:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',warning:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',info:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'}[t]}</div>\n        <div class="toast-content">\n            <div class="toast-title">${{success:"Success",error:"Error",warning:"Warning",info:"Info"}[t]}</div>\n            <div class="toast-message">${o}</div>\n        </div>\n        <button class="toast-close">&times;</button>\n        <div class="toast-progress" style="animation-duration: ${n}ms"></div>\n    `,a.appendChild(s);return s.querySelector(".toast-close").addEventListener("click",(()=>removeToast(s))),setTimeout((()=>removeToast(s)),n),s}function removeToast(e){e&&!e.classList.contains("toast-exit")&&(e.classList.add("toast-exit"),setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300))}function showSuccess(e,t){return showToast(e,"success",t)}function showError(e,t){return showToast(e,"error",t)}function showWarning(e,t){return showToast(e,"warning",t)}function showInfo(e,t){return showToast(e,"info",t)}function initDraggablePanel(){const e=document.getElementById("layers-panel"),t=document.getElementById("layers-list");e.classList.add("draggable");const n=e.querySelector("h3");n&&n.remove();const a=document.createElement("div");a.className="panel-drag-handle",a.innerHTML='\n        <h3>\n            <span class="drag-icon">‚ãÆ‚ãÆ</span>\n            Map Layers\n        </h3>\n        <button class="panel-close-btn" onclick="closeDraggablePanel()">&times;</button>\n    ',e.insertBefore(a,t);let o,s,r,i,l=!1;function c(e){return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}function d(t){if(t.target.classList.contains("panel-close-btn"))return;l=!0;const n=c(t);o=n.x,s=n.y;const d=e.getBoundingClientRect();r=d.left,i=d.top,a.style.cursor="grabbing",t.preventDefault()}function p(t){if(!l)return;const n=c(t),a=n.x-o,d=n.y-s;let p=r+a,u=i+d;const m=e.getBoundingClientRect(),y=window.innerWidth-m.width,g=window.innerHeight-m.height;p=Math.max(0,Math.min(p,y)),u=Math.max(56,Math.min(u,g)),e.style.left=p+"px",e.style.top=u+"px",e.style.right="auto",t.touches&&t.preventDefault()}function u(){if(l){l=!1,a.style.cursor="grab";const t=e.getBoundingClientRect();localStorage.setItem("layersPanelPosition",JSON.stringify({left:t.left,top:t.top}))}}a.addEventListener("mousedown",d),document.addEventListener("mousemove",p),document.addEventListener("mouseup",u),a.addEventListener("touchstart",d,{passive:!1}),document.addEventListener("touchmove",p,{passive:!1}),document.addEventListener("touchend",u);const m=localStorage.getItem("layersPanelPosition");if(m){const t=JSON.parse(m);e.style.left=t.left+"px",e.style.top=t.top+"px",e.style.right="auto"}setTimeout(restoreCollapsedStates,100)}function closeDraggablePanel(){document.getElementById("layers-panel").classList.add("hidden")}function makePanelDraggable(e,t,n){let a,o,s,r,i=!1;function l(e){return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}function c(n){if(n.target.closest("button")||n.target.closest("input"))return;i=!0;const c=l(n);a=c.x,o=c.y;const d=e.getBoundingClientRect();s=d.left,r=d.top,t.style.cursor="grabbing",n.preventDefault()}function d(t){if(!i)return;const n=l(t),c=n.x-a,d=n.y-o;let p=s+c,u=r+d;const m=e.getBoundingClientRect(),y=window.innerWidth-m.width,g=window.innerHeight-m.height;p=Math.max(0,Math.min(p,y)),u=Math.max(56,Math.min(u,g)),e.style.left=p+"px",e.style.top=u+"px",e.style.right="auto",e.style.bottom="auto",e.style.transform="none",t.touches&&t.preventDefault()}function p(){if(i&&(i=!1,t.style.cursor="grab",n)){const t=e.getBoundingClientRect();localStorage.setItem(n,JSON.stringify({left:t.left,top:t.top}))}}if(t.addEventListener("mousedown",c),document.addEventListener("mousemove",d),document.addEventListener("mouseup",p),t.addEventListener("touchstart",c,{passive:!1}),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("touchend",p),n){const t=localStorage.getItem(n);if(t){const n=JSON.parse(t);e.style.left=n.left+"px",e.style.top=n.top+"px",e.style.right="auto",e.style.bottom="auto",e.style.transform="none"}}}function initMap(){if("undefined"==typeof maplibregl)return console.error("[initMap] MapLibre GL JS not loaded yet, retrying..."),void setTimeout(initMap,100);if(function(){try{const e=document.createElement("canvas");return!(!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}())try{const e=ORIENTATIONS[state.orientation]||ORIENTATIONS["north-up"],t=MAP_STYLES[state.mapStyle]||MAP_STYLES.voyager;let n;n=t.url?t.url:buildRasterStyle(t),state.map=new maplibregl.Map({container:"map",style:n,center:MAP_CONFIG.center,zoom:MAP_CONFIG.zoom,minZoom:MAP_CONFIG.minZoom,maxZoom:MAP_CONFIG.maxZoom,bearing:e.bearing,failIfMajorPerformanceCaveat:!1}),state.map.on("error",(e=>{console.error("[Map Error]",e.error?.message||e.message||"Unknown error")})),state.map.addControl(new maplibregl.NavigationControl,"top-left"),state.map.addControl(new maplibregl.ScaleControl,"bottom-left"),state.hoverPopup=new maplibregl.Popup({closeButton:!1,closeOnClick:!1,className:"hover-label-popup"}),state.map.on("load",(()=>{loadPlacesForYear(state.currentYear),setupMapClickHandler(),checkForSharedRoute(),setupTransitMapListeners()}))}catch(e){console.error("[initMap] Failed to initialize map:",e);const t=document.getElementById("map");t&&(t.innerHTML=`\n                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:2rem;text-align:center;color:#666;">\n                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                        <circle cx="12" cy="12" r="10"></circle>\n                        <line x1="12" y1="8" x2="12" y2="12"></line>\n                        <line x1="12" y1="16" x2="12.01" y2="16"></line>\n                    </svg>\n                    <h3 style="margin:1rem 0 0.5rem;color:#333;">Map Failed to Load</h3>\n                    <p style="margin:0;max-width:300px;">${escapeHtml(e.message||"An error occurred while loading the map.")}</p>\n                    <button onclick="location.reload()" style="margin-top:1rem;padding:0.5rem 1rem;background:#0ea5e9;color:white;border:none;border-radius:0.5rem;cursor:pointer;">\n                        Reload Page\n                    </button>\n                </div>\n            `)}else{console.error("[initMap] WebGL not supported");const e=document.getElementById("map");e&&(e.innerHTML='\n                <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:2rem;text-align:center;color:#666;">\n                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n                        <circle cx="12" cy="12" r="10"></circle>\n                        <line x1="12" y1="8" x2="12" y2="12"></line>\n                        <line x1="12" y1="16" x2="12.01" y2="16"></line>\n                    </svg>\n                    <h3 style="margin:1rem 0 0.5rem;color:#333;">WebGL Not Supported</h3>\n                    <p style="margin:0;max-width:300px;">Your browser or device doesn\'t support WebGL, which is required for interactive maps.</p>\n                    <p style="margin:1rem 0;font-size:0.875rem;">Try updating your browser or enabling hardware acceleration in settings.</p>\n                </div>\n            ')}}function buildRasterStyle(e){const t={"raster-tiles":{type:"raster",tiles:[e.raster],tileSize:256,attribution:getAttribution(e.raster)}},n=[{id:"raster-layer",type:"raster",source:"raster-tiles",minzoom:0,maxzoom:19}];return e.overlay&&(t["overlay-tiles"]={type:"raster",tiles:[e.overlay],tileSize:256},n.push({id:"overlay-layer",type:"raster",source:"overlay-tiles",minzoom:0,maxzoom:19})),{version:8,sources:t,layers:n}}function getAttribution(e){return e.includes("openstreetmap")?"¬© OpenStreetMap contributors":e.includes("opentopomap")?"¬© OpenTopoMap":e.includes("arcgisonline")?"¬© Esri":e.includes("stamen")?"¬© Stamen Design":""}function setupMapClickHandler(){state.map.on("click",(e=>{const t=e.lngLat,n=document.querySelector('input[name="lat"]'),a=document.querySelector('input[name="lng"]');n&&a&&(n.value=t.lat.toFixed(6),a.value=t.lng.toFixed(6))}))}function initTimeline(){const e=document.getElementById("timeline-slider"),t=(document.getElementById("year-display"),document.getElementById("btn-play"));e.addEventListener("input",(e=>{updateYear(parseInt(e.target.value))})),t.addEventListener("click",togglePlay),document.querySelectorAll(".preset-btn").forEach((t=>{t.addEventListener("click",(()=>{const n=parseInt(t.dataset.year);e.value=n,updateYear(n),document.querySelectorAll(".preset-btn").forEach((e=>e.classList.remove("active"))),t.classList.add("active")}))}));const n=document.getElementById("timeline-panel"),a=document.getElementById("timeline-drag-handle");if(n&&a&&makePanelDraggable(n,a,"timelinePanelPosition"),n){const e=n.querySelector(".timeline-slider-container"),t=n.querySelector(".timeline-presets"),a=document.getElementById("timeline-toggle");n.classList.add("collapsed"),e&&(e.style.display="none"),t&&(t.style.display="none"),a&&(a.textContent="+")}}function updateYear(e){state.currentYear=e;const t=formatYear(e);document.getElementById("year-display").textContent=t,document.querySelectorAll(".preset-btn").forEach((t=>{t.classList.toggle("active",parseInt(t.dataset.year)===e)})),setURLYear(e),loadPlacesForYear(e)}function formatYear(e){return e<0?`${Math.abs(e)} BCE`:0===e?"1 BCE":`${e} CE`}function togglePlay(){const e=document.getElementById("btn-play");if(state.isPlaying)clearInterval(state.playInterval),state.isPlaying=!1,e.textContent="‚ñ∂Ô∏è";else{state.isPlaying=!0,e.textContent="‚è∏Ô∏è";const t=document.getElementById("timeline-slider");let n=parseInt(t.value);state.playInterval=setInterval((()=>{n+=50,n>2024&&(n=-3e3),t.value=n,updateYear(n)}),500)}}async function loadPlacesForYear(e){const t=getMapBounds(),n=await fetchJSON(`${API_BASE}/timeline/${e}?bbox=${t}&limit=500`);n.ok&&n.data&&n.data.features?displayPlaces(n.data.features):displaySampleData()}function getMapBounds(){const e=state.map.getBounds();return`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`}function displayPlaces(e){state.allPlaces=e,renderFilteredPlaces()}function renderFilteredPlaces(){state.markers.forEach((e=>e.remove())),state.markers=[];state.allPlaces.filter((e=>{const t=getCategoryForType(e.properties.place_type);return state.categoryFilters[t]})).forEach((e=>{const t=e.properties,n=e.geometry.coordinates,a=getCategoryForType(t.place_type),o=PLACE_CATEGORIES[a]||PLACE_CATEGORIES.admin,s=document.createElement("div");s.className="map-marker",s.dataset.placeId=t.id,s.dataset.placeName=t.display_name||t.name_at_year||t.current_name,s.dataset.placeType=t.place_type,s.style.cssText=`\n            width: 24px;\n            height: 24px;\n            background: ${o.color};\n            border: 2px solid white;\n            border-radius: 50%;\n            cursor: pointer;\n            box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 12px;\n            transition: transform 0.15s ease;\n        `,s.innerHTML=o.icon;const r=new maplibregl.Marker({element:s}).setLngLat(n).setPopup(createPopup(t)).addTo(state.map);s.addEventListener("mouseenter",(()=>{s.style.transform="scale(1.2)";const e=t.display_name||t.name_at_year||t.current_name;state.hoverPopup.setLngLat(n).setHTML(`<div class="hover-label">${e}</div>`).addTo(state.map)})),s.addEventListener("mouseleave",(()=>{s.style.transform="scale(1)",state.hoverPopup.remove()})),s.addEventListener("click",(()=>{loadPlaceDetails(t.id)})),state.markers.push(r)})),updateLegendCounts()}function updateLegendCounts(){const e={};Object.keys(PLACE_CATEGORIES).forEach((t=>e[t]=0)),state.allPlaces.forEach((t=>{const n=getCategoryForType(t.properties.place_type);void 0!==e[n]&&e[n]++})),Object.entries(e).forEach((([e,t])=>{const n=document.getElementById(`legend-count-${e}`);n&&(n.textContent=t>0?`(${t})`:"")}))}function createPopup(e){const t=`\n        <div class="popup-content">\n            <div class="popup-title">${e.display_name||e.name_at_year}</div>\n            ${e.native_name?`<div class="popup-historical">${e.native_name}</div>`:""}\n            ${e.used_by?`<div class="popup-historical">Used by: ${e.used_by}</div>`:""}\n            <span class="popup-type">${e.place_type}</span>\n        </div>\n    `;return new maplibregl.Popup({offset:15}).setHTML(t)}async function loadPlaceDetails(e){try{const t=await fetch(`${API_BASE}/places/${e}`);if(!t.ok)return;showPlacePanel(await t.json())}catch(e){console.error("Error loading place details:",e)}}function showPlacePanel(e){const t=document.getElementById("place-panel"),n=document.getElementById("panel-content");e.current_name&&setURLPlace(e.current_name);const a=e.historical_names||[];a.sort(((e,t)=>(e.year_start||-9999)-(t.year_start||-9999))),n.innerHTML=`\n        <div class="panel-header">\n            <h3 class="panel-title">${e.current_name}</h3>\n            <p class="panel-subtitle">${e.place_type} | ${e.country_code||"Unknown"}</p>\n        </div>\n\n        <div class="panel-section">\n            <h4>Names Through History</h4>\n            <div class="name-timeline">\n                ${a.length>0?a.map((e=>`\n                    <div class="name-entry ${e.year_end?"":"current"}">\n                        <div class="name-text">${e.name}</div>\n                        ${e.name_native?`<div class="name-native">${e.name_native}</div>`:""}\n                        <div class="name-meta">\n                            <span class="name-years">${formatYearRange(e.year_start,e.year_end)}</span>\n                            ${e.used_by?`<span>‚Ä¢ ${e.used_by}</span>`:""}\n                        </div>\n                        ${e.source_title?`<div class="name-meta">Source: ${e.source_title}</div>`:""}\n                    </div>\n                `)).join(""):`\n                    <div class="name-entry current">\n                        <div class="name-text">${e.current_name}</div>\n                        <div class="name-meta">\n                            <span class="name-years">Present</span>\n                        </div>\n                    </div>\n                `}\n            </div>\n        </div>\n\n        ${e.lat&&e.lng?`\n        <div class="panel-section">\n            <h4>Location</h4>\n            <p>${e.lat.toFixed(4)}, ${e.lng.toFixed(4)}</p>\n        </div>\n\n        <div class="place-actions">\n            <button class="btn btn-secondary btn-icon-text" onclick="getDirectionsToPlace(${e.lng}, ${e.lat}, '${e.current_name.replace(/'/g,"\\'")}')">\n                üß≠ Directions\n            </button>\n            <button class="btn btn-secondary btn-icon-text" onclick="findNearbyFromPlace(${e.lng}, ${e.lat})">\n                üìç Nearby\n            </button>\n            <button class="btn btn-secondary btn-icon-text" onclick="loadStreetView(${e.lat}, ${e.lng})">\n                üì∑ Street View\n            </button>\n        </div>\n\n        <div id="streetview-section" class="streetview-section hidden">\n            <h4>üì∑ Street View</h4>\n            <div id="streetview-content" class="streetview-content">\n                <div class="streetview-loading">Loading street-level imagery...</div>\n            </div>\n        </div>\n\n        <div class="reviews-section">\n            <h4>‚≠ê Reviews</h4>\n            <div id="reviews-summary" class="reviews-summary">\n                <span class="reviews-loading">Loading reviews...</span>\n            </div>\n            <div id="reviews-list" class="reviews-list"></div>\n            <p class="tagme-notice">\n                <small>Submit reviews via the <strong>TagMe</strong> app</small>\n            </p>\n        </div>\n\n        <div class="share-section">\n            <h4>Share This Place</h4>\n            <div class="share-buttons-grid">\n                <button class="share-btn-small share-whatsapp" onclick="sharePlaceToWhatsApp('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Share on WhatsApp">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n                </button>\n                <button class="share-btn-small share-telegram" onclick="sharePlaceToTelegram('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Share on Telegram">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>\n                </button>\n                <button class="share-btn-small share-twitter" onclick="sharePlaceToTwitter('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Share on X/Twitter">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>\n                </button>\n                <button class="share-btn-small share-facebook" onclick="sharePlaceToFacebook('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Share on Facebook">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>\n                </button>\n                <button class="share-btn-small share-email" onclick="sharePlaceToEmail('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Share via Email">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>\n                </button>\n                <button class="share-btn-small share-copy" onclick="copyPlaceUrl('${e.current_name.replace(/'/g,"\\'")}', ${e.lat}, ${e.lng})" title="Copy Link">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>\n                </button>\n            </div>\n        </div>\n        `:""}\n    `,t.classList.remove("hidden"),e.lat&&e.lng&&loadPlaceReviews(e.lat,e.lng)}function getDirectionsToPlace(e,t,n){const a=document.getElementById("routing-panel");if(a){a.classList.remove("hidden");const e=a.querySelector(".waypoint-search:last-of-type");e&&(e.value=n)}state.nearby.center?getDirectionsTo(e,t,n):(toggleRoutingPanel(),showInfo("Enter a starting point or use your location"))}function findNearbyFromPlace(e,t){const n=document.getElementById("nearby-panel");n&&(n.classList.remove("hidden"),state.nearby.active=!0,setNearbyCenter(e,t),state.map.flyTo({center:[e,t],zoom:14}))}window.switchMode=switchMode,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",startApp):startApp(),window.getDirectionsToPlace=getDirectionsToPlace,window.findNearbyFromPlace=findNearbyFromPlace;let currentStreetViewLocation=null;async function loadStreetView(e,t){const n=document.getElementById("streetview-section"),a=document.getElementById("streetview-content");currentStreetViewLocation={lat:e,lng:t},n.classList.remove("hidden"),a.innerHTML='<div class="streetview-loading">Loading street-level imagery...</div>';try{const n=await fetch(`/api/streetview?lat=${e}&lng=${t}&radius=200`),o=await n.json();if("not_configured"===o.status)return void(a.innerHTML=`\n                <div class="streetview-notice">\n                    <p>Street View not configured</p>\n                    <small>${o.message}</small>\n                </div>\n            `);o.images&&o.images.length>0?a.innerHTML=`\n                <div class="streetview-gallery">\n                    ${o.images.slice(0,6).map(((e,t)=>`\n                        <div class="streetview-thumb" onclick="openStreetViewImage('${e.id}', '${e.viewer_url}')">\n                            <img src="${e.thumbnail}" alt="Street view ${t+1}" loading="lazy">\n                            ${e.captured_at?`<span class="streetview-date">${new Date(e.captured_at).toLocaleDateString()}</span>`:""}\n                        </div>\n                    `)).join("")}\n                </div>\n                <p class="streetview-credit">\n                    <small>üì∏ ${o.count} images from <a href="https://www.mapillary.com" target="_blank" rel="noopener">Mapillary</a></small>\n                </p>\n            `:a.innerHTML='\n                <div class="streetview-notice">\n                    <p>No street-level imagery available here</p>\n                    <small>Help by contributing photos with the Mapillary app!</small>\n                </div>\n            '}catch(e){a.innerHTML=`\n            <div class="streetview-notice">\n                <p>Could not load street view</p>\n                <small>${e.message}</small>\n            </div>\n        `}}function openStreetViewImage(e,t){window.open(t,"_blank","noopener,noreferrer")}async function loadPlaceReviews(e,t){const n=document.getElementById("reviews-summary"),a=document.getElementById("reviews-list");try{const o=Math.abs(hashCode(`${e},${t}`))%1e6,s=await fetch(`/api/pois/${o}/reviews`),r=await s.json();r.review_count>0?(n.innerHTML=`\n                <span class="rating-display">\n                    <span class="rating-stars">${"‚òÖ".repeat(Math.round(r.average_rating))}${"‚òÜ".repeat(5-Math.round(r.average_rating))}</span>\n                    <span class="rating-value">${r.average_rating}</span>\n                </span>\n                <span class="review-count">(${r.review_count} reviews)</span>\n            `,a.innerHTML=r.reviews.slice(0,5).map((e=>`\n                <div class="review-item">\n                    <div class="review-rating">${"‚òÖ".repeat(e.rating)}${"‚òÜ".repeat(5-e.rating)}</div>\n                    ${e.text?`<p class="review-text">${escapeHtml(e.text)}</p>`:""}\n                    <span class="review-date">${new Date(e.created_at).toLocaleDateString()}</span>\n                </div>\n            `)).join("")):(n.innerHTML='<span class="no-reviews">No reviews yet</span>',a.innerHTML="")}catch(e){n.innerHTML='<span class="no-reviews">No reviews yet</span>',a.innerHTML=""}}function hashCode(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function formatYearRange(e,t){return`${null===e?"Ancient":formatYear(e)} - ${null===t?"Present":formatYear(t)}`}function initSearch(){const e=document.getElementById("search-input"),t=document.getElementById("search-results");let n;e.addEventListener("input",(e=>{clearTimeout(n);const a=e.target.value.trim();a.length<2?t.classList.add("hidden"):n=setTimeout((()=>searchPlaces(a)),300)})),e.addEventListener("keydown",(a=>{if("Enter"===a.key){a.preventDefault(),clearTimeout(n);const o=e.value.trim(),s=t.querySelector(".search-result-item");s&&!t.classList.contains("hidden")?s.click():o.length>=2&&searchPlaces(o)}else if("ArrowDown"===a.key||"ArrowUp"===a.key){const e=t.querySelectorAll(".search-result-item");if(0===e.length)return;a.preventDefault();const n=t.querySelector(".search-result-item.highlighted");let o;if(n){n.classList.remove("highlighted");const t=Array.from(e).indexOf(n);o="ArrowDown"===a.key?e[(t+1)%e.length]:e[(t-1+e.length)%e.length]}else o="ArrowDown"===a.key?e[0]:e[e.length-1];o.classList.add("highlighted"),o.scrollIntoView({block:"nearest"})}})),e.addEventListener("focus",(()=>{e.value.length>=2&&t.classList.remove("hidden")})),document.addEventListener("click",(e=>{e.target.closest(".search-container")||t.classList.add("hidden")}))}async function searchPlaces(e){const t=document.getElementById("search-results");try{const n=await fetch(`${API_BASE}/search?q=${encodeURIComponent(e)}`);if(!n.ok)return;const a=await n.json();0===a.results.length?t.innerHTML='<div class="search-result-item">No results found</div>':t.innerHTML=a.results.map((e=>{let t=[];e.admin1_name&&t.push(escapeHtml(e.admin1_name)),e.country_name&&t.push(escapeHtml(e.country_name)),e.continent&&!e.country_name&&t.push(escapeHtml(e.continent));const n=t.length>0?t.join(", "):escapeHtml(e.country_code||""),a=escapeHtml(e.matched_name||e.current_name),o=escapeHtml(e.current_name),s=escapeHtml(e.place_type);return`\n                <div class="search-result-item" onclick="flyToPlace(${e.lng}, ${e.lat}, ${e.id})">\n                    <div class="search-result-name">${a}</div>\n                    <div class="search-result-location">${n}</div>\n                    <div class="search-result-meta">\n                        ${e.matched_name&&e.matched_name!==e.current_name?`Now: ${o} ‚Ä¢ `:""}\n                        ${s}\n                        ${e.year_start?` ‚Ä¢ ${formatYear(e.year_start)}`:""}\n                    </div>\n                </div>\n            `})).join(""),t.classList.remove("hidden")}catch(e){console.error("Search error:",e)}}function flyToPlace(e,t,n){state.map.flyTo({center:[e,t],zoom:10,duration:1500}),document.getElementById("search-results").classList.add("hidden"),document.getElementById("search-input").value="",setTimeout((()=>loadPlaceDetails(n)),1600)}async function loadStats(){try{const e=await fetch(`${API_BASE}/stats`);if(!e.ok)return;const t=await e.json();document.getElementById("stats-places").textContent=t.total_places||0,document.getElementById("stats-names").textContent=t.total_historical_names||0,document.getElementById("stats-events").textContent=t.total_events||0}catch(e){document.getElementById("stats-places").textContent="12",document.getElementById("stats-names").textContent="35",document.getElementById("stats-events").textContent="8"}}function initModals(){const e=document.getElementById("btn-contribute"),t=document.getElementById("contribute-modal");e&&t&&e.addEventListener("click",(()=>{t.classList.remove("hidden")}));const n=document.getElementById("btn-info"),a=document.getElementById("info-modal");n&&a&&n.addEventListener("click",(()=>{a.classList.remove("hidden")}));const o=document.getElementById("btn-layers"),s=document.getElementById("layers-panel");o.addEventListener("click",(()=>{s.classList.toggle("hidden")})),document.getElementById("close-panel").addEventListener("click",(()=>{document.getElementById("place-panel").classList.add("hidden")}));makePanelDraggable(document.getElementById("place-panel"),document.getElementById("place-panel-header"),"placePanelPosition"),document.querySelectorAll(".modal .close-btn, .modal-overlay").forEach((e=>{e.addEventListener("click",(()=>{e.closest(".modal").classList.add("hidden")}))})),document.querySelectorAll(".tab-btn").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tab;document.querySelectorAll(".tab-btn").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),document.querySelectorAll(".tab-content").forEach((e=>e.classList.remove("active"))),document.getElementById(`tab-${t}`).classList.add("active")}))}));const r=document.getElementById("contribute-form");r&&r.addEventListener("submit",handleContribution)}async function handleContribution(e){e.preventDefault();const t=document.querySelector(".tab-content.active").id,n=new FormData(e.target),a=Object.fromEntries(n);try{let n,o;"tab-place"===t?(n=`${API_BASE}/places`,o={current_name:a.current_name,lat:parseFloat(a.lat),lng:parseFloat(a.lng),place_type:a.place_type}):"tab-name"===t?(n=`${API_BASE}/places/${a.place_id}/names`,o={name:a.name,name_native:a.name_native,year_start:a.year_start?parseInt(a.year_start):null,year_end:a.year_end?parseInt(a.year_end):null,used_by:a.used_by,source_title:a.source_title}):"tab-event"===t&&(n=`${API_BASE}/events`,o={name:a.event_name,description:a.description,event_type:a.event_type,year:parseInt(a.year),place_id:a.event_place_id?parseInt(a.event_place_id):null,source_title:a.event_source});const s=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(s.ok)showSuccess("Thank you for your contribution!"),document.getElementById("contribute-modal").classList.add("hidden"),e.target.reset(),loadPlacesForYear(state.currentYear),loadStats();else{showError((await s.json()).detail||"Failed to submit")}}catch(e){console.error("Contribution error:",e),showError("Failed to submit. Please try again.")}}function displaySampleData(){displayPlaces([{id:1,name:"Cape Town",native:"Kaapstad / //Hui !Gaeb",type:"city",lng:18.4241,lat:-33.9249},{id:2,name:"Johannesburg",native:"eGoli",type:"city",lng:28.0473,lat:-26.2041},{id:3,name:"Jerusalem",native:"Yerushalayim / Al-Quds",type:"city",lng:35.2137,lat:31.7683},{id:4,name:"Bethlehem",native:"Beit Lechem",type:"town",lng:35.2076,lat:31.7054},{id:5,name:"Durban",native:"eThekwini",type:"city",lng:31.0218,lat:-29.8587},{id:6,name:"Babylon",native:"Bab-ilim",type:"ancient_city",lng:44.4275,lat:32.5363}].map((e=>({type:"Feature",geometry:{type:"Point",coordinates:[e.lng,e.lat]},properties:{id:e.id,current_name:e.name,name_at_year:e.name,native_name:e.native,place_type:e.type,display_name:e.name}}))))}function initOrientationControls(){const e=document.getElementById("layers-list"),t=document.createElement("div");t.className="orientation-section collapsible-section",t.innerHTML=`\n        <div class="section-header" onclick="toggleSection(this)">\n            <h4>Map Orientation</h4>\n            <span class="section-toggle">‚ñº</span>\n        </div>\n        <div class="section-content">\n            <div class="orientation-options">\n                ${Object.entries(ORIENTATIONS).map((([e,t])=>`\n                    <label class="orientation-option" title="${t.description}">\n                        <input type="radio" name="orientation" value="${e}" ${state.orientation===e?"checked":""}>\n                        <span>${t.label}</span>\n                    </label>\n                `)).join("")}\n            </div>\n            <p style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem;">\n                Preference saved automatically\n            </p>\n        </div>\n    `,e.appendChild(t),t.querySelectorAll('input[name="orientation"]').forEach((e=>{e.addEventListener("change",(e=>{setOrientation(e.target.value)}))})),updateOrientationIndicator()}function setOrientation(e){if(!ORIENTATIONS[e])return;state.orientation=e,localStorage.setItem("mapOrientation",e);const t=ORIENTATIONS[e];state.map.easeTo({bearing:t.bearing,duration:1e3}),updateOrientationIndicator()}function updateOrientationIndicator(){const e=document.getElementById("orientation-indicator");if(e){const t=ORIENTATIONS[state.orientation];e.textContent=t.label,e.title=t.description}}function cycleOrientation(){const e=Object.keys(ORIENTATIONS),t=e.indexOf(state.orientation);setOrientation(e[(t+1)%e.length])}function initMapStyles(){const e=document.getElementById("layers-list"),t=document.createElement("div");t.className="style-section collapsible-section",t.innerHTML=`\n        <div class="section-header" onclick="toggleSection(this)">\n            <h4>Map Style</h4>\n            <span class="section-toggle">‚ñº</span>\n        </div>\n        <div class="section-content">\n            <div class="style-options">\n                ${Object.entries(MAP_STYLES).map((([e,t])=>`\n                    <label class="style-option" title="${t.description}">\n                        <input type="radio" name="mapStyle" value="${e}" ${state.mapStyle===e?"checked":""}>\n                        <span>${t.name}</span>\n                    </label>\n                `)).join("")}\n            </div>\n        </div>\n    `,e.insertBefore(t,e.firstChild),t.querySelectorAll('input[name="mapStyle"]').forEach((e=>{e.addEventListener("change",(e=>{setMapStyle(e.target.value)}))}))}function setMapStyle(e){if(!MAP_STYLES[e])return;state.mapStyle=e,localStorage.setItem("mapStyle",e);const t=MAP_STYLES[e];let n;n=t.url?t.url:buildRasterStyle(t),state.map.setStyle(n),state.map.once("style.load",(()=>{state.routing.waypoints.length>=2&&calculateRoute(),loadPlacesForYear(state.currentYear)}))}function initLegend(){const e=document.getElementById("map-container"),t=document.createElement("div");t.id="map-legend",t.className="map-legend draggable",t.innerHTML=`\n        <div class="legend-header panel-drag-handle">\n            <h4><span class="drag-icon">‚ãÆ‚ãÆ</span> Legend</h4>\n            <button class="legend-toggle" onclick="toggleLegend()">+</button>\n        </div>\n        <div class="legend-content" style="display: none;">\n            ${Object.entries(PLACE_CATEGORIES).map((([e,t])=>`\n                <div class="legend-item" data-category="${e}">\n                    <span class="legend-icon" style="background: ${t.color}">${t.icon}</span>\n                    <span class="legend-label">${t.name}</span>\n                    <span class="legend-count" id="legend-count-${e}"></span>\n                </div>\n            `)).join("")}\n        </div>\n    `,e.appendChild(t);const n=t.querySelector(".legend-header");makePanelDraggable(t,n,"legendPosition")}function toggleLegend(){const e=document.getElementById("map-legend"),t=e.querySelector(".legend-content"),n=e.querySelector(".legend-toggle");"none"===t.style.display?(t.style.display="block",n.textContent="‚àí"):(t.style.display="none",n.textContent="+")}function toggleTimeline(){const e=document.getElementById("timeline-panel"),t=e.querySelector(".timeline-slider-container"),n=e.querySelector(".timeline-presets"),a=document.getElementById("timeline-toggle");e.classList.contains("collapsed")?(e.classList.remove("collapsed"),t.style.display="flex",n.style.display="flex",a.textContent="‚àí"):(e.classList.add("collapsed"),t.style.display="none",n.style.display="none",a.textContent="+")}function initCategoryFilters(){const e=document.getElementById("layers-list"),t=document.createElement("div");t.className="filter-section collapsible-section",t.innerHTML=`\n        <div class="section-header" onclick="toggleSection(this)">\n            <h4>Show Categories</h4>\n            <span class="section-toggle">‚ñº</span>\n        </div>\n        <div class="section-content">\n            <div class="filter-options">\n                ${Object.entries(PLACE_CATEGORIES).map((([e,t])=>`\n                    <label class="filter-option">\n                        <input type="checkbox" name="categoryFilter" value="${e}"\n                               ${state.categoryFilters[e]?"checked":""}>\n                        <span class="filter-icon" style="background: ${t.color}">${t.icon}</span>\n                        <span class="filter-label">${t.name}</span>\n                    </label>\n                `)).join("")}\n            </div>\n            <div class="filter-actions">\n                <button class="btn btn-sm" onclick="selectAllCategories()">All</button>\n                <button class="btn btn-sm" onclick="selectNoCategories()">None</button>\n            </div>\n        </div>\n    `;const n=e.querySelector(".orientation-section");n?e.insertBefore(t,n):e.appendChild(t),t.querySelectorAll('input[name="categoryFilter"]').forEach((e=>{e.addEventListener("change",(e=>{setCategoryFilter(e.target.value,e.target.checked)}))}))}function setCategoryFilter(e,t){state.categoryFilters[e]=t,localStorage.setItem("categoryFilters",JSON.stringify(state.categoryFilters)),renderFilteredPlaces()}function selectAllCategories(){Object.keys(PLACE_CATEGORIES).forEach((e=>{state.categoryFilters[e]=!0;const t=document.querySelector(`input[value="${e}"]`);t&&(t.checked=!0)})),localStorage.setItem("categoryFilters",JSON.stringify(state.categoryFilters)),renderFilteredPlaces()}function selectNoCategories(){Object.keys(PLACE_CATEGORIES).forEach((e=>{state.categoryFilters[e]=!1;const t=document.querySelector(`input[value="${e}"]`);t&&(t.checked=!1)})),localStorage.setItem("categoryFilters",JSON.stringify(state.categoryFilters)),renderFilteredPlaces()}window.loadStreetView=loadStreetView,window.openStreetViewImage=openStreetViewImage,window.loadPlaceReviews=loadPlaceReviews,document.addEventListener("keydown",(e=>{"o"!==e.key&&"O"!==e.key||e.target.matches("input, textarea")||cycleOrientation()}));const transitState={enabled:!1,stops:[],routes:[],markers:[],routeLines:[]};function initTransitLayer(){const e=document.getElementById("layers-list"),t=document.createElement("div");t.className="filter-section collapsible-section",t.innerHTML='\n        <div class="section-header" onclick="toggleSection(this)">\n            <h4>üöå Public Transit</h4>\n            <span class="section-toggle">‚ñº</span>\n        </div>\n        <div class="section-content">\n            <label class="filter-option transit-toggle">\n                <input type="checkbox" id="transit-layer-toggle" onchange="toggleTransitLayer(this.checked)">\n                <span>Show Transit Stops & Routes</span>\n            </label>\n            <div id="transit-routes-list" class="transit-routes-list hidden">\n                <p class="transit-loading">Loading routes...</p>\n            </div>\n        </div>\n    ',e.appendChild(t);"true"===localStorage.getItem("transitLayerEnabled")&&(document.getElementById("transit-layer-toggle").checked=!0,toggleTransitLayer(!0))}async function toggleTransitLayer(e){transitState.enabled=e,localStorage.setItem("transitLayerEnabled",e),e?(await loadTransitData(),renderTransitLayer()):clearTransitLayer()}async function loadTransitData(){const e=document.getElementById("transit-routes-list");e.classList.remove("hidden"),e.innerHTML='<p class="transit-loading">Loading routes...</p>';try{const t=await fetch("/api/gtfs/routes"),n=await t.json();transitState.routes=n.routes||[],transitState.routes.length>0?e.innerHTML=`\n                <div class="transit-route-filters">\n                    ${transitState.routes.map((e=>`\n                        <label class="transit-route-item" style="border-left: 4px solid #${e.route_color||"888"}">\n                            <input type="checkbox" checked data-route-id="${e.route_id}" onchange="toggleTransitRoute('${e.route_id}', this.checked)">\n                            <span class="route-name">${e.route_short_name}</span>\n                            <span class="route-desc">${e.route_long_name}</span>\n                        </label>\n                    `)).join("")}\n                </div>\n            `:e.innerHTML='<p class="no-transit">No transit routes available in this area</p>',await loadTransitStops()}catch(t){e.innerHTML='<p class="transit-error">Could not load transit data</p>',console.error("Transit load error:",t)}}async function loadTransitStops(){const e=state.map.getBounds(),t=`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`;try{const e=await fetch(`/api/gtfs/stops?bbox=${t}`),n=await e.json();transitState.stops=n.stops||[]}catch(e){console.error("Could not load transit stops:",e),transitState.stops=[]}}function renderTransitLayer(){if(clearTransitLayer(),!transitState.enabled)return;const e=new Set;document.querySelectorAll("#transit-routes-list input[data-route-id]:checked").forEach((t=>{e.add(t.dataset.routeId)})),transitState.stops.forEach((t=>{const n=t.route_ids?t.route_ids.split(","):[];if(!(0===n.length||n.some((t=>e.has(t)))))return;const a=document.createElement("div");a.className="transit-stop-marker",a.innerHTML="üöè",a.title=t.stop_name;const o=new maplibregl.Popup({offset:25}).setHTML(`\n                <div class="transit-popup">\n                    <strong>üöè ${t.stop_name}</strong>\n                    ${t.route_names?`<p class="popup-routes">Routes: ${t.route_names}</p>`:""}\n                    ${1===t.wheelchair_boarding?'<span class="accessibility">‚ôø Accessible</span>':""}\n                </div>\n            `),s=new maplibregl.Marker({element:a}).setLngLat([t.stop_lon,t.stop_lat]).setPopup(o).addTo(state.map);transitState.markers.push(s)})),addTransitRouteLines(e)}function addTransitRouteLines(e){const t=[];transitState.routes.forEach((n=>{if(e.has(n.route_id)&&n.shape_coords)try{const e=JSON.parse(n.shape_coords);t.push({type:"Feature",properties:{route_id:n.route_id,route_name:n.route_short_name,color:`#${n.route_color||"0088ff"}`},geometry:{type:"LineString",coordinates:e}})}catch(e){}})),0!==t.length&&(state.map.getSource("transit-routes")?state.map.getSource("transit-routes").setData({type:"FeatureCollection",features:t}):(state.map.addSource("transit-routes",{type:"geojson",data:{type:"FeatureCollection",features:t}}),state.map.addLayer({id:"transit-routes-line",type:"line",source:"transit-routes",paint:{"line-color":["get","color"],"line-width":4,"line-opacity":.8}})))}function clearTransitLayer(){transitState.markers.forEach((e=>e.remove())),transitState.markers=[],state.map.getLayer("transit-routes-line")&&state.map.removeLayer("transit-routes-line"),state.map.getSource("transit-routes")&&state.map.removeSource("transit-routes")}function toggleTransitRoute(e,t){renderTransitLayer()}function setupTransitMapListeners(){state.map.on("moveend",(async()=>{transitState.enabled&&(await loadTransitStops(),renderTransitLayer())}))}window.toggleTransitLayer=toggleTransitLayer,window.toggleTransitRoute=toggleTransitRoute;const reportsState={enabled:!1,reports:[],markers:[],refreshInterval:null},REPORT_ICONS={traffic_jam:{icon:"üöó",color:"#ff4444",label:"Traffic Jam"},traffic_moderate:{icon:"üöô",color:"#ffaa00",label:"Moderate Traffic"},accident:{icon:"üí•",color:"#ff0000",label:"Accident"},hazard_road:{icon:"‚ö†Ô∏è",color:"#ff8800",label:"Road Hazard"},hazard_weather:{icon:"üåßÔ∏è",color:"#4488ff",label:"Weather Hazard"},police:{icon:"üëÆ",color:"#0066cc",label:"Police"},closure:{icon:"üöß",color:"#cc0000",label:"Road Closure"},construction:{icon:"üèóÔ∏è",color:"#ff6600",label:"Construction"},camera:{icon:"üì∑",color:"#666666",label:"Speed Camera"},fuel_price:{icon:"‚õΩ",color:"#00aa00",label:"Fuel Price"}};function initReportsLayer(){const e=document.getElementById("layers-list"),t=document.createElement("div");t.className="filter-section collapsible-section",t.innerHTML='\n        <div class="section-header" onclick="toggleSection(this)">\n            <h4>üö® Road Reports</h4>\n            <span class="section-toggle">‚ñº</span>\n        </div>\n        <div class="section-content">\n            <label class="filter-option reports-toggle">\n                <input type="checkbox" id="reports-layer-toggle" onchange="toggleReportsLayer(this.checked)">\n                <span>Show Live Road Reports</span>\n            </label>\n            <div id="reports-filter-list" class="reports-filter-list hidden">\n                <p class="reports-info">Live crowd-sourced reports</p>\n                <div class="report-type-filters">\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="traffic_jam" onchange="renderReportsLayer()">\n                        <span>üöó Traffic</span>\n                    </label>\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="accident" onchange="renderReportsLayer()">\n                        <span>üí• Accidents</span>\n                    </label>\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="hazard_road" onchange="renderReportsLayer()">\n                        <span>‚ö†Ô∏è Hazards</span>\n                    </label>\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="police" onchange="renderReportsLayer()">\n                        <span>üëÆ Police</span>\n                    </label>\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="closure" onchange="renderReportsLayer()">\n                        <span>üöß Closures</span>\n                    </label>\n                    <label class="report-type-item">\n                        <input type="checkbox" checked data-report-type="camera" onchange="renderReportsLayer()">\n                        <span>üì∑ Cameras</span>\n                    </label>\n                </div>\n                <p class="tagme-notice">\n                    <small>Submit reports via <strong>TagMe</strong> app</small>\n                </p>\n            </div>\n        </div>\n    ',e.appendChild(t);"true"===localStorage.getItem("reportsLayerEnabled")&&(document.getElementById("reports-layer-toggle").checked=!0,toggleReportsLayer(!0)),setupReportsMapListeners()}async function toggleReportsLayer(e){reportsState.enabled=e,localStorage.setItem("reportsLayerEnabled",e);const t=document.getElementById("reports-filter-list");e?(t?.classList.remove("hidden"),await loadReportsData(),renderReportsLayer(),reportsState.refreshInterval=setInterval((async()=>{reportsState.enabled&&(await loadReportsData(),renderReportsLayer())}),6e4)):(t?.classList.add("hidden"),clearReportsLayer(),reportsState.refreshInterval&&(clearInterval(reportsState.refreshInterval),reportsState.refreshInterval=null))}async function loadReportsData(){const e=state.map.getBounds(),t=`${e.getWest()},${e.getSouth()},${e.getEast()},${e.getNorth()}`;try{const e=await fetch(`${API_BASE}/reports/bbox?bbox=${t}`);if(e.ok){const t=await e.json();reportsState.reports=t.reports||[]}else console.error("Could not load road reports:",e.status),reportsState.reports=[]}catch(e){console.error("Could not load road reports:",e),reportsState.reports=[]}}function renderReportsLayer(){if(clearReportsLayer(),!reportsState.enabled)return;const e=new Set;document.querySelectorAll("#reports-filter-list input[data-report-type]:checked").forEach((t=>{e.add(t.dataset.reportType)})),e.has("traffic_jam")&&e.add("traffic_moderate"),e.has("hazard_road")&&e.add("hazard_weather"),reportsState.reports.forEach((t=>{if(!e.has(t.report_type))return;const n=REPORT_ICONS[t.report_type]||{icon:"üìç",color:"#888",label:"Report"},a=document.createElement("div");a.className="road-report-marker",a.innerHTML=n.icon,a.title=n.label,a.style.setProperty("--report-color",n.color);const o=formatTimeAgo(new Date(t.received_at)),s=new maplibregl.Popup({offset:25}).setHTML(`\n                <div class="report-popup">\n                    <div class="report-popup-header" style="border-left: 4px solid ${n.color}">\n                        <span class="report-icon">${n.icon}</span>\n                        <strong>${n.label}</strong>\n                    </div>\n                    ${t.description?`<p class="report-description">${escapeHtml(t.description)}</p>`:""}\n                    <div class="report-meta">\n                        <span class="report-time">üïê ${o}</span>\n                        ${t.severity>1?`<span class="report-severity">Severity: ${t.severity}/5</span>`:""}\n                    </div>\n                    <div class="report-confidence">\n                        <span class="confidence-score" title="Confidence based on verifications">\n                            ${t.confidence_score>=0?"üëç":"üëé"} ${t.confidence_score} confidence\n                        </span>\n                        <span class="verified-count">‚úì ${t.verified_count||0} verified</span>\n                    </div>\n                </div>\n            `),r=new maplibregl.Marker({element:a}).setLngLat([t.longitude,t.latitude]).setPopup(s).addTo(state.map);reportsState.markers.push(r)}))}function clearReportsLayer(){reportsState.markers.forEach((e=>e.remove())),reportsState.markers=[]}function formatTimeAgo(e){const t=Math.floor((new Date-e)/1e3);return t<60?"Just now":t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function setupReportsMapListeners(){state.map.on("moveend",(async()=>{reportsState.enabled&&(await loadReportsData(),renderReportsLayer())}))}function initRouting(){const e=document.querySelector(".header-right"),t=document.createElement("button");t.id="btn-route",t.className="btn btn-icon",t.title="Plan Route",t.innerHTML="<span>üß≠</span>",e.insertBefore(t,e.firstChild),t.addEventListener("click",toggleRoutingPanel),createRoutingPanel()}function createRoutingPanel(){const e=document.getElementById("map-container"),t=document.createElement("div");t.id="routing-panel",t.className="routing-panel hidden draggable",t.innerHTML='\n        <div class="routing-header panel-drag-handle">\n            <h3><span class="drag-icon">‚ãÆ‚ãÆ</span> Plan Route</h3>\n            <button class="panel-close-btn" onclick="toggleRoutingPanel()">&times;</button>\n        </div>\n        <div class="routing-content">\n            <div id="waypoints-list">\n                <div class="waypoint-input" data-index="0">\n                    <span class="waypoint-label">A</span>\n                    <input type="text" placeholder="Start location..." class="waypoint-search" data-index="0">\n                    <button class="btn-my-location" onclick="useMyLocation(0)" title="Use my current location">üìç</button>\n                    <button class="btn-remove-waypoint hidden" onclick="removeWaypoint(0)">&times;</button>\n                </div>\n                <div class="waypoint-input" data-index="1">\n                    <span class="waypoint-label">B</span>\n                    <input type="text" placeholder="End location..." class="waypoint-search" data-index="1">\n                    <button class="btn-my-location" onclick="useMyLocation(1)" title="Use my current location">üìç</button>\n                    <button class="btn-remove-waypoint hidden" onclick="removeWaypoint(1)">&times;</button>\n                </div>\n            </div>\n            <button id="btn-add-waypoint" class="btn btn-secondary btn-sm">+ Add Stop</button>\n            <div class="routing-actions">\n                <button id="btn-calculate-route" class="btn btn-primary">Get Directions</button>\n                <button id="btn-clear-route" class="btn btn-secondary">Clear</button>\n            </div>\n            <div id="route-info" class="route-info hidden">\n                <div class="route-summary">\n                    <span id="route-distance"></span> ‚Ä¢ <span id="route-duration"></span>\n                    <span id="route-traffic-eta" class="traffic-eta hidden"></span>\n                </div>\n                <div id="route-traffic-alerts" class="route-traffic-alerts hidden"></div>\n                <div class="voice-controls">\n                    <select id="voice-style" class="voice-style-select">\n                        <option value="default">üéôÔ∏è Standard</option>\n                        <option value="friendly">üòä Friendly</option>\n                        <option value="pirate">üè¥‚Äç‚ò†Ô∏è Pirate</option>\n                        <option value="robot">ü§ñ Robot</option>\n                        <option value="zen">üßò Zen</option>\n                        <option value="sports">üí™ Coach</option>\n                    </select>\n                    <button id="btn-play-directions" class="btn btn-sm btn-voice" onclick="playDirections()" title="Play directions">\n                        üîä Play\n                    </button>\n                    <button id="btn-stop-directions" class="btn btn-sm btn-voice hidden" onclick="stopDirections()" title="Stop">\n                        ‚èπÔ∏è Stop\n                    </button>\n                </div>\n                <div id="route-steps" class="route-steps"></div>\n            </div>\n        </div>\n    ',e.appendChild(t),document.getElementById("btn-add-waypoint").addEventListener("click",addWaypoint),document.getElementById("btn-calculate-route").addEventListener("click",calculateRoute),document.getElementById("btn-clear-route").addEventListener("click",clearRoute),setupWaypointSearch();const n=t.querySelector(".routing-header");makePanelDraggable(t,n,"routingPanelPosition")}function toggleRoutingPanel(){const e=document.getElementById("routing-panel");e.classList.toggle("hidden"),state.routing.active=!e.classList.contains("hidden")}function setupWaypointSearch(){document.querySelectorAll(".waypoint-search").forEach((e=>{let t;e.addEventListener("input",(e=>{clearTimeout(t);const n=e.target.value.trim(),a=parseInt(e.target.dataset.index);n.length<2||(t=setTimeout((()=>searchForWaypoint(n,a,e.target)),300))})),e.addEventListener("focus",(e=>{const t=e.target.parentElement.querySelector(".waypoint-dropdown");t&&t.classList.remove("hidden")}))})),document.addEventListener("click",(e=>{e.target.closest(".waypoint-input")||document.querySelectorAll(".waypoint-dropdown").forEach((e=>e.classList.add("hidden")))}))}async function searchForWaypoint(e,t,n){try{const a=[];try{const t=await fetch(`${API_BASE}/search?q=${encodeURIComponent(e)}`);if(t.ok){const e=await t.json();a.push(...(e.results||[]).map((e=>({...e,source:"local"}))))}}catch(e){console.warn("Local search failed:",e)}const o=await searchNominatim(e);showWaypointDropdown([...a,...o],t,n)}catch(e){console.error("Waypoint search error:",e)}}async function searchNominatim(e){try{const t=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&limit=5&addressdetails=1`,n=await fetch(t,{headers:{"User-Agent":"HistoricalMapsApp/1.0"}});if(!n.ok)return[];return(await n.json()).map((e=>({current_name:e.display_name.split(",").slice(0,3).join(","),full_address:e.display_name,lat:parseFloat(e.lat),lng:parseFloat(e.lon),place_type:e.type||e.class||"address",source:"nominatim"})))}catch(e){return console.warn("Nominatim search failed:",e),[]}}function showWaypointDropdown(e,t,n){const a=n.parentElement.querySelector(".waypoint-dropdown");if(a&&a.remove(),0===e.length)return;const o=document.createElement("div");o.className="waypoint-dropdown",e.slice(0,8).forEach(((e,n)=>{const a=document.createElement("div");a.className="waypoint-option";const s=document.createElement("span");s.className="waypoint-option-name",s.textContent=e.current_name||e.matched_name;const r=document.createElement("span");r.className="waypoint-option-meta";const i=document.createElement("span");if(i.className="waypoint-option-type",i.textContent=e.place_type,r.appendChild(i),"nominatim"===e.source){const e=document.createElement("span");e.className="source-osm",e.title="OpenStreetMap",e.textContent="OSM",r.appendChild(e)}a.appendChild(s),a.appendChild(r),a.addEventListener("click",(()=>{selectWaypoint(t,e.lng,e.lat,e.current_name||e.matched_name)})),o.appendChild(a)})),n.parentElement.appendChild(o)}function selectWaypoint(e,t,n,a){for(;state.routing.waypoints.length<=e;)state.routing.waypoints.push(null);state.routing.waypoints[e]={lng:t,lat:n,name:a};const o=document.querySelector(`.waypoint-search[data-index="${e}"]`);o&&(o.value=a),document.querySelectorAll(".waypoint-dropdown").forEach((e=>e.remove())),addWaypointMarker(e,t,n,a)}function addWaypointMarker(e,t,n,a){state.routing.markers[e]&&state.routing.markers[e].remove();const o=document.createElement("div");o.className="waypoint-marker",o.innerHTML="ABCDEFGHIJ"[e]||"+",o.style.cssText="\n        width: 28px;\n        height: 28px;\n        background: #FF3B30;\n        color: white;\n        border-radius: 50%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: bold;\n        font-size: 14px;\n        border: 2px solid white;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n    ";const s=new maplibregl.Marker({element:o}).setLngLat([t,n]).setPopup(new maplibregl.Popup({offset:15}).setText(a)).addTo(state.map);state.routing.markers[e]=s}function addWaypoint(){const e=document.getElementById("waypoints-list"),t=e.children.length,n=document.createElement("div");n.className="waypoint-input",n.dataset.index=t,n.innerHTML=`\n        <span class="waypoint-label">${"ABCDEFGHIJ"[t]||"+"}</span>\n        <input type="text" placeholder="Add stop..." class="waypoint-search" data-index="${t}">\n        <button class="btn-my-location" onclick="useMyLocation(${t})" title="Use my current location">üìç</button>\n        <button class="btn-remove-waypoint" onclick="removeWaypoint(${t})">&times;</button>\n    `,e.appendChild(n),setupWaypointSearch(),e.children.length>2&&e.querySelectorAll(".btn-remove-waypoint").forEach((e=>e.classList.remove("hidden")))}async function useMyLocation(e){const t=document.querySelector(`.waypoint-input[data-index="${e}"] .btn-my-location`),n=document.querySelector(`.waypoint-search[data-index="${e}"]`);if(navigator.geolocation){t&&(t.innerHTML="‚è≥"),n&&(n.placeholder="Getting location...");try{const t=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})),n=t.coords.latitude,a=t.coords.longitude;let o="My Location";try{const e=await fetch(`${API_BASE}/reverse-geocode?lat=${n}&lng=${a}`);if(e.ok){const t=await e.json();t.address&&(o=t.address.split(",").slice(0,2).join(", "))}}catch(e){console.warn("Reverse geocode failed, using default name")}selectWaypoint(e,a,n,o),state.map.flyTo({center:[a,n],zoom:14}),showSuccess("Location detected")}catch(t){let a="Could not get your location";1===t.code?a="Location access denied. Please enable location permissions.":2===t.code?a="Location unavailable. Please try again.":3===t.code&&(a="Location request timed out. Please try again."),showError(a),n&&(n.placeholder=0===e?"Start location...":"End location...")}finally{t&&(t.innerHTML="üìç")}}else showError("Geolocation is not supported by your browser")}function removeWaypoint(e){const t=document.getElementById("waypoints-list"),n=t.querySelector(`[data-index="${e}"]`);n&&t.children.length>2&&(n.remove(),state.routing.markers[e]&&(state.routing.markers[e].remove(),state.routing.markers.splice(e,1)),state.routing.waypoints.splice(e,1),reindexWaypoints())}function reindexWaypoints(){const e=document.getElementById("waypoints-list");Array.from(e.children).forEach(((e,t)=>{e.dataset.index=t,e.querySelector(".waypoint-label").textContent="ABCDEFGHIJ"[t]||"+",e.querySelector(".waypoint-search").dataset.index=t;const n=e.querySelector(".btn-remove-waypoint");n&&n.setAttribute("onclick",`removeWaypoint(${t})`)}))}async function calculateRoute(){const e=state.routing.waypoints.filter((e=>null!==e));if(e.length<2)return void showWarning("Please select at least a start and end location");const t=document.getElementById("btn-calculate-route"),n=t.textContent;t.textContent="Calculating...",t.disabled=!0;const a=e.map((e=>`${e.lng},${e.lat}`)).join(";"),o=e.map((e=>[e.lng,e.lat]));let s=null,r="";try{const e=await fetch(`https://router.project-osrm.org/route/v1/driving/${a}?overview=full&geometries=geojson&steps=true`,{signal:AbortSignal.timeout(1e4)});if(e.ok){const t=await e.json();"Ok"===t.code&&t.routes&&t.routes.length&&(s=t.routes[0],r="osrm")}}catch(e){console.log("OSRM failed, trying fallback...",e.message)}if(!s)try{const e=await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coordinates:o}),signal:AbortSignal.timeout(15e3)});if(e.ok){const t=await e.json();if(t.features&&t.features.length){const e=t.features[0];s={geometry:e.geometry,distance:e.properties.summary?.distance||0,duration:e.properties.summary?.duration||0,legs:[{steps:e.properties.segments?.[0]?.steps?.map((e=>({maneuver:{instruction:e.instruction},distance:e.distance})))||[]}]},r="openrouteservice"}}}catch(e){console.log("OpenRouteService also failed:",e.message)}t.textContent=n,t.disabled=!1,s?(displayRoute(s),"openrouteservice"===r&&showInfo("Route calculated via OpenRouteService")):showError("Could not calculate route. The locations may be too far apart or not connected by roads.")}async function displayRoute(e){state.map.getLayer("route")&&state.map.removeLayer("route"),state.map.getSource("route")&&state.map.removeSource("route"),state.map.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:e.geometry}}),state.map.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#007AFF","line-width":5,"line-opacity":.8}});const t=e.geometry.coordinates,n=t.reduce(((e,t)=>e.extend(t)),new maplibregl.LngLatBounds(t[0],t[0]));state.map.fitBounds(n,{padding:50});const a=(e.distance/1e3).toFixed(1),o=Math.round(e.duration/60),s=Math.floor(o/60),r=o%60;document.getElementById("route-distance").textContent=`${a} km`,document.getElementById("route-duration").textContent=s>0?`${s}h ${r}m`:`${r} min`;const i=e.legs.flatMap((e=>e.steps));document.getElementById("route-steps").innerHTML=i.map(((e,t)=>`\n        <div class="route-step">\n            <span class="step-number">${t+1}</span>\n            <span class="step-instruction">${e.maneuver.instruction||e.name}</span>\n            <span class="step-distance">${(e.distance/1e3).toFixed(1)} km</span>\n        </div>\n    `)).join(""),document.getElementById("route-info").classList.remove("hidden"),await fetchRouteTrafficAlerts(e,o)}window.toggleReportsLayer=toggleReportsLayer,window.renderReportsLayer=renderReportsLayer,window.useMyLocation=useMyLocation;const TRAFFIC_DELAYS={traffic_jam:{base:10,perSeverity:5},traffic_moderate:{base:3,perSeverity:2},accident:{base:15,perSeverity:8},hazard_road:{base:2,perSeverity:1},hazard_weather:{base:5,perSeverity:3},police:{base:1,perSeverity:0},closure:{base:20,perSeverity:10},construction:{base:5,perSeverity:3},camera:{base:0,perSeverity:0}};async function fetchRouteTrafficAlerts(e,t){const n=document.getElementById("route-traffic-eta"),a=document.getElementById("route-traffic-alerts"),o=e.geometry.coordinates,s=[];let r=0;for(let e=0;e<o.length;e+=10)(0===e||e>=r+10)&&(s.push(`${o[e][0]},${o[e][1]}`),r=e);if(0===s.length||o.length>0){const e=o[o.length-1];s.push(`${e[0]},${e[1]}`)}const i=s.slice(0,20).join(";");try{const e=await fetch(`${API_BASE}/reports/route?waypoints=${encodeURIComponent(i)}&buffer_km=2`);if(!e.ok)return n.classList.add("hidden"),void a.classList.add("hidden");const o=(await e.json()).reports||[];if(0===o.length)return n.classList.add("hidden"),a.innerHTML='<div class="no-traffic-alerts">‚úì No incidents reported on this route</div>',void a.classList.remove("hidden");let s=0;const r={};if(o.forEach((e=>{const t=TRAFFIC_DELAYS[e.report_type];if(t){const n=t.base+t.perSeverity*(e.severity-1);s+=n}r[e.report_type]||(r[e.report_type]=[]),r[e.report_type].push(e)})),s>0){const e=t+s,a=Math.floor(e/60),o=e%60,r=a>0?`${a}h ${o}m`:`${o} min`;n.innerHTML=`<span class="traffic-delay-indicator">üö¶ +${s} min traffic</span> ‚Üí <strong>${r}</strong>`,n.classList.remove("hidden")}else n.classList.add("hidden");let l='<div class="traffic-alerts-header">‚ö†Ô∏è Road alerts on route:</div>';l+='<div class="traffic-alerts-list">',Object.entries(r).forEach((([e,t])=>{const n=REPORT_ICONS[e]||{icon:"üìç",label:"Report"},a=t.length;l+=`\n                <div class="traffic-alert-item" style="border-left: 3px solid ${n.color}">\n                    <span class="alert-icon">${n.icon}</span>\n                    <span class="alert-text">${n.label}</span>\n                    <span class="alert-count">${a>1?`√ó${a}`:""}</span>\n                </div>\n            `})),l+="</div>",l+='<p class="tagme-notice"><small>Report incidents via <strong>TagMe</strong> app</small></p>',a.innerHTML=l,a.classList.remove("hidden")}catch(e){console.error("Could not fetch traffic alerts:",e),n.classList.add("hidden"),a.classList.add("hidden")}}function clearRoute(){state.map.getLayer("route-line")&&state.map.removeLayer("route-line"),state.map.getLayer("route")&&state.map.removeLayer("route"),state.map.getSource("route")&&state.map.removeSource("route"),state.routing.markers.forEach((e=>e&&e.remove())),state.routing.markers=[],state.routing.waypoints=[],document.querySelectorAll(".waypoint-search").forEach((e=>{e.value=""}));const e=document.getElementById("waypoints-list");for(;e.children.length>2;)e.lastChild.remove();document.getElementById("route-info").classList.add("hidden"),document.getElementById("route-traffic-eta")?.classList.add("hidden"),document.getElementById("route-traffic-alerts")?.classList.add("hidden"),e.querySelectorAll(".btn-remove-waypoint").forEach((e=>e.classList.add("hidden")))}const POI_CATEGORIES={accommodation:{icon:"üè®",label:"Accommodation",color:"#8B5CF6",overpass:'tourism~"hotel|hostel|motel|guest_house|bed_and_breakfast|apartment"'},fuel:{icon:"‚õΩ",label:"Fuel Stations",color:"#EF4444",overpass:"amenity=fuel"},restaurant:{icon:"üçΩÔ∏è",label:"Restaurants",color:"#F59E0B",overpass:'amenity~"restaurant|fast_food|cafe"'},atm:{icon:"üèß",label:"ATMs & Banks",color:"#10B981",overpass:'amenity~"atm|bank"'},hospital:{icon:"üè•",label:"Medical",color:"#EF4444",overpass:'amenity~"hospital|clinic|pharmacy|doctors"'},parking:{icon:"üÖøÔ∏è",label:"Parking",color:"#3B82F6",overpass:"amenity=parking"},shopping:{icon:"üõí",label:"Shopping",color:"#EC4899",overpass:'shop~"supermarket|mall|convenience"'},attractions:{icon:"üé≠",label:"Attractions",color:"#8B5CF6",overpass:'tourism~"attraction|museum|viewpoint|artwork"'}},AD_PIN_TEMPLATES=[{id:"ad-1",name:"Oceanview Restaurant & Bar",latOffset:.005,lngOffset:.003,icon:"üçΩÔ∏è",category:"restaurant",description:"Fine dining with stunning views",address:"Premium Location"},{id:"ad-2",name:"City Central Hotel",latOffset:-.004,lngOffset:.006,icon:"üè®",category:"accommodation",description:"Luxury accommodation in the heart of the city",address:"Central Business District"},{id:"ad-3",name:"AutoFix Service Center",latOffset:.003,lngOffset:-.005,icon:"üîß",category:"services",description:"Professional vehicle servicing and repairs",address:"Conveniently Located"},{id:"ad-4",name:"FreshMart Supermarket",latOffset:-.006,lngOffset:-.004,icon:"üõí",category:"shopping",description:"Fresh groceries and daily essentials",address:"Your Neighborhood"}];function getAdPinsAlongRoute(e){if(!e||e.length<2)return[];const t=e.length;return[Math.floor(.25*t),Math.floor(.75*t)].map(((n,a)=>{const o=e[Math.min(n,t-1)];return{...AD_PIN_TEMPLATES[a%AD_PIN_TEMPLATES.length],id:`route-ad-${a}`,lng:o[0]+.001,lat:o[1]+.001}}))}function addRouteAdMarkers(e){getAdPinsAlongRoute(e).forEach((e=>{const t=document.createElement("div");t.className="ad-marker-container",t.innerHTML=`\n            <div class="ad-marker">\n                <div class="ad-marker-icon">${e.icon}</div>\n                <div class="ad-marker-badge">Ad</div>\n            </div>\n            <div class="ad-marker-label">\n                <div class="ad-label-name">${e.name}</div>\n                <div class="ad-label-description">${e.description}</div>\n                <div class="ad-label-promo">Highlight Your Business with <a href="https://www.bidbaas.co.za" target="_blank" rel="noopener">Bid Baas</a></div>\n                <button class="ad-label-directions" onclick="event.stopPropagation(); getDirectionsTo(${e.lng}, ${e.lat}, '${e.name.replace(/'/g,"\\'")}')">Get Directions</button>\n            </div>\n        `;const n=new maplibregl.Marker({element:t,anchor:"bottom"}).setLngLat([e.lng,e.lat]).addTo(state.map);state.routing.markers.push(n),console.log("Route ad marker added:",e.name,"at",e.lat,e.lng)}))}function initNearby(){const e=document.getElementById("map"),t=document.querySelector(".header-right");if(t){const e=document.createElement("button");e.id="btn-nearby",e.className="btn btn-icon",e.innerHTML="<span>üìç</span>",e.title="What's Nearby",e.onclick=toggleNearbyPanel;const n=document.getElementById("btn-refresh");n?t.insertBefore(e,n):t.appendChild(e)}const n=document.createElement("div");n.id="nearby-panel",n.className="nearby-panel hidden draggable",n.innerHTML=`\n        <div class="nearby-header panel-drag-handle">\n            <h3><span class="drag-icon">‚ãÆ‚ãÆ</span> What's Nearby</h3>\n            <div class="nearby-header-controls">\n                <button class="nearby-collapse-btn" onclick="collapseNearbyPanel()" title="Collapse/Expand">‚àí</button>\n                <button class="panel-close-btn" onclick="toggleNearbyPanel()">&times;</button>\n            </div>\n        </div>\n        <div class="nearby-content">\n            <div class="nearby-location">\n                <button id="btn-use-my-location" class="btn btn-primary btn-sm">\n                    <span>üìç</span> Use My Location\n                </button>\n                <span class="nearby-location-text" id="nearby-location-text">or click on map</span>\n            </div>\n            <div class="nearby-radius">\n                <label>Search radius:</label>\n                <select id="nearby-radius">\n                    <option value="500">500m</option>\n                    <option value="1000">1km</option>\n                    <option value="2000" selected>2km</option>\n                    <option value="5000">5km</option>\n                    <option value="10000">10km</option>\n                </select>\n            </div>\n            <div class="nearby-categories-wrapper">\n                <button type="button" class="nearby-categories-toggle" id="nearby-categories-toggle">\n                    <span>Categories <span class="nearby-categories-count" id="nearby-categories-count">0</span></span>\n                    <span class="toggle-arrow">‚ñº</span>\n                </button>\n                <div class="nearby-categories" id="nearby-categories">\n                    ${Object.entries(POI_CATEGORIES).map((([e,t])=>`\n                        <label class="nearby-category">\n                            <input type="checkbox" value="${e}" onchange="toggleNearbyCategory('${e}')">\n                            <span class="category-icon">${t.icon}</span>\n                            <span class="category-label">${t.label}</span>\n                        </label>\n                    `)).join("")}\n                </div>\n            </div>\n            <div id="nearby-validation" class="nearby-validation warning">\n                <span class="validation-icon">‚ÑπÔ∏è</span>\n                <span id="nearby-validation-text">Select a location and at least one category</span>\n            </div>\n            <div class="nearby-actions">\n                <button id="btn-search-nearby" class="btn btn-primary" disabled>Search</button>\n                <button id="btn-clear-nearby" class="btn btn-secondary">Clear</button>\n            </div>\n            <div id="nearby-results" class="nearby-results hidden">\n                <div class="nearby-results-header">\n                    <span id="nearby-results-count">0 results</span>\n                </div>\n                <div id="nearby-results-list" class="nearby-results-list"></div>\n            </div>\n            <div id="nearby-loading" class="nearby-loading hidden">\n                <div class="loading-spinner"></div>\n                <span class="loading-text">Searching nearby places...</span>\n                <div class="loading-progress">\n                    <div class="loading-progress-bar"></div>\n                </div>\n            </div>\n        </div>\n    `,e.appendChild(n),document.getElementById("btn-use-my-location").addEventListener("click",useMyLocation),document.getElementById("btn-search-nearby").addEventListener("click",searchNearby),document.getElementById("btn-clear-nearby").addEventListener("click",clearNearby),document.getElementById("nearby-radius").addEventListener("change",(e=>{state.nearby.radius=parseInt(e.target.value)})),document.getElementById("nearby-categories-toggle").addEventListener("click",(()=>{const e=document.getElementById("nearby-categories-toggle"),t=document.getElementById("nearby-categories");e.classList.toggle("open"),t.classList.toggle("open")}));const a=n.querySelector(".nearby-header");if(makePanelDraggable(n,a,"nearbyPanelPosition"),state.map){const e=()=>{state.map.on("click",(e=>{state.nearby.active&&setNearbyCenter(e.lngLat.lng,e.lngLat.lat)}))};state.map.loaded()?e():state.map.on("load",e)}}function toggleNearbyPanel(){const e=document.getElementById("nearby-panel");e.classList.toggle("hidden"),state.nearby.active=!e.classList.contains("hidden")}function collapseNearbyPanel(){const e=document.getElementById("nearby-panel"),t=e.querySelector(".nearby-content"),n=e.querySelector(".nearby-collapse-btn");e.classList.contains("collapsed")?(e.classList.remove("collapsed"),t.style.display="block",n.textContent="‚àí"):(e.classList.add("collapsed"),t.style.display="none",n.textContent="+")}function useMyLocation(){"geolocation"in navigator?navigator.geolocation.getCurrentPosition((e=>{setNearbyCenter(e.coords.longitude,e.coords.latitude),state.map.flyTo({center:[e.coords.longitude,e.coords.latitude],zoom:14})}),(e=>{console.error("Geolocation error:",e),alert("Could not get your location. Please click on the map instead.")})):alert("Geolocation is not supported by your browser. Please click on the map instead.")}function setNearbyCenter(e,t){state.nearby.center={lng:e,lat:t};document.getElementById("nearby-location-text").textContent=`${t.toFixed(4)}, ${e.toFixed(4)}`,state.nearby.centerMarker&&state.nearby.centerMarker.remove();const n=document.createElement("div");n.className="nearby-center-marker",n.innerHTML="üìç",n.style.cssText="font-size: 24px; cursor: pointer;";const a=new maplibregl.Popup({offset:25,className:"nearby-center-popup"}).setHTML(`\n        <div class="center-popup-content">\n            <div class="center-popup-title">You Are Here</div>\n            <div class="center-popup-coords">${t.toFixed(5)}, ${e.toFixed(5)}</div>\n            <div class="center-popup-address" id="center-popup-address">\n                <span class="address-loading">Loading address...</span>\n            </div>\n        </div>\n    `);state.nearby.centerMarker=new maplibregl.Marker({element:n}).setLngLat([e,t]).setPopup(a).addTo(state.map),state.nearby.centerMarker.togglePopup(),reverseGeocode(t,e),updateNearbySearchButton()}async function reverseGeocode(e,t){reverseGeocodeElement(e,t,"center-popup-address")}async function reverseGeocodeElement(e,t,n){try{const a=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}&zoom=18&addressdetails=1`,{headers:{"Accept-Language":"en"}}),o=await a.json(),s=document.getElementById(n);if(s&&o.display_name){const e=[];o.address&&(o.address.road&&e.push(escapeHtml(o.address.road)),o.address.suburb&&e.push(escapeHtml(o.address.suburb)),(o.address.city||o.address.town||o.address.village)&&e.push(escapeHtml(o.address.city||o.address.town||o.address.village)));const t=e.length>0?e.join(", "):escapeHtml(o.display_name.split(",").slice(0,3).join(", "));s.innerHTML=`<span class="address-text">${t}</span>`}}catch(e){const t=document.getElementById(n);t&&(t.innerHTML='<span class="address-error">Address unavailable</span>')}}function toggleNearbyCategory(e){document.querySelector(`#nearby-categories input[value="${e}"]`).checked?state.nearby.activeCategories.push(e):state.nearby.activeCategories=state.nearby.activeCategories.filter((t=>t!==e)),updateNearbyCategoryCount(),updateNearbySearchButton()}function updateNearbyCategoryCount(){const e=state.nearby.activeCategories.length,t=document.getElementById("nearby-categories-count");t&&(t.textContent=e,t.style.display=e>0?"inline":"none")}function updateNearbySearchButton(){const e=document.getElementById("btn-search-nearby"),t=document.getElementById("nearby-validation"),n=document.getElementById("nearby-validation-text"),a=t?.querySelector(".validation-icon"),o=!!state.nearby.center,s=state.nearby.activeCategories.length>0,r=o&&s;e.disabled=!r,t&&n&&(r?(t.classList.add("valid"),t.classList.remove("warning"),a.textContent="‚úì",n.textContent="Ready to search"):o||s?o?(t.classList.remove("valid"),t.classList.add("warning"),a.textContent="‚òëÔ∏è",n.textContent="Select at least one category"):(t.classList.remove("valid"),t.classList.add("warning"),a.textContent="üìç",n.textContent="Click on map or use your location"):(t.classList.remove("valid"),t.classList.add("warning"),a.textContent="‚ÑπÔ∏è",n.textContent="Select a location and at least one category"))}async function searchNearby(){if(!state.nearby.center||0===state.nearby.activeCategories.length)return;const e=document.getElementById("nearby-loading"),t=document.getElementById("nearby-results");e.classList.remove("hidden"),t.classList.add("hidden"),clearNearbyMarkers();const n=[];for(const e of state.nearby.activeCategories){const t=POI_CATEGORIES[e];try{const a=await queryOverpass(state.nearby.center.lat,state.nearby.center.lng,state.nearby.radius,t.overpass);a.forEach((n=>{n.category=e,n.categoryInfo=t})),n.push(...a)}catch(t){console.error(`Error fetching ${e}:`,t)}}n.sort(((e,t)=>e.distance-t.distance)),displayNearbyResults(n),e.classList.add("hidden"),t.classList.remove("hidden")}async function queryOverpass(e,t,n,a){const o=`\n        [out:json][timeout:25];\n        (\n            node[${a}](around:${n},${e},${t});\n            way[${a}](around:${n},${e},${t});\n        );\n        out center;\n    `;try{const n=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:`data=${encodeURIComponent(o)}`});if(!n.ok)throw new Error("Overpass API error");return(await n.json()).elements.map((n=>{const a=n.lat||n.center?.lat,o=n.lon||n.center?.lon,s=calculateDistance(e,t,a,o);return{id:n.id,name:n.tags?.name||n.tags?.brand||"Unnamed",lat:a,lng:o,distance:s,tags:n.tags||{}}})).filter((e=>e.lat&&e.lng))}catch(e){return console.error("Overpass query failed:",e),[]}}function calculateDistance(e,t,n,a){const o=(n-e)*Math.PI/180,s=(a-t)*Math.PI/180,r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371e3*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function displayNearbyResults(e){const t=document.getElementById("nearby-results-count"),n=document.getElementById("nearby-results-list");t.textContent=`${e.length} results found`,n.innerHTML="",e.slice(0,50).forEach((e=>{const t=e.distance<1e3?`${Math.round(e.distance)}m`:`${(e.distance/1e3).toFixed(1)}km`,a=e.tags.opening_hours||"",o=[];if(e.tags["addr:street"]){let t=e.tags["addr:housenumber"]?`${e.tags["addr:housenumber"]} ${e.tags["addr:street"]}`:e.tags["addr:street"];o.push(t)}e.tags["addr:suburb"]?o.push(e.tags["addr:suburb"]):e.tags["addr:city"]&&o.push(e.tags["addr:city"]);const s=o.join(", "),r=document.createElement("div");r.className="nearby-result";const i=document.createElement("div");i.className="nearby-result-main",i.addEventListener("click",(()=>flyToNearbyPoi(e.lng,e.lat,e.name)));const l=document.createElement("span");l.className="result-icon",l.textContent=e.categoryInfo.icon;const c=document.createElement("div");c.className="result-info";const d=document.createElement("div");if(d.className="result-name",d.textContent=e.name,c.appendChild(d),s){const e=document.createElement("div");e.className="result-location",e.textContent=s,c.appendChild(e)}const p=document.createElement("div");p.className="result-meta";const u=document.createElement("span");if(u.className="result-distance",u.textContent=t,p.appendChild(u),a){const e=document.createElement("span");e.className="result-hours",e.textContent=a,p.appendChild(e)}c.appendChild(p),i.appendChild(l),i.appendChild(c);const m=document.createElement("button");m.className="nearby-directions-btn",m.title="Get directions",m.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg>',m.addEventListener("click",(t=>{t.stopPropagation(),getDirectionsTo(e.lng,e.lat,e.name)})),r.appendChild(i),r.appendChild(m),n.appendChild(r)})),e.slice(0,50).forEach((e=>{addNearbyMarker(e)}))}function addAdMarker(e){const t=document.createElement("div");t.className="ad-marker-container";const n=document.createElement("div");n.className="ad-marker";const a=document.createElement("div");a.className="ad-marker-icon",a.textContent=e.icon;const o=document.createElement("div");o.className="ad-marker-badge",o.textContent="Ad",n.appendChild(a),n.appendChild(o);const s=document.createElement("div");s.className="ad-marker-label";const r=document.createElement("div");r.className="ad-label-name",r.textContent=e.name;const i=document.createElement("div");i.className="ad-label-description",i.textContent=e.description;const l=document.createElement("div");l.className="ad-label-promo",l.innerHTML='Highlight Your Business with <a href="https://www.bidbaas.co.za" target="_blank" rel="noopener">Bid Baas</a>';const c=document.createElement("button");c.className="ad-label-directions",c.textContent="Get Directions",c.addEventListener("click",(t=>{t.stopPropagation(),getDirectionsTo(e.lng,e.lat,e.name)})),s.appendChild(r),s.appendChild(i),s.appendChild(l),s.appendChild(c),t.appendChild(n),t.appendChild(s);const d=new maplibregl.Marker({element:t,anchor:"bottom"}).setLngLat([e.lng,e.lat]).addTo(state.map);state.nearby.markers.push(d),console.log("Ad marker added:",e.name,"at",e.lat,e.lng)}function addNearbyMarker(e){const t=document.createElement("div");t.className="nearby-marker",t.innerHTML=e.categoryInfo.icon,t.style.cssText=`\n        font-size: 20px;\n        cursor: pointer;\n        background: white;\n        border-radius: 50%;\n        width: 30px;\n        height: 30px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.3);\n        border: 2px solid ${e.categoryInfo.color};\n    `;const n=new maplibregl.Marker({element:t}).setLngLat([e.lng,e.lat]).setPopup(new maplibregl.Popup({offset:25}).setHTML(`\n            <strong>${e.name}</strong><br>\n            <em>${e.categoryInfo.label}</em><br>\n            ${e.tags.opening_hours?`<small>Hours: ${e.tags.opening_hours}</small><br>`:""}\n            ${e.tags.phone?`<small>Phone: ${e.tags.phone}</small>`:""}\n        `)).addTo(state.map);state.nearby.markers.push(n)}function flyToNearbyPoi(e,t,n){state.map.flyTo({center:[e,t],zoom:17,duration:1500})}async function getDirectionsTo(e,t,n){if(!state.nearby.center)return void showWarning("No origin location set");clearRoute();const a=state.nearby.center,o=`${a.lng},${a.lat};${e},${t}`;showRouteLoading(!0);try{const s=await fetch(`https://router.project-osrm.org/route/v1/driving/${o}?overview=full&geometries=geojson&steps=true`,{signal:AbortSignal.timeout(1e4)});if(s.ok){const o=await s.json();if("Ok"===o.code&&o.routes&&o.routes.length){return void displayDirectRoute(o.routes[0],a,{lng:e,lat:t,name:n})}}}catch(e){console.log("OSRM failed, trying fallback...",e.message)}try{const o=await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coordinates:[[a.lng,a.lat],[e,t]]}),signal:AbortSignal.timeout(15e3)});if(o.ok){const s=await o.json();if(s.features&&s.features.length){const o=s.features[0];return void displayDirectRoute({geometry:o.geometry,distance:o.properties.summary.distance,duration:o.properties.summary.duration},a,{lng:e,lat:t,name:n})}}}catch(e){console.log("ORS also failed",e.message)}showWarning("Could not calculate route"),showRouteLoading(!1)}function showRouteLoading(e){document.querySelectorAll(".nearby-directions-btn").forEach((t=>{t.style.opacity=e?"0.5":"1",t.style.pointerEvents=e?"none":"auto"}))}function displayDirectRoute(e,t,n){showRouteLoading(!1),state.map.getSource("route")?state.map.getSource("route").setData({type:"Feature",geometry:e.geometry}):(state.map.addSource("route",{type:"geojson",data:{type:"Feature",geometry:e.geometry}}),state.map.addLayer({id:"route-line",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#007AFF","line-width":5,"line-opacity":.8}}));const a=document.createElement("div");a.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#34C759" stroke="white" stroke-width="2"/></svg>',a.style.cursor="pointer";const o=new maplibregl.Popup({offset:25,className:"route-marker-popup origin-popup"}).setHTML(`\n        <div class="route-popup-content">\n            <div class="route-popup-title start">Start Point</div>\n            <div class="route-popup-name">${t.name||"Your Location"}</div>\n            <div class="route-popup-coords">${t.lat.toFixed(5)}, ${t.lng.toFixed(5)}</div>\n        </div>\n    `),s=new maplibregl.Marker({element:a}).setLngLat([t.lng,t.lat]).setPopup(o).addTo(state.map),r=document.createElement("div");r.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#FF3B30" stroke="white" stroke-width="2"/></svg>',r.style.cursor="pointer";const i=new maplibregl.Popup({offset:25,className:"route-marker-popup destination-popup"}).setHTML(`\n        <div class="route-popup-content">\n            <div class="route-popup-title destination">Destination</div>\n            <div class="route-popup-name">${n.name||"Unknown"}</div>\n            <div class="route-popup-coords">${n.lat.toFixed(5)}, ${n.lng.toFixed(5)}</div>\n            <div class="route-popup-address" id="dest-popup-address">\n                <span class="address-loading">Loading address...</span>\n            </div>\n        </div>\n    `),l=new maplibregl.Marker({element:r}).setLngLat([n.lng,n.lat]).setPopup(i).addTo(state.map);l.togglePopup(),reverseGeocodeElement(n.lat,n.lng,"dest-popup-address"),state.routing.markers=[s,l],addRouteAdMarkers(e.geometry.coordinates);const c=(e.distance/1e3).toFixed(1),d=Math.round(e.duration/60);showRouteInfo(n.name,c,d,t,n);const p=e.geometry.coordinates,u=p.reduce(((e,t)=>e.extend(t)),new maplibregl.LngLatBounds(p[0],p[0]));state.map.fitBounds(u,{padding:80})}function showRouteInfo(e,t,n,a,o){const s=document.getElementById("route-info-popup");s&&s.remove(),state.currentRoute={origin:a,destination:o,destName:e,distanceKm:t,durationMin:n};const r=escapeHtml(e),i=document.createElement("div");i.id="route-info-popup",i.className="route-info-popup draggable",i.innerHTML=`\n        <div class="route-info-header panel-drag-handle">\n            <span class="drag-icon">‚ãÆ‚ãÆ</span>\n            <span class="route-info-title">Route to ${r}</span>\n            <button class="route-info-close" onclick="closeRouteInfo()">&times;</button>\n        </div>\n        <div class="route-info-stats">\n            <span class="route-stat"><strong>${t}</strong> km</span>\n            <span class="route-stat"><strong>${n}</strong> min</span>\n        </div>\n        <div class="route-share-section">\n            <span class="share-label">Share:</span>\n            <div class="share-buttons">\n                <button class="share-btn share-whatsapp" onclick="shareToWhatsApp()" title="WhatsApp">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>\n                </button>\n                <button class="share-btn share-telegram" onclick="shareToTelegram()" title="Telegram">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>\n                </button>\n                <button class="share-btn share-twitter" onclick="shareToTwitter()" title="X/Twitter">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>\n                </button>\n                <button class="share-btn share-facebook" onclick="shareToFacebook()" title="Facebook">\n                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>\n                </button>\n                <button class="share-btn share-email" onclick="shareToEmail()" title="Email">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>\n                </button>\n                <button class="share-btn share-copy" onclick="shareRoute()" title="Copy Link">\n                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>\n                </button>\n            </div>\n        </div>\n    `,document.body.appendChild(i);const l=i.querySelector(".route-info-header");makePanelDraggable(i,l,"routeInfoPosition")}function shareRoute(){if(!state.currentRoute)return;const{origin:e,destination:t,destName:n}=state.currentRoute,a=new URLSearchParams;a.set("from",`${e.lng.toFixed(6)},${e.lat.toFixed(6)}`),a.set("to",`${t.lng.toFixed(6)},${t.lat.toFixed(6)}`),a.set("dest",n);const o=`${window.location.origin}${window.location.pathname}?${a.toString()}`;navigator.clipboard?navigator.clipboard.writeText(o).then((()=>{showShareConfirmation()})).catch((()=>{fallbackCopyToClipboard(o)})):fallbackCopyToClipboard(o)}function fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),showShareConfirmation()}function showShareConfirmation(){const e=document.querySelector(".route-share-btn");if(e){const t=e.innerHTML;e.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Link Copied!',e.style.background="var(--success)",setTimeout((()=>{e.innerHTML=t,e.style.background=""}),2e3)}}function checkForSharedRoute(){const e=new URLSearchParams(window.location.search),t=e.get("from"),n=e.get("to"),a=e.get("dest");if(t&&n){const[e,o]=t.split(",").map(Number),[s,r]=n.split(",").map(Number);isNaN(e)||isNaN(o)||isNaN(s)||isNaN(r)||(state.nearby.center={lng:e,lat:o},setTimeout((()=>{getDirectionsTo(s,r,a||"Destination")}),1e3))}}function getShareUrl(){if(!state.currentRoute)return"";const{origin:e,destination:t,destName:n}=state.currentRoute,a=new URLSearchParams;return a.set("from",`${e.lng.toFixed(6)},${e.lat.toFixed(6)}`),a.set("to",`${t.lng.toFixed(6)},${t.lat.toFixed(6)}`),a.set("dest",n),`${window.location.origin}${window.location.pathname}?${a.toString()}`}function getShareText(){if(!state.currentRoute)return"";const{destName:e,distanceKm:t,durationMin:n}=state.currentRoute;return`Directions to ${e} (${t} km, ${n} min)`}function shareToWhatsApp(){const e=getShareUrl(),t=getShareText();window.open(`https://wa.me/?text=${encodeURIComponent(t+"\n"+e)}`,"_blank")}function shareToTelegram(){const e=getShareUrl(),t=getShareText();window.open(`https://t.me/share/url?url=${encodeURIComponent(e)}&text=${encodeURIComponent(t)}`,"_blank")}function shareToTwitter(){const e=getShareUrl(),t=getShareText();window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(e)}`,"_blank")}function shareToFacebook(){const e=getShareUrl();window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`,"_blank")}function shareToEmail(){const e=getShareUrl(),{destName:t,distanceKm:n,durationMin:a}=state.currentRoute,o=`Directions to ${t}`,s=`Here are directions to ${t} (${n} km, approximately ${a} minutes):\n\n${e}`;window.location.href=`mailto:?subject=${encodeURIComponent(o)}&body=${encodeURIComponent(s)}`}function closeRouteInfo(){const e=document.getElementById("route-info-popup");e&&e.remove(),clearRoute()}function hardRefresh(){["timelinePanelPosition","placePanelPosition","legendPosition","routingPanelPosition","nearbyPanelPosition","routeInfoPosition","layersPanelPosition","collapsedCategories","mapStyle"].forEach((e=>localStorage.removeItem(e))),clearRoute(),clearNearbyMarkers(),document.querySelectorAll(".hidden").forEach((e=>e.classList.add("hidden")));const e=document.getElementById("route-info-popup");e&&e.remove(),window.history.replaceState({},document.title,window.location.pathname),window.location.reload(!0)}async function clearMapCache(){const e=document.getElementById("btn-clear-cache"),t=e?e.innerHTML:"";try{if(e&&(e.innerHTML='<span aria-hidden="true">‚è≥</span>',e.disabled=!0),"caches"in window){const e=(await caches.keys()).filter((e=>e.startsWith("dataacuity-")));await Promise.all(e.map((e=>caches.delete(e)))),console.log("[Cache] Cleared caches:",e)}["timelinePanelPosition","placePanelPosition","legendPosition","routingPanelPosition","nearbyPanelPosition","routeInfoPosition","layersPanelPosition","collapsedCategories","mapStyle","memories","searchHistory"].forEach((e=>localStorage.removeItem(e))),sessionStorage.clear(),navigator.serviceWorker&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("cleanup-caches"),e&&(e.innerHTML='<span aria-hidden="true">‚úì</span>'),updateStatsHint("Cache cleared! Reloading..."),setTimeout((()=>{window.location.reload(!0)}),500)}catch(n){console.error("[Cache] Clear failed:",n),e&&(e.innerHTML=t,e.disabled=!1),updateStatsHint("Failed to clear cache")}}function clearNearbyMarkers(){state.nearby.markers.forEach((e=>e.remove())),state.nearby.markers=[]}function clearNearby(){clearNearbyMarkers(),state.nearby.centerMarker&&(state.nearby.centerMarker.remove(),state.nearby.centerMarker=null),state.nearby.center=null,state.nearby.activeCategories=[],document.getElementById("nearby-location-text").textContent="or click on map",document.querySelectorAll("#nearby-categories input").forEach((e=>e.checked=!1)),document.getElementById("nearby-results").classList.add("hidden"),document.getElementById("nearby-results-list").innerHTML="",updateNearbyCategoryCount(),updateNearbySearchButton()}function initOnboarding(){localStorage.getItem("hasSeenOnboarding")||setTimeout((()=>{document.getElementById("onboarding-overlay").classList.remove("hidden")}),800)}function closeOnboarding(){document.getElementById("dont-show-again").checked&&localStorage.setItem("hasSeenOnboarding","true"),document.getElementById("onboarding-overlay").classList.add("hidden")}function showOnboarding(){document.getElementById("onboarding-overlay").classList.remove("hidden")}function initKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if(e.ctrlKey&&e.shiftKey&&("R"===e.key||"r"===e.key))return e.preventDefault(),void clearMapCache();if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return void("Escape"===e.key&&e.target.blur());const t=document.getElementById("timeline-slider"),n=document.getElementById("year-input");switch(e.key){case"ArrowLeft":e.preventDefault();const a=e.shiftKey?100:10,o=Math.max(-3e3,state.currentYear-a);t.value=o,n&&(n.value=Math.abs(o)),updateYear(o),updateEraButtons(o),updateStatsHint(`Traveling to ${formatYear(o)}`);break;case"ArrowRight":e.preventDefault();const s=e.shiftKey?100:10,r=Math.min(2024,state.currentYear+s);t.value=r,n&&(n.value=Math.abs(r)),updateYear(r),updateEraButtons(r),updateStatsHint(`Traveling to ${formatYear(r)}`);break;case"/":e.preventDefault(),document.getElementById("search-input").focus(),updateStatsHint("Type to search places...");break;case"?":e.preventDefault(),toggleShortcutsPanel();break;case"Escape":closeAllPanels();break;case"d":case"D":e.preventDefault(),openRoutingPanel();break;case"n":case"N":e.preventDefault(),openNearbyPanel();break;case"m":case"M":e.preventDefault(),openMemoriesPanel();break;case"l":case"L":e.preventDefault(),document.getElementById("layers-panel").classList.toggle("hidden");break;case" ":e.preventDefault(),togglePlay()}}))}function toggleShortcutsPanel(){const e=document.getElementById("shortcuts-panel");e&&e.classList.toggle("hidden")}function closeAllPanels(){const e=document.getElementById("shortcuts-panel");e&&e.classList.add("hidden"),document.getElementById("place-panel").classList.add("hidden"),document.getElementById("layers-panel").classList.add("hidden");const t=document.getElementById("onboarding-overlay");t&&t.classList.add("hidden");const n=document.getElementById("routing-panel");n&&n.classList.add("hidden");const a=document.getElementById("nearby-panel");a&&a.classList.add("hidden"),updateStatsHint("Slide timeline or search to explore")}function openRoutingPanel(){toggleRoutingPanel(),updateStatsHint("Enter start and destination")}function openNearbyPanel(){toggleNearbyPanel(),updateStatsHint("Click map to find nearby places")}function initYearInput(){const e=document.getElementById("year-input"),t=document.getElementById("timeline-slider");e&&(e.addEventListener("change",(n=>{let a=parseInt(n.target.value);if(isNaN(a))return;const o=document.querySelector('.era-btn[data-era="bce"]'),s=o&&o.classList.contains("active")?-Math.abs(a):Math.abs(a),r=Math.max(-3e3,Math.min(2024,s));t.value=r,e.value=Math.abs(r),updateYear(r),updateStatsHint(`Jumped to ${formatYear(r)}`)})),e.addEventListener("keydown",(e=>{"Enter"===e.key&&e.target.blur()})))}function toggleEra(e){const t=document.querySelector('.era-btn[data-era="bce"]'),n=document.querySelector('.era-btn[data-era="ce"]'),a=document.getElementById("year-input"),o=document.getElementById("timeline-slider");if(!t||!n)return;"bce"===e?(t.classList.add("active"),n.classList.remove("active")):(n.classList.add("active"),t.classList.remove("active"));const s=parseInt(a.value)||0,r="bce"===e?-Math.abs(s):Math.abs(s),i=Math.max(-3e3,Math.min(2024,r));o.value=i,updateYear(i)}function updateEraButtons(e){const t=document.querySelector('.era-btn[data-era="bce"]'),n=document.querySelector('.era-btn[data-era="ce"]'),a=document.getElementById("year-input");t&&n&&a&&(e<0?(t.classList.add("active"),n.classList.remove("active"),a.value=Math.abs(e)):(n.classList.add("active"),t.classList.remove("active"),a.value=e))}window.shareRoute=shareRoute,window.shareToWhatsApp=shareToWhatsApp,window.shareToTelegram=shareToTelegram,window.shareToTwitter=shareToTwitter,window.shareToFacebook=shareToFacebook,window.shareToEmail=shareToEmail,window.closeRouteInfo=closeRouteInfo,window.hardRefresh=hardRefresh,window.clearMapCache=clearMapCache;const statsHints=["Slide timeline or search to explore",'Try searching "Constantinople"',"Click markers for history","Press ? for shortcuts","Use D for directions","Use N to find nearby places"];let currentHintIndex=0;function initStatsHints(){setInterval((()=>{if(!state.selectedPlace&&!state.routing.active&&!state.nearby.active){currentHintIndex=(currentHintIndex+1)%statsHints.length;const e=document.getElementById("stats-hint");e&&(e.textContent=statsHints[currentHintIndex],e.classList.remove("active"))}}),8e3)}function updateStatsHint(e,t=!0){const n=document.getElementById("stats-hint");n&&(n.textContent=e,t?n.classList.add("active"):n.classList.remove("active")),setTimeout((()=>{const t=document.getElementById("stats-hint");t&&t.textContent===e&&(t.textContent=statsHints[0],t.classList.remove("active"))}),5e3)}function getPlaceShareUrl(e,t,n){const a=window.location.origin+window.location.pathname,o=new URLSearchParams;return o.set("place",encodeURIComponent(e)),o.set("lat",t.toFixed(4)),o.set("lng",n.toFixed(4)),2024!==state.currentYear&&o.set("year",state.currentYear),`${a}#${o.toString()}`}function sharePlaceToWhatsApp(e,t,n){const a=`Check out ${e} on DataAcuity Maps!\n${getPlaceShareUrl(e,t,n)}`;window.open(`https://wa.me/?text=${encodeURIComponent(a)}`,"_blank")}function sharePlaceToTelegram(e,t,n){const a=getPlaceShareUrl(e,t,n),o=`Check out ${e} on DataAcuity Maps!`;window.open(`https://t.me/share/url?url=${encodeURIComponent(a)}&text=${encodeURIComponent(o)}`,"_blank")}function sharePlaceToTwitter(e,t,n){const a=getPlaceShareUrl(e,t,n),o=`Exploring ${e} through history on DataAcuity Maps!`;window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(o)}&url=${encodeURIComponent(a)}`,"_blank")}function sharePlaceToFacebook(e,t,n){const a=getPlaceShareUrl(e,t,n);window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(a)}`,"_blank")}function sharePlaceToEmail(e,t,n){const a=`${e} on DataAcuity Maps`,o=`I found ${e} on DataAcuity Maps - check out its history!\n\n${getPlaceShareUrl(e,t,n)}`;window.location.href=`mailto:?subject=${encodeURIComponent(a)}&body=${encodeURIComponent(o)}`}function copyPlaceUrl(e,t,n){const a=getPlaceShareUrl(e,t,n);navigator.clipboard.writeText(a).then((()=>{showSuccess("Link copied to clipboard!");const e=document.querySelector(".share-copy-btn");e&&(e.textContent="Copied!",e.classList.add("copied"),setTimeout((()=>{e.textContent="Copy",e.classList.remove("copied")}),2e3))})).catch((()=>{showError("Failed to copy link")}))}window.closeOnboarding=closeOnboarding,window.showOnboarding=showOnboarding,window.toggleShortcutsPanel=toggleShortcutsPanel,window.toggleEra=toggleEra,window.openRoutingPanel=openRoutingPanel,window.openNearbyPanel=openNearbyPanel,window.sharePlaceToWhatsApp=sharePlaceToWhatsApp,window.sharePlaceToTelegram=sharePlaceToTelegram,window.sharePlaceToTwitter=sharePlaceToTwitter,window.sharePlaceToFacebook=sharePlaceToFacebook,window.sharePlaceToEmail=sharePlaceToEmail,window.copyPlaceUrl=copyPlaceUrl,window.flyToPlace=flyToPlace,window.setOrientation=setOrientation,window.cycleOrientation=cycleOrientation,window.setMapStyle=setMapStyle,window.toggleRoutingPanel=toggleRoutingPanel,window.selectWaypoint=selectWaypoint,window.removeWaypoint=removeWaypoint,window.calculateRoute=calculateRoute,window.clearRoute=clearRoute,window.toggleLegend=toggleLegend,window.toggleTimeline=toggleTimeline,window.selectAllCategories=selectAllCategories,window.selectNoCategories=selectNoCategories,window.setCategoryFilter=setCategoryFilter,window.toggleNearbyPanel=toggleNearbyPanel,window.collapseNearbyPanel=collapseNearbyPanel,window.toggleNearbyCategory=toggleNearbyCategory,window.flyToNearbyPoi=flyToNearbyPoi,window.getDirectionsTo=getDirectionsTo;const HISTORICAL_MAPS_PATH="/historical-maps/optimized/",HISTORICAL_MAPS_THUMBS_PATH="/historical-maps/thumbs/";let historicalMapsManifest=null,currentHistoricalOverlay=null;const historicalMapState={enabled:!1,autoSwitch:!0,opacity:.7,currentMapId:null};async function loadHistoricalMapsManifest(){try{const e=await fetch("/historical-maps/manifest.json");if(e.ok)return historicalMapsManifest=await e.json(),console.log("Loaded historical maps manifest:",historicalMapsManifest.maps.length,"maps"),historicalMapsManifest}catch(e){console.error("Error loading historical maps manifest:",e)}return null}function getWorldMaps(){return historicalMapsManifest?historicalMapsManifest.maps.filter((e=>"world"===e.region)).sort(((e,t)=>e.period.start-t.period.start)):[]}function findMapForYear(e){const t=getWorldMaps();if(0===t.length)return null;const n=t.filter((t=>e>=t.period.start&&e<=t.period.end));if(n.length>0)return n.reduce(((e,t)=>{const n=e.period.end-e.period.start;return t.period.end-t.period.start<n?t:e}));let a=t[0],o=1/0;return t.forEach((t=>{const n=(t.period.start+t.period.end)/2,s=Math.abs(n-e);s<o&&(o=s,a=t)})),a}function addHistoricalMapOverlay(e){if(!state.map||!e)return;removeHistoricalMapOverlay();const t=HISTORICAL_MAPS_PATH+e.file,n=e.bounds||[[-85,-180],[85,180]];state.map.addSource("historical-map-overlay",{type:"image",url:t,coordinates:[[n[0][1],n[1][0]],[n[1][1],n[1][0]],[n[1][1],n[0][0]],[n[0][1],n[0][0]]]}),state.map.addLayer({id:"historical-map-layer",type:"raster",source:"historical-map-overlay",paint:{"raster-opacity":historicalMapState.opacity,"raster-fade-duration":300}},"raster-layer"),historicalMapState.currentMapId=e.id,currentHistoricalOverlay=e,updateHistoricalMapUI(),showToast(`Historical map: ${e.title} (${e.originalDate||""})`,"info",3e3)}function removeHistoricalMapOverlay(){if(state.map){try{state.map.getLayer("historical-map-layer")&&state.map.removeLayer("historical-map-layer"),state.map.getSource("historical-map-overlay")&&state.map.removeSource("historical-map-overlay")}catch(e){console.warn("Error removing historical map overlay:",e)}historicalMapState.currentMapId=null,currentHistoricalOverlay=null,updateHistoricalMapUI()}}function setHistoricalMapOpacity(e){historicalMapState.opacity=e,state.map&&state.map.getLayer("historical-map-layer")&&state.map.setPaintProperty("historical-map-layer","raster-opacity",e);const t=document.getElementById("historical-opacity-value");t&&(t.textContent=Math.round(100*e)+"%")}function toggleHistoricalMap(e){if(historicalMapState.enabled=e,e){const e=findMapForYear(state.currentYear);e&&addHistoricalMapOverlay(e)}else removeHistoricalMapOverlay();localStorage.setItem("historicalMapEnabled",e)}function toggleHistoricalAutoSwitch(e){historicalMapState.autoSwitch=e,localStorage.setItem("historicalAutoSwitch",e)}function selectHistoricalMap(e){if(!historicalMapsManifest)return;const t=historicalMapsManifest.maps.find((t=>t.id===e));if(t){historicalMapState.autoSwitch=!1,addHistoricalMapOverlay(t);const e=document.getElementById("historical-auto-switch");e&&(e.checked=!1)}}function updateHistoricalMapUI(){const e=document.getElementById("historical-map-select");e&&historicalMapState.currentMapId&&(e.value=historicalMapState.currentMapId);const t=document.getElementById("historical-map-info");t&&currentHistoricalOverlay?t.innerHTML=`\n            <strong>${currentHistoricalOverlay.title}</strong>\n            <small>${currentHistoricalOverlay.cartographer||""} ${currentHistoricalOverlay.originalDate||""}</small>\n        `:t&&(t.innerHTML="<em>No historical map overlay active</em>")}function initHistoricalMaps(){loadHistoricalMapsManifest().then((e=>{if(!e)return;const t=document.getElementById("layers-list");if(!t)return;const n=document.createElement("div");n.className="collapsible-section historical-maps-section",n.innerHTML=`\n            <div class="section-header" onclick="toggleSection(this)">\n                <span class="section-toggle">‚ñº</span>\n                <h4>Historical Map Overlays</h4>\n            </div>\n            <div class="section-content">\n                <div class="historical-map-controls">\n                    <label class="toggle-label">\n                        <input type="checkbox" id="historical-enabled" onchange="toggleHistoricalMap(this.checked)" />\n                        <span>Show historical map overlay</span>\n                    </label>\n\n                    <label class="toggle-label">\n                        <input type="checkbox" id="historical-auto-switch" checked onchange="toggleHistoricalAutoSwitch(this.checked)" />\n                        <span>Auto-switch with timeline</span>\n                    </label>\n\n                    <div class="opacity-control">\n                        <label>Opacity: <span id="historical-opacity-value">70%</span></label>\n                        <input type="range" id="historical-opacity" min="0" max="1" step="0.1" value="0.7"\n                               oninput="setHistoricalMapOpacity(parseFloat(this.value))" />\n                    </div>\n\n                    <div class="map-select-container">\n                        <label for="historical-map-select">Select map:</label>\n                        <select id="historical-map-select" onchange="selectHistoricalMap(this.value)">\n                            <option value="">-- Select a map --</option>\n                            ${getWorldMaps().map((e=>`\n                                <option value="${e.id}">${e.title} (${e.originalDate||formatPeriod(e.period)})</option>\n                            `)).join("")}\n                        </select>\n                    </div>\n\n                    <div id="historical-map-info" class="map-info">\n                        <em>No historical map overlay active</em>\n                    </div>\n\n                    <div class="map-thumbnails">\n                        ${getWorldMaps().slice(0,6).map((e=>`\n                            <div class="map-thumbnail" onclick="selectHistoricalMap('${e.id}')" title="${e.title}">\n                                <img src="/historical-maps/thumbs/${e.file}" alt="${e.title}" loading="lazy" />\n                                <span class="thumb-label">${e.originalDate||""}</span>\n                            </div>\n                        `)).join("")}\n                    </div>\n                </div>\n            </div>\n        `;const a=t.querySelector(".style-section");a?a.after(n):t.appendChild(n);const o="true"===localStorage.getItem("historicalMapEnabled"),s="false"!==localStorage.getItem("historicalAutoSwitch");historicalMapState.autoSwitch=s,document.getElementById("historical-auto-switch").checked=s,o&&(document.getElementById("historical-enabled").checked=!0,toggleHistoricalMap(!0))}))}function formatPeriod(e){return`${e.start<0?`${Math.abs(e.start)} BCE`:`${e.start} CE`} - ${e.end<0?`${Math.abs(e.end)} BCE`:`${e.end} CE`}`}const originalUpdateYear=updateYear;updateYear=function(e){if(originalUpdateYear(e),historicalMapState.enabled&&historicalMapState.autoSwitch){const t=findMapForYear(e);t&&t.id!==historicalMapState.currentMapId&&addHistoricalMapOverlay(t)}},document.addEventListener("DOMContentLoaded",(()=>{const e=setInterval((()=>{state.map&&state.map.loaded()&&(clearInterval(e),initHistoricalMaps())}),100)})),window.toggleHistoricalMap=toggleHistoricalMap,window.toggleHistoricalAutoSwitch=toggleHistoricalAutoSwitch,window.selectHistoricalMap=selectHistoricalMap,window.setHistoricalMapOpacity=setHistoricalMapOpacity;let biblicalJourneysData=null;const biblicalJourneyState={active:!1,currentJourney:null,routeLayer:null,markers:[],isPlaying:!1,playInterval:null,currentWaypointIndex:0,animationSpeed:2e3};async function loadBiblicalJourneys(){const e=await fetchJSON("/data/biblical-journeys.json");return e.ok&&e.data&&e.data.journeys?(biblicalJourneysData=e.data,console.log("Loaded biblical journeys:",biblicalJourneysData.journeys.length,"journeys"),biblicalJourneysData):null}function getJourneysByCategory(e){return biblicalJourneysData?biblicalJourneysData.journeys.filter((t=>t.category===e)):[]}function displayBiblicalJourney(e){if(!biblicalJourneysData||!state.map)return;const t=biblicalJourneysData.journeys.find((t=>t.id===e));if(!t)return;clearBiblicalJourney(),biblicalJourneyState.active=!0,biblicalJourneyState.currentJourney=t;const n=biblicalJourneysData.categories.find((e=>e.id===t.category)),a=n?n.color:"#007AFF",o=t.waypoints.map((e=>e.location));state.map.addSource("biblical-route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:o}}}),state.map.addLayer({id:"biblical-route-line",type:"line",source:"biblical-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":a,"line-width":4,"line-opacity":.8,"line-dasharray":[2,1]}}),t.waypoints.forEach(((e,n)=>{const o=document.createElement("div");o.className="biblical-waypoint-marker",o.innerHTML=`<span class="waypoint-number">${n+1}</span>`,o.style.backgroundColor=a;const s=new maplibregl.Popup({offset:25,closeButton:!0,maxWidth:"320px"}).setHTML(createWaypointPopupHTML(e,t,n)),r=new maplibregl.Marker({element:o}).setLngLat(e.location).setPopup(s).addTo(state.map);biblicalJourneyState.markers.push(r)}));const s=new maplibregl.LngLatBounds;if(o.forEach((e=>s.extend(e))),state.map.fitBounds(s,{padding:50,duration:1e3}),t.year){const e=document.getElementById("timeline-slider");e&&(e.value=t.year,updateYear(t.year))}updateBiblicalJourneyUI(),showToast(`Displaying: ${t.name}`,"info",3e3)}function createWaypointPopupHTML(e,t,n){const a=e.events?`<ul class="waypoint-events">${e.events.map((e=>`<li>${e}</li>`)).join("")}</ul>`:"";return`\n        <div class="biblical-popup">\n            <div class="popup-header" style="border-left: 4px solid ${getCategoryColor(t.category)}">\n                <span class="waypoint-badge">${n+1}</span>\n                <h3>${e.name}</h3>\n            </div>\n            <p class="popup-description">${e.description||""}</p>\n            ${a}\n            <div class="popup-scripture">\n                <strong>üìñ ${e.scripture||t.scripture}</strong>\n            </div>\n            <div class="popup-actions">\n                <button class="btn btn-sm" onclick="flyToWaypoint(${n})">Focus</button>\n                ${n>0?'<button class="btn btn-sm" onclick="goToPreviousWaypoint()">‚Üê Previous</button>':""}\n                ${n<t.waypoints.length-1?'<button class="btn btn-sm" onclick="goToNextWaypoint()">Next ‚Üí</button>':""}\n            </div>\n        </div>\n    `}function getCategoryColor(e){if(!biblicalJourneysData)return"#007AFF";const t=biblicalJourneysData.categories.find((t=>t.id===e));return t?t.color:"#007AFF"}function clearBiblicalJourney(){if(stopJourneyAnimation(),biblicalJourneyState.markers.forEach((e=>e.remove())),biblicalJourneyState.markers=[],state.map)try{state.map.getLayer("biblical-route-line")&&state.map.removeLayer("biblical-route-line"),state.map.getSource("biblical-route")&&state.map.removeSource("biblical-route")}catch(e){console.warn("Error clearing biblical journey:",e)}biblicalJourneyState.active=!1,biblicalJourneyState.currentJourney=null,biblicalJourneyState.currentWaypointIndex=0,updateBiblicalJourneyUI()}function flyToWaypoint(e){if(!biblicalJourneyState.currentJourney)return;const t=biblicalJourneyState.currentJourney.waypoints[e];t&&(biblicalJourneyState.currentWaypointIndex=e,state.map.flyTo({center:t.location,zoom:8,duration:1e3}),biblicalJourneyState.markers[e]&&biblicalJourneyState.markers[e].togglePopup())}function goToNextWaypoint(){if(!biblicalJourneyState.currentJourney)return;const e=biblicalJourneyState.currentWaypointIndex+1;e<biblicalJourneyState.currentJourney.waypoints.length&&flyToWaypoint(e)}function goToPreviousWaypoint(){if(!biblicalJourneyState.currentJourney)return;const e=biblicalJourneyState.currentWaypointIndex-1;e>=0&&flyToWaypoint(e)}function playJourneyAnimation(){biblicalJourneyState.currentJourney&&!biblicalJourneyState.isPlaying&&(biblicalJourneyState.isPlaying=!0,biblicalJourneyState.currentWaypointIndex=0,flyToWaypoint(0),biblicalJourneyState.playInterval=setInterval((()=>{const e=biblicalJourneyState.currentWaypointIndex+1;e<biblicalJourneyState.currentJourney.waypoints.length?flyToWaypoint(e):(stopJourneyAnimation(),showToast("Journey complete!","success",2e3))}),biblicalJourneyState.animationSpeed),updateBiblicalJourneyUI())}function stopJourneyAnimation(){biblicalJourneyState.playInterval&&(clearInterval(biblicalJourneyState.playInterval),biblicalJourneyState.playInterval=null),biblicalJourneyState.isPlaying=!1,updateBiblicalJourneyUI()}function toggleJourneyAnimation(){biblicalJourneyState.isPlaying?stopJourneyAnimation():playJourneyAnimation()}function setJourneyAnimationSpeed(e){biblicalJourneyState.animationSpeed=e,biblicalJourneyState.isPlaying&&(stopJourneyAnimation(),playJourneyAnimation())}function updateBiblicalJourneyUI(){const e=document.getElementById("biblical-journey-select"),t=document.getElementById("journey-play-btn"),n=document.getElementById("journey-clear-btn"),a=document.getElementById("journey-info-panel");if(e&&biblicalJourneyState.currentJourney&&(e.value=biblicalJourneyState.currentJourney.id),t&&(t.textContent=biblicalJourneyState.isPlaying?"‚è∏Ô∏è Pause":"‚ñ∂Ô∏è Play",t.disabled=!biblicalJourneyState.currentJourney),n&&(n.disabled=!biblicalJourneyState.currentJourney),a&&biblicalJourneyState.currentJourney){const e=biblicalJourneyState.currentJourney;a.innerHTML=`\n            <div class="journey-info-content">\n                <h4>${e.name}</h4>\n                <p>${e.description}</p>\n                <div class="journey-meta">\n                    <span>üìñ ${e.scripture}</span>\n                    <span>üìç ${e.waypoints.length} locations</span>\n                </div>\n                <div class="journey-progress">\n                    <span>Location ${biblicalJourneyState.currentWaypointIndex+1} of ${e.waypoints.length}</span>\n                    <div class="progress-bar">\n                        <div class="progress-fill" style="width: ${(biblicalJourneyState.currentWaypointIndex+1)/e.waypoints.length*100}%"></div>\n                    </div>\n                </div>\n            </div>\n        `}else a&&(a.innerHTML="<em>Select a journey to display</em>")}function initBiblicalJourneys(){loadBiblicalJourneys().then((e=>{if(!e)return;const t=document.getElementById("map-container");if(!t)return;const n=document.createElement("button");n.id="btn-biblical-journeys",n.className="floating-btn biblical-journeys-btn",n.innerHTML="üìñ",n.title="Biblical Journeys",n.onclick=toggleBiblicalJourneysPanel;let a=document.querySelector(".floating-buttons");a||(a=document.createElement("div"),a.className="floating-buttons",t.appendChild(a)),a.insertBefore(n,a.firstChild);const o=document.createElement("aside");o.id="biblical-journeys-panel",o.className="biblical-journeys-panel hidden",o.innerHTML=`\n            <div class="panel-header">\n                <h3>üìñ Biblical Journeys</h3>\n                <button class="panel-close-btn" onclick="toggleBiblicalJourneysPanel()">&times;</button>\n            </div>\n            <div class="panel-content">\n                <div class="journey-categories">\n                    ${e.categories.map((e=>`\n                        <div class="journey-category">\n                            <div class="category-header" onclick="toggleJourneyCategory('${e.id}')" style="border-left: 4px solid ${e.color}">\n                                <span class="category-toggle">‚ñº</span>\n                                <h4>${e.name}</h4>\n                                <span class="category-period">${formatYearRange(e.period)}</span>\n                            </div>\n                            <div class="category-journeys" id="category-${e.id}">\n                                ${getJourneysByCategory(e.id).map((e=>`\n                                    <button class="journey-btn" onclick="displayBiblicalJourney('${e.id}')" title="${e.description}">\n                                        ${e.name}\n                                        <span class="journey-scripture">${e.scripture}</span>\n                                    </button>\n                                `)).join("")}\n                            </div>\n                        </div>\n                    `)).join("")}\n                </div>\n\n                <div class="journey-controls">\n                    <div id="journey-info-panel" class="journey-info-panel">\n                        <em>Select a journey to display</em>\n                    </div>\n                    <div class="control-buttons">\n                        <button id="journey-play-btn" class="btn" onclick="toggleJourneyAnimation()" disabled>‚ñ∂Ô∏è Play</button>\n                        <button id="journey-clear-btn" class="btn btn-secondary" onclick="clearBiblicalJourney()" disabled>Clear</button>\n                    </div>\n                    <div class="speed-control">\n                        <label>Speed:</label>\n                        <select onchange="setJourneyAnimationSpeed(parseInt(this.value))">\n                            <option value="3000">Slow</option>\n                            <option value="2000" selected>Normal</option>\n                            <option value="1000">Fast</option>\n                            <option value="500">Very Fast</option>\n                        </select>\n                    </div>\n                </div>\n            </div>\n        `,t.appendChild(o),console.log("Biblical journeys panel initialized")}))}function formatYearRange(e){return`${e.start<0?`${Math.abs(e.start)} BC`:`${e.start} AD`} - ${e.end<0?`${Math.abs(e.end)} BC`:`${e.end} AD`}`}function toggleBiblicalJourneysPanel(){const e=document.getElementById("biblical-journeys-panel");e&&e.classList.toggle("hidden")}function toggleJourneyCategory(e){const t=document.getElementById(`category-${e}`),n=t?.previousElementSibling,a=n?.querySelector(".category-toggle");t&&(t.classList.toggle("collapsed"),a&&(a.textContent=t.classList.contains("collapsed")?"‚ñ∂":"‚ñº"))}document.addEventListener("DOMContentLoaded",(()=>{const e=setInterval((()=>{state.map&&state.map.loaded()&&(clearInterval(e),setTimeout(initBiblicalJourneys,500))}),100)})),window.displayBiblicalJourney=displayBiblicalJourney,window.clearBiblicalJourney=clearBiblicalJourney,window.toggleBiblicalJourneysPanel=toggleBiblicalJourneysPanel,window.toggleJourneyCategory=toggleJourneyCategory,window.toggleJourneyAnimation=toggleJourneyAnimation,window.playJourneyAnimation=playJourneyAnimation,window.stopJourneyAnimation=stopJourneyAnimation,window.setJourneyAnimationSpeed=setJourneyAnimationSpeed,window.flyToWaypoint=flyToWaypoint,window.goToNextWaypoint=goToNextWaypoint,window.goToPreviousWaypoint=goToPreviousWaypoint;const MEMORY_CATEGORIES={visited:{name:"Visited",icon:"üìç",color:"#4CAF50"},favorite:{name:"Favorite",icon:"‚≠ê",color:"#FFC107"},want_to_visit:{name:"Want to Visit",icon:"üéØ",color:"#2196F3"},photo:{name:"Photo Spot",icon:"üì∏",color:"#9C27B0"},restaurant:{name:"Restaurant",icon:"üçΩÔ∏è",color:"#FF5722"},general:{name:"General",icon:"üìå",color:"#607D8B"}};function getUserHash(){let e=localStorage.getItem("dataacuity_user_hash");return e||(e="user_"+Array.from(crypto.getRandomValues(new Uint8Array(16))).map((e=>e.toString(16).padStart(2,"0"))).join(""),localStorage.setItem("dataacuity_user_hash",e)),state.memories.userHash=e,e}function initMemories(){getUserHash(),createMemoriesPanel(),loadMemories()}function createMemoriesPanel(){const e=document.getElementById("map-container"),t=document.createElement("div");t.id="memories-panel",t.className="memories-panel hidden draggable",t.innerHTML='\n        <div class="memories-header panel-drag-handle">\n            <h3><span class="drag-icon">‚ãÆ‚ãÆ</span> My Memories</h3>\n            <div class="memories-header-controls">\n                <button class="memories-collapse-btn" onclick="collapseMemoriesPanel()" title="Collapse/Expand">‚àí</button>\n                <button class="panel-close-btn" onclick="toggleMemoriesPanel()">&times;</button>\n            </div>\n        </div>\n        <div class="memories-content">\n            <div class="memories-actions">\n                <button id="btn-save-memory" class="btn btn-primary btn-sm" onclick="openSaveMemoryDialog()">\n                    <span>üìç</span> Save Current Location\n                </button>\n                <button id="btn-refresh-memories" class="btn btn-secondary btn-sm" onclick="loadMemories()">\n                    <span>üîÑ</span> Refresh\n                </button>\n            </div>\n            <div class="memories-stats">\n                <span id="memories-count">0</span> memories saved\n            </div>\n            <div class="memories-list" id="memories-list">\n                <div class="memories-empty">\n                    <p>No memories yet!</p>\n                    <p>Click "Save Current Location" or right-click on the map to save a memory.</p>\n                </div>\n            </div>\n        </div>\n    ',e.appendChild(t);const n=t.querySelector(".memories-header");makePanelDraggable(t,n,"memoriesPanelPosition"),state.map&&state.map.on("contextmenu",(e=>{openSaveMemoryDialog(e.lngLat.lng,e.lngLat.lat)}))}function toggleMemoriesPanel(){const e=document.getElementById("memories-panel");e.classList.toggle("hidden"),state.memories.active=!e.classList.contains("hidden"),state.memories.active?(loadMemories(),showMemoryMarkers()):hideMemoryMarkers()}function collapseMemoriesPanel(){const e=document.getElementById("memories-panel"),t=e.querySelector(".memories-content"),n=e.querySelector(".memories-collapse-btn");t.classList.toggle("collapsed"),n.textContent=t.classList.contains("collapsed")?"+":"‚àí"}function openMemoriesPanel(){toggleMemoriesPanel(),updateStatsHint("View and manage your saved memories")}async function loadMemories(){const e=getUserHash(),t=await fetchJSON(`${API_BASE}/memories/mine?user_hash=${encodeURIComponent(e)}&limit=100`);t.ok&&t.data&&(state.memories.items=t.data.memories||[],renderMemoriesList(),state.memories.active&&showMemoryMarkers())}function renderMemoriesList(){const e=document.getElementById("memories-list"),t=document.getElementById("memories-count");e&&(t.textContent=state.memories.items.length,0!==state.memories.items.length?e.innerHTML=state.memories.items.map((e=>{const t=MEMORY_CATEGORIES[e.category]||MEMORY_CATEGORIES.general,n=new Date(e.created_at).toLocaleDateString(),a=escapeHtml(e.note||"No note");return`\n            <div class="memory-item" onclick="flyToMemory(${e.lat}, ${e.lng})">\n                <div class="memory-icon" style="color: ${t.color}">${t.icon}</div>\n                <div class="memory-details">\n                    <div class="memory-note">${a}</div>\n                    <div class="memory-meta">\n                        <span class="memory-category">${t.name}</span>\n                        <span class="memory-date">${n}</span>\n                    </div>\n                </div>\n                <button class="memory-fly-btn" title="Go to location">üó∫Ô∏è</button>\n            </div>\n        `})).join(""):e.innerHTML='\n            <div class="memories-empty">\n                <p>No memories yet!</p>\n                <p>Click "Save Current Location" or right-click on the map to save a memory.</p>\n            </div>\n        ')}function showMemoryMarkers(){hideMemoryMarkers(),state.memories.items.forEach((e=>{const t=MEMORY_CATEGORIES[e.category]||MEMORY_CATEGORIES.general,n=document.createElement("div");n.className="memory-marker",n.innerHTML=t.icon,n.style.cssText="\n            font-size: 24px;\n            cursor: pointer;\n            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));\n        ";const a=new maplibregl.Marker({element:n}).setLngLat([e.lng,e.lat]).setPopup(new maplibregl.Popup({offset:25}).setHTML(`\n                <div class="memory-popup">\n                    <strong>${t.icon} ${t.name}</strong>\n                    <p>${escapeHtml(e.note||"No note")}</p>\n                    <small>${new Date(e.created_at).toLocaleDateString()}</small>\n                </div>\n            `)).addTo(state.map);state.memories.markers.push(a)}))}function hideMemoryMarkers(){state.memories.markers.forEach((e=>e.remove())),state.memories.markers=[]}function flyToMemory(e,t){state.map.flyTo({center:[t,e],zoom:15,duration:1500})}function openSaveMemoryDialog(e,t){if(void 0===e||void 0===t){const n=state.map.getCenter();e=n.lng,t=n.lat}const n=document.getElementById("save-memory-modal");n&&n.remove();const a=document.createElement("div");a.id="save-memory-modal",a.className="modal",a.innerHTML=`\n        <div class="modal-overlay" onclick="closeSaveMemoryModal()"></div>\n        <div class="modal-content save-memory-modal-content">\n            <button class="close-btn" onclick="closeSaveMemoryModal()">&times;</button>\n            <h2>üìç Save Memory</h2>\n            <p class="memory-coords">Location: ${t.toFixed(5)}, ${e.toFixed(5)}</p>\n\n            <div class="form-group">\n                <label for="memory-note">Note (optional)</label>\n                <textarea id="memory-note" rows="3" placeholder="What makes this place special?"></textarea>\n            </div>\n\n            <div class="form-group">\n                <label>Category</label>\n                <div class="memory-category-grid">\n                    ${Object.entries(MEMORY_CATEGORIES).map((([e,t])=>`\n                        <label class="memory-category-option">\n                            <input type="radio" name="memory-category" value="${e}" ${"visited"===e?"checked":""}>\n                            <span class="category-label" style="border-color: ${t.color}">\n                                ${t.icon} ${t.name}\n                            </span>\n                        </label>\n                    `)).join("")}\n                </div>\n            </div>\n\n            <div class="modal-actions">\n                <button class="btn btn-secondary" onclick="closeSaveMemoryModal()">Cancel</button>\n                <button class="btn btn-primary" onclick="saveMemory(${e}, ${t})">Save Memory</button>\n            </div>\n        </div>\n    `,document.body.appendChild(a),setTimeout((()=>document.getElementById("memory-note")?.focus()),100)}function closeSaveMemoryModal(){const e=document.getElementById("save-memory-modal");e&&e.remove()}async function saveMemory(e,t){const n=getUserHash(),a=document.getElementById("memory-note")?.value||"",o=document.querySelector('input[name="memory-category"]:checked')?.value||"general";try{const s=await fetch(`${API_BASE}/memories/save?lat=${t}&lng=${e}&user_hash=${encodeURIComponent(n)}&category=${o}`+(a?`&note=${encodeURIComponent(a)}`:""),{method:"POST"});if(s.ok){await s.json();showToast("Memory saved! üìç","success"),closeSaveMemoryModal(),await loadMemories(),state.memories.active||toggleMemoriesPanel()}else showToast("Failed to save memory","error")}catch(e){console.error("Error saving memory:",e),showToast("Error saving memory","error")}}window.toggleMemoriesPanel=toggleMemoriesPanel,window.collapseMemoriesPanel=collapseMemoriesPanel,window.openMemoriesPanel=openMemoriesPanel,window.loadMemories=loadMemories,window.flyToMemory=flyToMemory,window.openSaveMemoryDialog=openSaveMemoryDialog,window.closeSaveMemoryModal=closeSaveMemoryModal,window.saveMemory=saveMemory;const voiceState={speaking:!1,currentUtterance:null,instructionQueue:[],currentIndex:0,synthesis:window.speechSynthesis};function isTTSSupported(){return"speechSynthesis"in window}async function getThemedInstruction(e,t){try{const n=await fetch(`${API_BASE}/navigation/instruction?instruction=${encodeURIComponent(e)}&style=${t}`);if(n.ok){return(await n.json()).themed_instruction||e}}catch(e){console.error("Error getting themed instruction:",e)}return e}function speak(e,t){if(!isTTSSupported())return void showToast("Voice navigation not supported in this browser","warning");voiceState.synthesis.cancel();const n=new SpeechSynthesisUtterance(e);n.rate=1,n.pitch=1,n.volume=1;const a=voiceState.synthesis.getVoices(),o=a.find((e=>e.lang.startsWith("en")&&(e.name.includes("Google")||e.name.includes("Microsoft")||e.name.includes("Samantha"))))||a.find((e=>e.lang.startsWith("en")));o&&(n.voice=o),n.onend=()=>{voiceState.speaking=!1,t&&t()},n.onerror=e=>{console.error("Speech error:",e),voiceState.speaking=!1},voiceState.speaking=!0,voiceState.currentUtterance=n,voiceState.synthesis.speak(n)}async function playDirections(){if(!isTTSSupported())return void showToast("Voice navigation not supported in this browser","warning");const e=document.querySelectorAll(".route-step");if(0===e.length)return void showToast("Calculate a route first","info");const t=document.getElementById("voice-style")?.value||"default";voiceState.instructionQueue=[];for(const n of e){const e=n.querySelector(".step-instruction")?.textContent||n.textContent;if(e){const n=await getThemedInstruction(e.trim(),t);voiceState.instructionQueue.push(n)}}0!==voiceState.instructionQueue.length?(document.getElementById("btn-play-directions")?.classList.add("hidden"),document.getElementById("btn-stop-directions")?.classList.remove("hidden"),voiceState.currentIndex=0,speakNextInstruction()):showToast("No directions to play","info")}function speakNextInstruction(){if(voiceState.currentIndex>=voiceState.instructionQueue.length)return stopDirections(),void showToast("Directions complete!","success");const e=voiceState.instructionQueue[voiceState.currentIndex];document.querySelectorAll(".route-step").forEach(((e,t)=>{e.classList.toggle("speaking",t===voiceState.currentIndex)})),speak(e,(()=>{voiceState.currentIndex++,setTimeout(speakNextInstruction,500)}))}function stopDirections(){voiceState.synthesis.cancel(),voiceState.speaking=!1,voiceState.instructionQueue=[],voiceState.currentIndex=0,document.getElementById("btn-play-directions")?.classList.remove("hidden"),document.getElementById("btn-stop-directions")?.classList.add("hidden"),document.querySelectorAll(".route-step").forEach((e=>{e.classList.remove("speaking")}))}async function speakInstruction(e){const t=document.getElementById("voice-style")?.value||"default";speak(await getThemedInstruction(e,t))}function initLeaderboard(){const e=document.querySelector(".header-right"),t=document.createElement("button");t.id="btn-leaderboard",t.className="btn btn-icon",t.title="Leaderboard & Profile",t.innerHTML="<span>üèÜ</span>",e.insertBefore(t,e.firstChild),t.addEventListener("click",toggleLeaderboardPanel),createLeaderboardPanel()}function createLeaderboardPanel(){const e=document.getElementById("map-container"),t=document.createElement("div");t.id="leaderboard-panel",t.className="leaderboard-panel hidden draggable",t.innerHTML='\n        <div class="leaderboard-header panel-drag-handle">\n            <h3><span class="drag-icon">‚ãÆ‚ãÆ</span> üèÜ Leaderboard</h3>\n            <button class="panel-close-btn" onclick="toggleLeaderboardPanel()">&times;</button>\n        </div>\n        <div class="leaderboard-content">\n            <div class="leaderboard-tabs">\n                <button class="lb-tab active" data-tab="leaderboard" onclick="switchLeaderboardTab(\'leaderboard\')">Top Contributors</button>\n                <button class="lb-tab" data-tab="profile" onclick="switchLeaderboardTab(\'profile\')">My Profile</button>\n            </div>\n            <div id="leaderboard-list" class="leaderboard-list">\n                <p class="leaderboard-loading">Loading leaderboard...</p>\n            </div>\n            <div id="profile-view" class="profile-view hidden">\n                <p class="profile-loading">Loading profile...</p>\n            </div>\n            <p class="tagme-notice">\n                <small>Earn points via the <strong>TagMe</strong> app</small>\n            </p>\n        </div>\n    ',e.appendChild(t);const n=t.querySelector(".leaderboard-header");makePanelDraggable(t,n,"leaderboardPanelPosition")}function toggleLeaderboardPanel(){document.getElementById("leaderboard-panel").classList.toggle("hidden")||loadLeaderboard()}function switchLeaderboardTab(e){document.querySelectorAll(".lb-tab").forEach((e=>e.classList.remove("active"))),document.querySelector(`.lb-tab[data-tab="${e}"]`)?.classList.add("active");const t=document.getElementById("leaderboard-list"),n=document.getElementById("profile-view");"leaderboard"===e?(t.classList.remove("hidden"),n.classList.add("hidden"),loadLeaderboard()):(t.classList.add("hidden"),n.classList.remove("hidden"),loadUserProfile())}async function loadLeaderboard(){const e=document.getElementById("leaderboard-list");e.innerHTML='<p class="leaderboard-loading">Loading leaderboard...</p>';try{const t=await fetch(`${API_BASE}/leaderboard?limit=20`);if(!t.ok)return void(e.innerHTML='<p class="leaderboard-error">Could not load leaderboard</p>');const n=(await t.json()).leaders||[];if(0===n.length)return void(e.innerHTML='<p class="no-leaders">No contributors yet. Be the first!</p>');const a=["üå±","üß≠","üó∫Ô∏è","‚öîÔ∏è","üèÜ","üëë"];e.innerHTML=n.map(((e,t)=>{const n=t+1;return`\n                <div class="leader-item ${n<=3?`rank-${n}`:""}">\n                    <span class="leader-rank">${1===n?"ü•á":2===n?"ü•à":3===n?"ü•â":`#${n}`}</span>\n                    <div class="leader-info">\n                        <span class="leader-badge">${a[Math.min(e.level-1,5)]||"üå±"}</span>\n                        <span class="leader-name">Contributor ${e.device_id_hash?.slice(0,6)||"Anon"}</span>\n                    </div>\n                    <div class="leader-stats">\n                        <span class="leader-points">${e.total_points.toLocaleString()} pts</span>\n                        <span class="leader-level">Lvl ${e.level}</span>\n                    </div>\n                </div>\n            `})).join("")}catch(t){console.error("Failed to load leaderboard:",t),e.innerHTML='<p class="leaderboard-error">Could not load leaderboard</p>'}}async function loadUserProfile(){const e=document.getElementById("profile-view");e.innerHTML='<p class="profile-loading">Loading your profile...</p>';const t=getUserHash();try{const n=await fetch(`${API_BASE}/user/profile?device_hash=${encodeURIComponent(t)}`);if(!n.ok)return void(e.innerHTML='<p class="profile-error">Could not load profile</p>');const a=await n.json();e.innerHTML=`\n            <div class="profile-card">\n                <div class="profile-level">\n                    <span class="level-badge">${a.level_badge}</span>\n                    <div class="level-info">\n                        <span class="level-name">${a.level_name}</span>\n                        <span class="level-number">Level ${a.level}</span>\n                    </div>\n                </div>\n                <div class="profile-points">\n                    <span class="points-value">${a.total_points.toLocaleString()}</span>\n                    <span class="points-label">Total Points</span>\n                </div>\n                <div class="profile-stats-grid">\n                    <div class="profile-stat">\n                        <span class="stat-icon">üìç</span>\n                        <span class="stat-value">${a.reports_submitted}</span>\n                        <span class="stat-label">Reports</span>\n                    </div>\n                    <div class="profile-stat">\n                        <span class="stat-icon">‚úì</span>\n                        <span class="stat-value">${a.reports_verified}</span>\n                        <span class="stat-label">Verified</span>\n                    </div>\n                    <div class="profile-stat">\n                        <span class="stat-icon">‚≠ê</span>\n                        <span class="stat-value">${a.reviews_submitted}</span>\n                        <span class="stat-label">Reviews</span>\n                    </div>\n                    <div class="profile-stat">\n                        <span class="stat-icon">üöó</span>\n                        <span class="stat-value">${a.km_driven}</span>\n                        <span class="stat-label">km Driven</span>\n                    </div>\n                </div>\n            </div>\n        `}catch(t){console.error("Failed to load profile:",t),e.innerHTML='<p class="profile-error">Could not load profile</p>'}}isTTSSupported()&&0===voiceState.synthesis.getVoices().length&&voiceState.synthesis.addEventListener("voiceschanged",(()=>{console.log("TTS voices loaded:",voiceState.synthesis.getVoices().length)})),window.playDirections=playDirections,window.stopDirections=stopDirections,window.speakInstruction=speakInstruction,window.toggleLeaderboardPanel=toggleLeaderboardPanel,window.switchLeaderboardTab=switchLeaderboardTab;