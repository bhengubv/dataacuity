# Automated Security Updates Workflow
# Runs daily to check for and apply security patches to React and other critical dependencies

name: Security Updates

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even for non-security patches'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    outputs:
      has_vulnerabilities: ${{ steps.audit.outputs.has_vulnerabilities }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          if pnpm audit --audit-level=high 2>&1 | tee audit-results.txt; then
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No high or critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Vulnerabilities detected - see details below" >> $GITHUB_STEP_SUMMARY
            cat audit-results.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check React versions
        run: |
          echo "## React Package Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pnpm list react react-dom react-router @react-router/dev 2>/dev/null || true >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for vulnerable React Server DOM packages
        run: |
          echo "## React Server Components Check" >> $GITHUB_STEP_SUMMARY
          # Check for vulnerable versions of react-server-dom-*
          VULNERABLE_VERSIONS="19.0.0|19.1.0|19.1.1|19.2.0"
          if pnpm list react-server-dom-webpack react-server-dom-parcel react-server-dom-turbopack 2>/dev/null | grep -E "$VULNERABLE_VERSIONS"; then
            echo "WARNING: Vulnerable React Server DOM packages detected!" >> $GITHUB_STEP_SUMMARY
            echo "Please update to 19.0.1, 19.1.2, or 19.2.1+" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No vulnerable React Server DOM packages found" >> $GITHUB_STEP_SUMMARY
          fi

  update-dependencies:
    name: Update Security Patches
    needs: audit
    if: needs.audit.outputs.has_vulnerabilities == 'true' || github.event.inputs.force_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Apply security updates
        run: |
          # Update packages with known vulnerabilities
          pnpm update --latest \
            react \
            react-dom \
            react-router \
            @react-router/dev \
            @react-router/node \
            @react-router/serve \
            next \
            || true

          # Run audit fix
          pnpm audit --fix || true

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'security: apply automated security patches'
          title: 'Security: Automated dependency security updates'
          body: |
            ## Automated Security Update

            This PR was automatically created by the security-updates workflow.

            ### Changes
            - Updated React ecosystem packages to latest secure versions
            - Applied `pnpm audit --fix` to resolve known vulnerabilities

            ### Verification
            - [ ] Review the updated package versions
            - [ ] Run tests locally: `pnpm test`
            - [ ] Verify the application works correctly

            ### Related CVEs
            - CVE-2025-55182 (React2Shell) - React Server Components RCE
            - CVE-2025-55183 - Source Code Exposure
            - CVE-2025-55184 - Denial of Service
            - CVE-2025-67779 - Additional DoS vector

            ---
            *This PR was automatically generated by the security-updates workflow*
          branch: security/automated-updates
          labels: |
            security
            dependencies
            automated
          delete-branch: true

  notify:
    name: Notify on Critical Vulnerabilities
    needs: audit
    if: needs.audit.outputs.has_vulnerabilities == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue for Critical Vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Security Alert: Vulnerabilities detected in dependencies';
            const body = `
            ## Security Vulnerabilities Detected

            The automated security scan has detected vulnerabilities in the project dependencies.

            **Action Required:**
            1. Review the [Security Updates workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            2. Check the automatically created PR for security patches
            3. Manually update any packages that couldn't be automatically patched

            **Priority Packages to Check:**
            - \`react\` / \`react-dom\`
            - \`react-router\` / \`@react-router/*\`
            - \`react-server-dom-*\`
            - \`next\` / \`@next/*\`

            ---
            *This issue was automatically created by the security-updates workflow*
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated', 'high-priority']
              });
            }
