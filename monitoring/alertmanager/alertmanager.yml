global:
  # How often to check for resolved alerts
  resolve_timeout: 5m

  # SMTP configuration for email alerts
  smtp_smarthost: 'mail.thegeek.co.za:587'
  smtp_from: 'social@thegeek.co.za'
  smtp_auth_username: 'social@thegeek.co.za'
  smtp_auth_password: '!&sH863b.ZQZK2@!&sH863b.ZQZK2@'
  smtp_require_tls: true

# Templates for alert notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route alerts to receivers
route:
  # Default receiver for all alerts
  receiver: 'email-notifications'

  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']

  # How long to wait before sending notification for new group
  group_wait: 10s

  # How long to wait before sending notification about new alerts added to group
  group_interval: 10s

  # How long to wait before re-sending notification
  repeat_interval: 3h

  # Routes for specific alert types
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'email-critical'
      group_wait: 0s
      repeat_interval: 1h

    # Warning alerts - standard notification
    - match:
        severity: warning
      receiver: 'email-notifications'
      repeat_interval: 6h

    # Info alerts - daily digest
    - match:
        severity: info
      receiver: 'email-notifications'
      repeat_interval: 24h

# Alert receivers (notification channels)
receivers:
  # Default email notifications
  - name: 'email-notifications'
    email_configs:
      - to: 'tbengu@thegeek.co.za'
        headers:
          Subject: '[DataAcuity Alert] {{ .GroupLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; }
              .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
              .critical { background-color: #ffebee; border-left: 5px solid #f44336; }
              .warning { background-color: #fff3e0; border-left: 5px solid #ff9800; }
              .info { background-color: #e3f2fd; border-left: 5px solid #2196f3; }
              .resolved { background-color: #e8f5e9; border-left: 5px solid #4caf50; }
              h2 { margin-top: 0; }
              .details { margin-top: 10px; }
              .label { font-weight: bold; }
            </style>
          </head>
          <body>
            <h1>DataAcuity Monitoring Alert</h1>
            {{ range .Alerts }}
            <div class="alert {{ .Labels.severity }}">
              <h2>{{ .Labels.alertname }}</h2>
              <div class="details">
                <p><span class="label">Severity:</span> {{ .Labels.severity }}</p>
                <p><span class="label">Status:</span> {{ .Status }}</p>
                <p><span class="label">Description:</span> {{ .Annotations.description }}</p>
                <p><span class="label">Summary:</span> {{ .Annotations.summary }}</p>
                {{ if .Labels.instance }}
                <p><span class="label">Instance:</span> {{ .Labels.instance }}</p>
                {{ end }}
                {{ if .Labels.job }}
                <p><span class="label">Job:</span> {{ .Labels.job }}</p>
                {{ end }}
                <p><span class="label">Started:</span> {{ .StartsAt }}</p>
                {{ if .EndsAt }}
                <p><span class="label">Ended:</span> {{ .EndsAt }}</p>
                {{ end }}
              </div>
            </div>
            {{ end }}
            <hr>
            <p><small>This alert was generated by the DataAcuity monitoring system.</small></p>
          </body>
          </html>

  # Critical alerts (same email but different subject)
  - name: 'email-critical'
    email_configs:
      - to: 'tbengu@thegeek.co.za'
        headers:
          Subject: 'üö® [CRITICAL] {{ .GroupLabels.alertname }} - DataAcuity'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; }
              .critical-banner { background-color: #f44336; color: white; padding: 20px; text-align: center; }
              .alert { padding: 15px; margin: 10px 0; border-radius: 5px; background-color: #ffebee; }
              h2 { margin-top: 0; color: #c62828; }
              .details { margin-top: 10px; }
              .label { font-weight: bold; }
            </style>
          </head>
          <body>
            <div class="critical-banner">
              <h1>‚ö†Ô∏è CRITICAL ALERT ‚ö†Ô∏è</h1>
            </div>
            {{ range .Alerts }}
            <div class="alert">
              <h2>{{ .Labels.alertname }}</h2>
              <div class="details">
                <p><span class="label">Description:</span> {{ .Annotations.description }}</p>
                <p><span class="label">Summary:</span> {{ .Annotations.summary }}</p>
                {{ if .Labels.instance }}
                <p><span class="label">Instance:</span> {{ .Labels.instance }}</p>
                {{ end }}
                <p><span class="label">Started:</span> {{ .StartsAt }}</p>
              </div>
            </div>
            {{ end }}
            <hr>
            <p><strong>Immediate action required!</strong></p>
            <p>Access monitoring dashboard: <a href="http://localhost:5015">Grafana</a></p>
          </body>
          </html>

# Inhibition rules (prevent certain alerts when others are firing)
inhibit_rules:
  # If a service is down, don't alert about its high response time
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
