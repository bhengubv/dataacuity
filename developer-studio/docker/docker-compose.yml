# Data Acuity Developer Studio
# Full browser IDE with React Native / Expo toolchain

services:
  # =========================================================================
  # DEVELOPER IDE (Code-Server based)
  # =========================================================================
  # Each user gets their own container instance
  # In production, use container orchestration (K8s) for per-user isolation

  developer-ide:
    build:
      context: .
      dockerfile: Dockerfile.ide
    container_name: developer-studio-ide
    restart: unless-stopped
    environment:
      # Code-server config
      - PASSWORD=${IDE_PASSWORD:-}  # Empty = no password (use auth proxy in prod)

      # Expo configuration
      - EXPO_DEVTOOLS_LISTEN_ADDRESS=0.0.0.0
      - REACT_NATIVE_PACKAGER_HOSTNAME=${HOST_IP:-localhost}

      # Data Acuity API configuration
      - DATAACUITY_API_URL=https://api.dataacuity.co.za
      - DATAACUITY_APP_ID=${APP_ID:-developer-studio}
      - DATAACUITY_APP_SECRET=${APP_SECRET:-}
    ports:
      # IDE web interface
      - "8443:8080"
      # Expo dev server
      - "19000:19000"
      - "19001:19001"
      - "19002:19002"
    volumes:
      # Persist user workspace
      - developer_workspace:/home/coder/workspace
      # Persist VS Code settings and extensions
      - developer_vscode:/home/coder/.local/share/code-server
      # Persist npm cache
      - developer_npm:/home/coder/.npm
    networks:
      - dataacuity_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.developer-studio.rule=Host(`studio.dataacuity.co.za`)"
      - "traefik.http.routers.developer-studio.entrypoints=websecure"
      - "traefik.http.routers.developer-studio.tls.certresolver=letsencrypt"
      - "traefik.http.services.developer-studio.loadbalancer.server.port=8080"

  # =========================================================================
  # BUILD SERVER
  # =========================================================================
  # Handles APK/IPA builds for app submission

  build-server:
    image: node:20-bullseye
    container_name: developer-studio-builder
    restart: unless-stopped
    environment:
      - ANDROID_HOME=/opt/android-sdk
      - BUILD_OUTPUT_DIR=/builds
      - SLEPTON_API_URL=${SLEPTON_API_URL:-https://slepton.co.za/api}
      - SLEPTON_API_KEY=${SLEPTON_API_KEY:-}
    volumes:
      - developer_workspace:/workspace:ro
      - build_output:/builds
      - android_sdk:/opt/android-sdk
    working_dir: /app
    command: >
      sh -c "
        npm install -g eas-cli expo-cli &&
        echo 'Build server ready' &&
        tail -f /dev/null
      "
    networks:
      - dataacuity_network

  # =========================================================================
  # PROJECT STORAGE API
  # =========================================================================
  # Handles saving/loading user projects

  project-api:
    image: node:20-alpine
    container_name: developer-studio-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://gateway:${GATEWAY_DB_PASSWORD:-gateway_secret}@gateway-db:5432/developer_studio
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - STORAGE_PATH=/projects
    volumes:
      - project_storage:/projects
    ports:
      - "3100:3000"
    networks:
      - dataacuity_network
    command: >
      sh -c "
        echo 'Project API placeholder - implement with Express/Fastify' &&
        tail -f /dev/null
      "

networks:
  dataacuity_network:
    external: true

volumes:
  developer_workspace:
    name: developer_studio_workspace
  developer_vscode:
    name: developer_studio_vscode
  developer_npm:
    name: developer_studio_npm
  build_output:
    name: developer_studio_builds
  android_sdk:
    name: developer_studio_android_sdk
  project_storage:
    name: developer_studio_projects
